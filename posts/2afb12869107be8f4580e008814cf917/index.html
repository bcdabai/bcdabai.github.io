<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>八. 实战：CUDA-BEVFusion部署分析-导出带有spconv的SCN网络的onnx - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="八. 实战：CUDA-BEVFusion部署分析-导出带有spconv的SCN网络的onnx" />
<meta property="og:description" content="目录 前言0. 简述1. 使用spconv进行SCN的推理测试2. 导出onnx3. 补充-装饰器&#43;钩子函数总结下载链接参考 前言 自动驾驶之心推出的 《CUDA与TensorRT部署实战课程》，链接。记录下个人学习笔记，仅供自己参考
本次课程我们来学习下课程第八章——实战：CUDA-BEVFusion部署分析，一起来学习导出带有 spconv 的 SCN 网络的 onnx
Note：之前在学习杜老师的课程中有简单记录过 Sparse Convolution 的一些基础知识，感兴趣的可以看下：复杂onnx解决方案（以sparseconv为例）
课程大纲可以看下面的思维导图
0. 简述 本小节目标：学习利用 hook 截取 spconv 的 forward，从而自定义 onnx 算子导出 onnx 的方法
今天给大家讲解第八章第 3 小节，学习导出带有 spconv 的 SCN 网络的 onnx，这个小节我们先跟着 NVIDIA 官方提供的 3D Sparse Convolution 库，学习怎么去调用它，接口是什么样子
我们先假设 onnx 已经导出好了，读取导出好的 onnx 生成对应的 engine 引擎完成前向推理，我们先来完成这个流程，onnx 导出我们稍后再看
这部分 NVIVIDA 其实开源在 https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution，但值得注意的是它整个推理框架虽然是开源了，但比较核心的地方比如 spconv 里面是怎么加速的它其实并没有开源
我们主要是通过 NVIDIA 提供的方案一起去学习一下它的推理框架是怎么做的以及 spconv 的接口是如何去使用的，这是我们需要做的第一件事
第二件事就是我们需要学习 spconv 的 onnx 是怎么导出的，我们上节课也讲过 spconv 的 onnx 稍微有点特殊，因为我们需要用 hook 去截取 spconv 的 forward，之后重定位 spconv 的forward，接着去创建一个 onnx 自定义节点，通过这一系列的操作完成 spconv 的导出" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2afb12869107be8f4580e008814cf917/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-14T15:48:45+08:00" />
<meta property="article:modified_time" content="2024-01-14T15:48:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">八. 实战：CUDA-BEVFusion部署分析-导出带有spconv的SCN网络的onnx</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#0__14" rel="nofollow">0. 简述</a></li><li><a href="#1_spconvSCN_28" rel="nofollow">1. 使用spconv进行SCN的推理测试</a></li><li><a href="#2_onnx_398" rel="nofollow">2. 导出onnx</a></li><li><a href="#3__677" rel="nofollow">3. 补充-装饰器+钩子函数</a></li><li><a href="#_816" rel="nofollow">总结</a></li><li><a href="#_824" rel="nofollow">下载链接</a></li><li><a href="#_830" rel="nofollow">参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>前言</h3> 
<blockquote> 
 <p>自动驾驶之心推出的 《CUDA与TensorRT部署实战课程》，<a href="https://www.zdjszx.com/p/t_pc/goods_pc_detail/goods_detail/course_2Qzh2CekDJZMNuZq1Gfp3HOgIqx" rel="nofollow">链接</a>。记录下个人学习笔记，<strong>仅供自己参考</strong></p> 
 <p>本次课程我们来学习下课程第八章——实战：CUDA-BEVFusion部署分析，一起来学习导出带有 spconv 的 SCN 网络的 onnx</p> 
 <p><strong>Note</strong>：之前在学习杜老师的课程中有简单记录过 Sparse Convolution 的一些基础知识，感兴趣的可以看下：<a href="https://blog.csdn.net/qq_40672115/article/details/131480952">复杂onnx解决方案（以sparseconv为例）</a></p> 
 <p>课程大纲可以看下面的思维导图</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/2b/4a/kjVPHSEr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="0__14"></a>0. 简述</h3> 
<blockquote> 
 <p>本小节目标：<strong>学习利用 hook 截取 spconv 的 forward，从而自定义 onnx 算子导出 onnx 的方法</strong></p> 
</blockquote> 
<p>今天给大家讲解第八章第 3 小节，学习导出带有 spconv 的 SCN 网络的 onnx，这个小节我们先跟着 NVIDIA 官方提供的 3D Sparse Convolution 库，学习怎么去调用它，接口是什么样子</p> 
<p>我们先假设 onnx 已经导出好了，读取导出好的 onnx 生成对应的 engine 引擎完成前向推理，我们先来完成这个流程，onnx 导出我们稍后再看</p> 
<p>这部分 NVIVIDA 其实开源在 <a href="https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution">https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution</a>，但值得注意的是它整个推理框架虽然是开源了，但比较核心的地方比如 spconv 里面是怎么加速的它其实并没有开源</p> 
<p>我们主要是通过 NVIDIA 提供的方案一起去学习一下它的推理框架是怎么做的以及 spconv 的接口是如何去使用的，这是我们需要做的第一件事</p> 
<p>第二件事就是我们需要学习 spconv 的 onnx 是怎么导出的，我们上节课也讲过 spconv 的 onnx 稍微有点特殊，因为我们需要用 hook 去截取 spconv 的 forward，之后重定位 spconv 的forward，接着去创建一个 onnx 自定义节点，通过这一系列的操作完成 spconv 的导出</p> 
<h3><a id="1_spconvSCN_28"></a>1. 使用spconv进行SCN的推理测试</h3> 
<p>我们先来看一下 NVIDIA 官方提供的 3D Sparse Convolution 的 README 文档，它位于 LiDAR_AI_Soultion 项目下的 <strong>libraries/3DSparseConvolution</strong>，README 中提到 3DSparseConvolution 这个库提供了一个 int8/fp16 精度的 3D 稀疏卷积网络的推理引擎，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/bb/b7/0UbB19hn_o.png" alt="在这里插入图片描述"></p> 
<p>我们先来将它跑通，README 中提到该项目的运行过程包括以下三部分：</p> 
<ul><li><strong>1.</strong> 从 <a href="https://github.com/tianweiy/CenterPoint">https://github.com/tianweiy/CenterPoint</a> 下载并配置 CenterPoint 环境</li><li><strong>2.</strong> 导出 SCN ONNX</li><li><strong>3.</strong> 编译和运行</li></ul> 
<p>这里有个小技巧，那就是我们可以先暂时跳过 SCN ONNX 的导出，因为在下载 LiDAR_AI_Solution 这个 repo 时官方其实提供了导出好的 CenterPoint SCN 的 ONNX 供我们测试，具体位置在 <strong>3DSparseConvolution/workspace/centerpoint</strong> 文件夹下，因此我们可以跳过第一部分和第二部分，直接利用官方提供的导出好的 SCN ONNX 来编译运行看能否通过</p> 
<p>因此我们先假设这个 ONNX 导出好了，我们来直接读取这个 ONNX 看看它是怎么做前向推理的，指令如下：</p> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libprotobuf-dev<span class="token operator">=</span><span class="token number">3.6</span>.1*
$ <span class="token builtin class-name">cd</span> path/to/3DSparseConvolution
$ <span class="token function">make</span> fp16 <span class="token parameter variable">-j</span>
</code></pre> 
<p>该库依赖于 protobuf，因此你需要先安装 protobuf，关于 protobuf 库的安装博主在 <a href="https://blog.csdn.net/qq_40672115/article/details/135319174?spm=1001.2014.3001.5502">八. 实战：CUDA-BEVFusion部署分析-环境搭建</a> 中也提供了 apt 和源码两种安装方式，这边不再赘述。接着我们就可以直接执行 <strong>make</strong> 指令来编译了，输出如下图所示：</p> 
<p><img src="https://images2.imgbox.com/1d/59/Iv4xitkV_o.png" alt="在这里插入图片描述"></p> 
<p>我们简单看一下编译过程中它都做了些什么，从日志中我们可以看到它先做了一个 Parse node conv0 [Sparseconvolution]，把这个 Node 节点 Parse 完之后再做一个 add，也就是把 Parse 完之后的信息读取出来加入到 conv0 里面</p> 
<p>那 conv0 这个东西我们从这里面可以看到它其实是一个自定义的节点，它里面参数是 submanifold，也就是我们说的 3D Sparse Convolution 的一种形式，同样依此类推后面还有 conv1、conv2 等等，这一系列操作都是这么做的</p> 
<p>其次我们再来关注下其精度，从日志中可以看出输入输出部分是跑的 FP16 精度，而中间的 spconv 部分跑的是 INT8 精度，因此 SCN 整体推理框架的精度是 FP16+INT8</p> 
<p><img src="https://images2.imgbox.com/ed/27/4ut92t4d_o.png" alt="在这里插入图片描述"></p> 
<p>我们再来看看整个网络 forward 过程中 tensor 维度的变化，我们可以看到输入维度是 41x1440x1440，1440x1440 代表着 3D 点云经过体素化之后得到的一个坐标系，41 代表它的通道数</p> 
<p>我们可以看到它整个过程中其实就是不断的进行稀疏卷积，然后做 downsample 变成 720x720 之后再做一个稀疏卷积降维到 360x360 之后再通过稀疏卷积降维到 180x180。降到 180x180 之后我们再做一个 scatter，那这个操作就是将维度扩充到 1x128x2x180x180 的维度，之后再做 reshape，reshape 到 1x256x180x180 的 tensor，这个就是 SCN 网络最终输出 tensor 的一个维度了</p> 
<p>那 1x255x180x180 代表的意义是它生成的 BEV Grid 的大小是 180x180，每一个 Grid 上有 256 维的特征，那这 256 维的特征是从点云那边直接学习得到的，以上就是 SCN 网络 forward 的整个流程</p> 
<p>OK，下面我们来进代码看看内部是怎么实现的，我们先从 <strong>main.cpp</strong> 看起，代码入口如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cmd <span class="token operator">=</span> <span class="token string">"fp16"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> cmd <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  cudaStream_t stream <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token function">checkRuntime</span><span class="token punctuation">(</span><span class="token function">cudaStreamCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"memint8"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_memory_usage_test</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Int8<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"memfp16"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_memory_usage_test</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"int8"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_simple_run</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Int8<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"fp16"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_simple_run</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">checkRuntime</span><span class="token punctuation">(</span><span class="token function">cudaStreamDestroy</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当我们执行 <strong>make fp16 -j</strong> 编译运行时，代码首先会调用 <strong>do_memory_usage_test</strong> 函数来测试稀疏卷积操作的内存使用情况，接着我们会调用 <strong>do_simple_run</strong> 函数来执行稀疏卷积，我们重点来看下 <strong>do_simple_run</strong> 这个函数看它内部的稀疏卷积是怎么执行的，其代码实现如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">do_simple_run</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision precision<span class="token punctuation">,</span> cudaStream_t stream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  spconv<span class="token double-colon punctuation">::</span><span class="token function">set_verbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> task <span class="token operator">=</span> <span class="token function">load_task</span><span class="token punctuation">(</span><span class="token string">"centerpointZYX"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// auto task = load_task("bevfusionZYX", precision);</span>
  <span class="token comment">// auto task = load_task("bevfusionXYZ", precision);</span>

  task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_data</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>DataType<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span> task<span class="token punctuation">.</span>features<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        task<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>DataType<span class="token double-colon punctuation">::</span>Int32<span class="token punctuation">,</span> task<span class="token punctuation">.</span>indices<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        task<span class="token punctuation">.</span>grid_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">forward</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> out_features <span class="token operator">=</span> task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">features</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> grid_size <span class="token operator">=</span> task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">grid_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"🙌 Output.shape: %s\n"</span><span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">format_shape</span><span class="token punctuation">(</span>out_features<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  out_features<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>save_dense<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>engine<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">print_done</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>compare_cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先我们先做了一个 load_task 加载了一个 centerpointZYX 的任务，load_task 的代码实现如下：</p> 
<pre><code class="prism language-cpp">Task <span class="token function">load_task</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>Precision precision<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  Task task<span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"bevfusionXYZ"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    task<span class="token punctuation">.</span>engine <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token string">"bevfusion/bevfusion.scn.xyz.onnx"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>features <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.xyz.voxels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>indices <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.xyz.coors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>order <span class="token operator">=</span> IndiceOrder<span class="token double-colon punctuation">::</span>XYZ<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>save_dense <span class="token operator">=</span> <span class="token string">"bevfusion/output.xyz.dense"</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>compare_cmd <span class="token operator">=</span>
        <span class="token string">"python tool/compare.py workspace/bevfusion/infer.xyz.dense "</span>
        <span class="token string">"workspace/bevfusion/output.xyz.dense --detail"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"bevfusionZYX"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    task<span class="token punctuation">.</span>engine <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token string">"bevfusion/bevfusion.scn.zyx.onnx"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>features <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.zyx.voxels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>indices <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.zyx.coors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>order <span class="token operator">=</span> IndiceOrder<span class="token double-colon punctuation">::</span>ZYX<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>save_dense <span class="token operator">=</span> <span class="token string">"bevfusion/output.zyx.dense"</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>compare_cmd <span class="token operator">=</span>
        <span class="token string">"python tool/compare.py workspace/bevfusion/infer.zyx.dense "</span>
        <span class="token string">"workspace/bevfusion/output.zyx.dense --detail"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"centerpointZYX"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    task<span class="token punctuation">.</span>engine <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token string">"centerpoint/centerpoint.scn.PTQ.onnx"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>features <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"centerpoint/in_features.torch.fp16.tensor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>indices <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"centerpoint/in_indices_zyx.torch.int32.tensor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>order <span class="token operator">=</span> IndiceOrder<span class="token double-colon punctuation">::</span>ZYX<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>save_dense <span class="token operator">=</span> <span class="token string">"centerpoint/output.zyx.dense"</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>compare_cmd <span class="token operator">=</span>
        <span class="token string">"python tool/compare.py workspace/centerpoint/out_dense.torch.fp16.tensor "</span>
        <span class="token string">"workspace/centerpoint/output.zyx.dense "</span>
        <span class="token string">"--detail"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Assertf</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"Unsupport task name: %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> task<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于我们 name 等于 centerpointZYX，因此这里用它做了一系列初始化，先通过读取 onnx 创建了一个 engine，我们来看下它具体是怎么创建的，也就是 <strong>load_engine_from_onnx</strong> 具体是怎么做的，其代码如下：</p> 
<pre><code class="prism language-cpp">std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Engine<span class="token operator">&gt;</span> <span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> onnx_file<span class="token punctuation">,</span> Precision precision<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> stream<span class="token punctuation">,</span> <span class="token keyword">bool</span> mark_all_output<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    onnx<span class="token double-colon punctuation">::</span>ModelProto model<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>fstream <span class="token function">fin</span><span class="token punctuation">(</span>onnx_file<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary <span class="token operator">|</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>model<span class="token punctuation">.</span><span class="token function">ParseFromIstream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOGV</span><span class="token punctuation">(</span><span class="token string">"Parse onnx failed: %s"</span><span class="token punctuation">,</span> onnx_file<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> builder <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">create_engine_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> graph <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>ITensor<span class="token operator">*</span><span class="token operator">&gt;</span> tensor_map_by_name<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> graph<span class="token punctuation">.</span><span class="token function">input_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> name <span class="token operator">=</span> graph<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tensor_map_by_name<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_input</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>spconv<span class="token double-colon punctuation">::</span>ITensor<span class="token operator">*</span><span class="token operator">&gt;</span> collect_outputs<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> model<span class="token punctuation">.</span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">node_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span><span class="token operator">&amp;</span> node <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">node</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"SparseConvolution"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> weight <span class="token operator">=</span> <span class="token function">get_initializer_data</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> bias   <span class="token operator">=</span> <span class="token function">get_initializer_data</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> weight_dynamic_ranges_proto <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"weight_dynamic_ranges"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> weight_dynamic_ranges <span class="token operator">=</span> 
                std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>weight_dynamic_ranges_proto<span class="token punctuation">.</span><span class="token function">floats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_dynamic_ranges_proto<span class="token punctuation">.</span><span class="token function">floats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_sparse_conv</span><span class="token punctuation">(</span>
                node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> 
                weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> weight<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
                weight_dynamic_ranges<span class="token punctuation">,</span>
                bias<span class="token punctuation">.</span>data<span class="token punctuation">,</span> bias<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"activation"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"kernel_size"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"stride"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"padding"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"dilation"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input_dynamic_range"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"subm"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_bound"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"rulebook"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span>
                node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>mark_all_output<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                collect_outputs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Add"</span> <span class="token operator">||</span> node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"QuantAdd"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> a <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> b <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_add</span><span class="token punctuation">(</span>
                node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> 
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input0_dynamic_range"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input1_dynamic_range"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Relu"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_relu</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ScatterDense"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> input_spatial_shape <span class="token operator">=</span> <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input_spatial_shape"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> output_shape <span class="token operator">=</span> <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_shape"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> format <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"format"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_dense</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> format<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input_spatial_shape<span class="token punctuation">,</span> output_shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Reshape"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> dims <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"dims"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> <span class="token function">shape</span><span class="token punctuation">(</span>dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_reshape</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Transpose"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> dims <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"dims"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> <span class="token function">shape</span><span class="token punctuation">(</span>dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_transpose</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unsupport operator [%s]\b"</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> graph<span class="token punctuation">.</span><span class="token function">output_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> name <span class="token operator">=</span> graph<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collect_outputs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>tensor_map_by_name<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> collect_outputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        builder<span class="token operator">-&gt;</span><span class="token function">push_output</span><span class="token punctuation">(</span>collect_outputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> builder<span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span>precision<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们从名字也能看出来，它的功能是读取一个 onnx 生成一个 engine，从代码中能看出先利用 protobuf 的接口函数先解析 onnx 文件，接着创建了一个 builder，我们来看一下这个 builder 是一个什么类，其代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">EngineBuilder</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  Exported <span class="token keyword">virtual</span> ITensor<span class="token operator">*</span> <span class="token function">push_input</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_add</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> a<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> b<span class="token punctuation">,</span>
      <span class="token keyword">float</span> a_dynamic_range<span class="token punctuation">,</span>
      <span class="token keyword">float</span> b_dynamic_range<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">,</span>
      Precision precision<span class="token punctuation">,</span> Precision output_precision<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_relu</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_dense</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> format<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> input_spatial_shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> output_shape<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_reshape</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_transpose</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> dims<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_sparse_conv</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> weight<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> weight_shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> weight_dynamic_ranges<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> bias<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> bias_shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> activation<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> kernel_size<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> stride<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> padding<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> dilation<span class="token punctuation">,</span>
      <span class="token keyword">float</span> input_dynamic_range<span class="token punctuation">,</span>
      <span class="token keyword">bool</span> submanifold<span class="token punctuation">,</span>
      <span class="token keyword">int</span> max_output_points<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> rulebook<span class="token punctuation">,</span>
      Precision precision<span class="token punctuation">,</span>
      Precision output_precision<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">push_output</span><span class="token punctuation">(</span>ITensor<span class="token operator">*</span> value<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// build engine</span>
  Exported <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Engine<span class="token operator">&gt;</span> <span class="token function">build</span><span class="token punctuation">(</span>Precision precision<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> stream <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * To build a engine.
*/</span>
Exported std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>EngineBuilder<span class="token operator">&gt;</span> <span class="token function">create_engine_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们可以看到 builder 是一个 EngineBuilder 类，那这个名字其实和 TensorRT 里面的 IBuilder 比较像，但是这两个并不是一个东西，IBuilder 是 TensorRT 的概念，这个 EngineBuilder 是 NVIDIA 官方自己重新写的一个 builder，它没有集成任何东西是官方自己构建的一个 builder，那既然是 builder 我们就知道它肯定是用于来创建 engine 的</p> 
<p>OK，我们再回到 <strong>load_engine_from_onnx</strong> 函数中，创建完 builder 之后我们再拿到模型的 graph 图结构，然后我们会遍历 graph 中的所有 node，针对不同的 node 进行不同的操作，那这些 node 包括 SparseConvolution 也就是我们说的稀疏卷积，还有 Add、QuantAdd、Relu、ScatterDense 等等，</p> 
<p>如果 Node 节点是 SparseConvolution 稀疏卷积，我们会先通过 get_initializer_data 函数拿到它的 weights 和 bias 数据，接着通过 push_sparse_conv 函数把稀疏卷积的权重和偏置数据，对应的属性等等添加到 builder 中，那具体的 push_sparse_conv 内部是如何实现的其实我们并不知道，官方只提供了一个 engine.hpp 接口文件，那怎么实现的里面的 engine.cpp 或者 engine.cu 它其实并没有开源</p> 
<p>其实我们只要知道接口就知道怎么用了，那通过名字也知道 push_sparse_conv 也就是创建了一个 spconv 的节点，我们往这个节点里面放很多信息，比如名字、权重、动态范围等等各种属性，那这样就把 spconv 的一个节点创建了，那对于 onnx 中的每一个节点我们都可以先从 onnx 中 parse 信息，之后把信息 push 到 builder 中去，通过 builder 创建一个节点，那就是这么一个流程，后面的 add、relu、reshape 等节点都可以这么做</p> 
<p>所以 <strong>load_engine_from_onnx</strong> 函数执行完之后我们其实就得到了对应 onnx 的 engine 推理引擎了，那值得注意的是这个 engine 引擎它跟 TensorRT 的 engine 还不一样，这是它自己写的一个 engine</p> 
<p>OK，我们再回到 <strong>load_task</strong> 函数中，加载完 engine 之后，我们会 load 两个 Tensor 一个是 feature 也就是输入到网络中的 3D 点云特征，一个是 indices 也就是输入到网络中的 3D 点云的位置索引，其实也就是加载了 SCN 网络前向推理需要的两个输入 Tensor，接着设置了一些 grid_size、order 等参数</p> 
<p>OK，我们再回到 <strong>do_simple_run</strong> 函数中，通过 load_task 加载了 engine 之后我们通过 set_data 设置了输入的数据，接着调用 forward 进行了前向传播，代码如下所示：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
  Engine types for sparse convolution
**/</span>
<span class="token keyword">class</span> <span class="token class-name">Engine</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">/**
    Inference function for sparse convolution

    features_shape: The shape of the input feature matrix, it must be two elements.
    features_dtype: The data type of the input feature matrix, it must be Float16 now.
    features_data:  The data pointer of the input feature matrix
    indices_shape:  The shape of the input indices matrix, it must be two elements[n, 4]
    indices_dtype:  The data type of the input indices matrix, it must be Int32 now.
    indices_data:   The data pointer of the input indices matrix
    batch:          The batch size of the input, it must be 1 now.
    grid_size:      The grid size of the input data, For example: 41,1440,1440 or 1440,1440,41
    stream:         Which stream is expected to enqueue the inference.
  **/</span>
  Exported <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">forward</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> stream <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> size_t <span class="token function">num_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> SparseDTensor<span class="token operator">*</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> size_t <span class="token function">num_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> SparseDTensor<span class="token operator">*</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>那 forward 部分也是没有开源的，我们只知道它有这个接口，我们并不知道 forward 里面具体干了什么，但是我们可以猜一下，它里面的 forward 可能跟 TensorRT 里面的 forward 比较像，只是这里的 forward 是根据它自己创建的节点一个一个计算的，里面可能会涉及到一些 CUDA 加速计算，那我们这里就跟踪不了</p> 
<p>OK，forward 做完之后我们就得到了一个 1x256x180x180 的输出数据，那拿到它之后整个前向推理也就结束了，接着把输出的 1x256x180x180 的 features 保持下来，然后再做一个 reset，整个流程就是这样子</p> 
<p>那我们和大家一起简单的过了一遍整体流程，那如果说下次我们要使用它提供的这些接口的时候，其实这么分析就好了，这个是 C++ 部分的推理代码的一个解析</p> 
<p>我们最后来看一下精度比较，指令如下：</p> 
<pre><code class="prism language-shell">$ python tool/compare.py workspace/centerpoint/out_dense.torch.fp16.tensor workspace/centerpoint/output.zyx.dense <span class="token parameter variable">--detail</span>
</code></pre> 
<p>输出结果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/43/16/8jGqPWTS_o.png" alt="在这里插入图片描述"></p> 
<p>那它会对比 C++ 和 Pytorch 的推理结果，将两个 tensor 进行比较计算二者的差异，我们可以看到大部分数据都是一样的，也有少部分数据存在差异，但是都在误差范围之内，所以是可以忽略的</p> 
<h3><a id="2_onnx_398"></a>2. 导出onnx</h3> 
<p>接下来我们主要看这个 onnx 是怎么导出的，NVIDIA 官方其实开源了相关的导出代码，具体是在 <a href="https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution/tool/centerpoint-export">3DSparseConvolution/tool/centerpoint-export</a> 文件夹下</p> 
<p>其中 <strong>export_tool.py</strong> 是核心文件，我们一起来看下其具体的实现，代码如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">register_node</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

    fnnames   <span class="token operator">=</span> fn<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>
    fn_module <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>fnnames<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fn_name   <span class="token operator">=</span> fnnames<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    oldfn <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">make_hook</span><span class="token punctuation">(</span>bind_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

        ilayer <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">def</span> <span class="token function">internal_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">global</span> enable_trace

            <span class="token keyword">if</span> <span class="token keyword">not</span> enable_trace<span class="token punctuation">:</span>
                <span class="token keyword">return</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>

            <span class="token keyword">global</span> avoid_reuse_container
            <span class="token keyword">nonlocal</span> ilayer

            <span class="token comment"># Use the enable_trace flag to avoid internal trace calls</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">False</span>
            y <span class="token operator">=</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            bind_fn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">True</span>

            avoid_reuse_container<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> 
            ilayer <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">return</span> y

        <span class="token builtin">setattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">,</span> internal_forward<span class="token punctuation">)</span>
    <span class="token keyword">return</span> make_hook

<span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"spconv.conv.SparseConvolution.forward"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_sparse_convolution</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; SparseConvolution</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'subm'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm <span class="token keyword">else</span> <span class="token string">'conv'</span><span class="token punctuation">}</span></span><span class="token string">] -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_deconv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_padding
        <span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_conv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation
        <span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">:</span>
        output_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    output_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels
    inputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.weight"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        inputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.bias"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    act_type_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>ReLU      <span class="token punctuation">:</span> <span class="token string">"ReLU"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>None_     <span class="token punctuation">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>Sigmoid   <span class="token punctuation">:</span> <span class="token string">"Sigmoid"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>LeakyReLU <span class="token punctuation">:</span> <span class="token string">"LeakyReLU"</span>
    <span class="token punctuation">}</span>

    algo_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        ConvAlgo<span class="token punctuation">.</span>MaskImplicitGemm      <span class="token punctuation">:</span> <span class="token string">"MaskImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>MaskSplitImplicitGemm <span class="token punctuation">:</span> <span class="token string">"MaskSplitImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>Native <span class="token punctuation">:</span> <span class="token string">"Native"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    output_bound <span class="token operator">=</span> <span class="token number">200000</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"output_bound"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        output_bound <span class="token operator">=</span> self<span class="token punctuation">.</span>output_bound

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"SparseConvolution"</span><span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"conv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> 
            ndim <span class="token operator">=</span> self<span class="token punctuation">.</span>ndim<span class="token punctuation">,</span>
            input_spatial_shape <span class="token operator">=</span> x<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            output_spatial_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            in_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span>
            out_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span>
            kernel_size <span class="token operator">=</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span>
            output_bound <span class="token operator">=</span> output_bound<span class="token punctuation">,</span>
            stride <span class="token operator">=</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span>
            dilation <span class="token operator">=</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span>
            padding <span class="token operator">=</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
            transposed <span class="token operator">=</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">,</span>
            inverse <span class="token operator">=</span> self<span class="token punctuation">.</span>inverse<span class="token punctuation">,</span>
            output_padding <span class="token operator">=</span> self<span class="token punctuation">.</span>output_padding<span class="token punctuation">,</span>
            groups <span class="token operator">=</span> self<span class="token punctuation">.</span>groups<span class="token punctuation">,</span>
            subm <span class="token operator">=</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">,</span>
            rulebook <span class="token operator">=</span> self<span class="token punctuation">.</span>indice_key<span class="token punctuation">,</span>
            activation <span class="token operator">=</span> act_type_name<span class="token punctuation">[</span>self<span class="token punctuation">.</span>act_type<span class="token punctuation">]</span><span class="token punctuation">,</span>
            input_shape  <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
            output_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>它这里写了一个 register_node 的 hook 函数，之后写了一个 symbolic_sparse_convolution 就是各种 symbolic 符号函数，当我们程序在 forward 时候会进行重定位</p> 
<p>我们都知道要将 pytorch 模型导出 onnx 的话，我们是需要让这个 pytorch 模型完整走一遍 forward 过程的，因为 forward 的过程中我们才能 trace 里面的各个节点。我们知道如果做 Sparse Convolution 的 forward 的时候，它里面有很多东西我们是 trace 不了的，那么该怎么办呢，我们可以截取，可以做一个 hook，当 trace 到 Sparse Convolution forward 的时候我们让它去执行 symbolic_sparse_convolution 函数里面的操作</p> 
<p>在函数里面我们得到 output_size，得到 input 数据，再得到 activation 数据，然后让它去调用 helper.make_node 函数创建一个 node 节点，那我们可以看到这里面有很多参数，那这些参数其实就是 SparseConvolution 它在 C++ 里做前向推理的时候所需要的数据</p> 
<p>那我们把这些参数通过 make_node 形式保存下来，以 node 的形式给它添加到 onnx 里面去，那这个就是 spconv 重定位的 forward 的一个实现，那它可以通过这么一个 hook 函数完成这点</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"torch.nn.ReLU.forward"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_relu</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; ReLU</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string"> -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"Relu"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"relu</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"torch.Tensor.__add__"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Add</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string"> -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> + </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"Add"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> get_tensor_id<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"add</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>同理，如果说 Sparse Convolution 的 forward 我们可以截取，那么是不是其它的节点我们也可以截取呢，那我们可以看到它还把 relu 的 forwad 进行了截取让它重定位到 symbolic_relu 里面去，接着也是通过 helper 去创建了一个 node，那后面的都是通过这种方式来创建的一个自定义的节点</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">export_onnx</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> voxels<span class="token punctuation">,</span> coors<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> spatial_shape<span class="token punctuation">,</span> save_onnx<span class="token punctuation">,</span> save_tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">global</span> avoid_reuse_container<span class="token punctuation">,</span> tensor_map<span class="token punctuation">,</span> nodes<span class="token punctuation">,</span> initializers<span class="token punctuation">,</span> enable_trace
    avoid_reuse_container <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    tensor_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    initializers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Tracing model inference..."</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&gt; Do inference..."</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        register_tensor<span class="token punctuation">(</span>voxels<span class="token punctuation">)</span>
        enable_trace <span class="token operator">=</span> <span class="token boolean">True</span>
        y <span class="token operator">=</span> model<span class="token punctuation">(</span>voxels<span class="token punctuation">,</span> coors<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> spatial_shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        enable_trace <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword">if</span> save_tensor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&gt; Do save tensor, The purpose of this operation is to verify the inference result of C++"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save inference input voxels to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.voxels, voxels.shape = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>voxels<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span>voxels<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.voxels"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save inference input coors to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.coors, coors.shape = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>coors<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span>coors<span class="token punctuation">,</span>  <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.coors"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save inference output to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.output, output.shape = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span>y<span class="token punctuation">,</span>      <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.output"</span></span><span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save spatial_shape is </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>spatial_shape<span class="token punctuation">}</span></span><span class="token string">, batch size is </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_size<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save spatial_shape and batch size to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.info"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>batch_size<span class="token punctuation">]</span> <span class="token operator">+</span> spatial_shape<span class="token punctuation">,</span>      <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.info"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Tracing done!"</span><span class="token punctuation">)</span>

    inputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        helper<span class="token punctuation">.</span>make_value_info<span class="token punctuation">(</span>
            name<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">,</span>
            type_proto<span class="token operator">=</span>helper<span class="token punctuation">.</span>make_tensor_type_proto<span class="token punctuation">(</span>
                elem_type<span class="token operator">=</span>helper<span class="token punctuation">.</span>TensorProto<span class="token punctuation">.</span>DataType<span class="token punctuation">.</span>FLOAT16<span class="token punctuation">,</span>
                shape<span class="token operator">=</span>voxels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    outputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        helper<span class="token punctuation">.</span>make_value_info<span class="token punctuation">(</span>
            name<span class="token operator">=</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span>
            type_proto<span class="token operator">=</span>helper<span class="token punctuation">.</span>make_tensor_type_proto<span class="token punctuation">(</span>
                elem_type<span class="token operator">=</span>helper<span class="token punctuation">.</span>TensorProto<span class="token punctuation">.</span>DataType<span class="token punctuation">.</span>FLOAT16<span class="token punctuation">,</span>
                shape<span class="token operator">=</span>y<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    graph <span class="token operator">=</span> helper<span class="token punctuation">.</span>make_graph<span class="token punctuation">(</span>
        name<span class="token operator">=</span><span class="token string">"scn"</span><span class="token punctuation">,</span>
        inputs<span class="token operator">=</span>inputs<span class="token punctuation">,</span>
        outputs<span class="token operator">=</span>outputs<span class="token punctuation">,</span>
        nodes<span class="token operator">=</span>nodes<span class="token punctuation">,</span>
        initializer<span class="token operator">=</span>initializers
    <span class="token punctuation">)</span>

    opset <span class="token operator">=</span> <span class="token punctuation">[</span>
        helper<span class="token punctuation">.</span>make_operatorsetid<span class="token punctuation">(</span><span class="token string">"ai.onnx"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    model <span class="token operator">=</span> helper<span class="token punctuation">.</span>make_model<span class="token punctuation">(</span>graph<span class="token punctuation">,</span> opset_imports<span class="token operator">=</span>opset<span class="token punctuation">,</span> producer_name<span class="token operator">=</span><span class="token string">"pytorch"</span><span class="token punctuation">,</span> producer_version<span class="token operator">=</span><span class="token string">"1.9"</span><span class="token punctuation">)</span>
    onnx<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span> save_onnx<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🚀 The export is completed. ONNX save as </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_onnx<span class="token punctuation">}</span></span><span class="token string"> 🤗, Have a nice day~"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># clean memory</span>
    avoid_reuse_container <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    tensor_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    initializers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<p>我们可以看到最后这些截取到的节点都给放到了 nodes 列表中，在 export_onnx 函数中我们可以看到它通过 helper 去创建了一个 input 一个 output 还创建了一个 graph，我们通过 graph 之后把输入输出以及整个网络中所涉及到的所有节点放在一起形成一个 graph，之后我们再通过 graph 创建一个 model，那最终通过 onnx 的 save_model 就可以把这个 onnx 模型给保存下来了</p> 
<p>OK，以上就是带有 spconv 的 SCN 网络导出的一个方式，这里面的重点主要是 register_node 装饰器以及 make_hook 钩子函数，这种语法大家可能平时看到的并不是很多，那这个需要大家自己多看多理解了，另外关于 Python 装饰器的内容大家感兴趣的可以看看：<a href="https://blog.csdn.net/qq_40672115/article/details/129914076">AutoCV第四课：Python基础</a></p> 
<p>这个就是 trace spconv 的一个方式，分析完代码之后我们现在想要导出对应 SCN 的 onnx 该怎么办呢，我们来看下 NVIDIA 官方提供的步骤，如下所示：</p> 
<p><strong>1.</strong> 从 <a href="https://github.com/tianweiy/CenterPoint">https://github.com/tianweiy/CenterPoint</a> 下载并配置 CenterPoint 的环境</p> 
<p><strong>2.</strong> 使用如下指令导出 SCN ONNX</p> 
<pre><code class="prism language-shell">$ <span class="token function">cp</span> <span class="token parameter variable">-r</span> tool/centerpoint-export path/to/CenterPoint
$ <span class="token builtin class-name">cd</span> path/to/CenterPoint
$ python centerpoint-export/export-scn.py <span class="token parameter variable">--ckpt</span><span class="token operator">=</span>epoch_20.pth --save-onnx<span class="token operator">=</span>scn.nuscenes.onnx
$ <span class="token function">cp</span> scn.nuscenes.onnx path/to/3DSparseConvolution/workspace/
</code></pre> 
<p>那我们首先需要去搭建 CenterPoint 的一个环境，可以按照它的 <a href="https://github.com/tianweiy/CenterPoint/blob/master/docs/INSTALL.md">INSTALL</a> 文件去进行配置，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/f7/b0/5mgnZydy_o.png" alt="在这里插入图片描述"></p> 
<p>值得注意的是，CenterPoint 官方提供的环境配置其实是用来做训练用的，所以它这个环境搭建起来会比较大，比较复杂，也会有很多没必要的东西。对于我们来说，我们其实不需要做训练，我们只需要导出 ONNX 就好了，所以我们只要把跟 ONNX 导出有关的包安装下就好了</p> 
<p>另外我们可以看到 CenterPoint 官方推荐安装的软件版本都太低了，那 pytorch 版本是 1.1.0 的，cudatoolkit 版本是 10.0 的，现在 cuda 都是 12.0 的，那这个看起来就不太好，那怎么办呢，那这里大家不要按照官方的步骤去配置这个环境，我们自己来配置，那下面是韩老师配置的一个能够导出 ONNX 的最小环境配置，指令如下：</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/tianweiy/CenterPoint.git
<span class="token builtin class-name">cd</span> CenterPoint
conda create <span class="token parameter variable">--name</span> centerpoint <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.7</span>
conda activate centerpoint
conda <span class="token function">install</span> <span class="token assign-left variable">pytorch</span><span class="token operator">==</span><span class="token number">1.10</span>.1 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.11</span>.2 <span class="token assign-left variable">cudatoolkit</span><span class="token operator">=</span><span class="token number">11.3</span> <span class="token parameter variable">-c</span> pytorch
<span class="token builtin class-name">cd</span> det3d/ops/iou3d_nms
python setup.py build_ext <span class="token parameter variable">--inplace</span>
pip <span class="token function">install</span> numba spconv-cu113 terminaltables addict pyyaml pycocotools onnx 
</code></pre> 
<p>那我们大家按照韩老师提供的这个方式去配置一下环境就好了，大家不要去做 pip install -r requirement.txt，这里面有太多东西没有必要安装，比如说 opencv、matplotlib 等等，每一个都有好几个 G，我们没有必要去安装它，所以就直接跳过就好了</p> 
<p>OK，我们按照上述方式将环境配置好之后，再看 NVIDIA 官方提供的导出指令，将 centerpoint-export 文件夹拷贝到 CenterPoint 中，然后执行相关 python 指令导出即可，整个过程如下图所示：</p> 
<p><img src="https://images2.imgbox.com/a6/7c/ApB0vT4T_o.png" alt="在这里插入图片描述"></p> 
<p>我们可以看到 SCN 的 ONNX 成功导出了，那它效果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/04/7d/Fs9ndfKS_o.png" alt="在这里插入图片描述"></p> 
<p>从日志信息可以看出它把 SCN 里面的所有节点全都做了一个重定位，导出完之后的 onnx 我们可以使用 Netron 可视化工具打开，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/81/b0/7F0jkG57_o.png" alt="在这里插入图片描述"></p> 
<p>上面就是刚刚导出的 ONNX，它的架构就是这个样子，SparseConvolution 就是我们说的 spconv 节点，它包含的数据信息有很多，那推理的时候我们就只要把这些数据传递给 spconv 推理引擎的 builder 就可以创建一个自定义的节点</p> 
<p>那这里给大家讲解了导出 spconv 的代码，讲解了里面的 register_node 和 hook 函数是怎么实现的，这里面大家不清楚的可以去看看视频</p> 
<p>OK，那导出带有 spconv 的 SCN 网络的 ONNX 这个部分到这里就结束了，建议大家自己动手把这个 onnx 导出来，同时也可以看一看它的 C++ 推理框架是怎么写的</p> 
<h3><a id="3__677"></a>3. 补充-装饰器+钩子函数</h3> 
<blockquote> 
 <p>博主这里结合 ChatGPT 的分析把 spconv.forward 如何实现重定位的流程再简单过一遍</p> 
</blockquote> 
<p>我们要分析的代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">register_node</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

    fnnames   <span class="token operator">=</span> fn<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>
    fn_module <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>fnnames<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fn_name   <span class="token operator">=</span> fnnames<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    oldfn <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">make_hook</span><span class="token punctuation">(</span>bind_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

        ilayer <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">def</span> <span class="token function">internal_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">global</span> enable_trace

            <span class="token keyword">if</span> <span class="token keyword">not</span> enable_trace<span class="token punctuation">:</span>
                <span class="token keyword">return</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>

            <span class="token keyword">global</span> avoid_reuse_container
            <span class="token keyword">nonlocal</span> ilayer

            <span class="token comment"># Use the enable_trace flag to avoid internal trace calls</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">False</span>
            y <span class="token operator">=</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            bind_fn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">True</span>

            avoid_reuse_container<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> 
            
            ilayer <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">return</span> y

        <span class="token builtin">setattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">,</span> internal_forward<span class="token punctuation">)</span>
    <span class="token keyword">return</span> make_hook

<span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"spconv.conv.SparseConvolution.forward"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_sparse_convolution</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; SparseConvolution</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'subm'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm <span class="token keyword">else</span> <span class="token string">'conv'</span><span class="token punctuation">}</span></span><span class="token string">] -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_deconv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_padding
        <span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_conv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation
        <span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">:</span>
        output_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    output_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels
    inputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.weight"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        inputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.bias"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    act_type_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>ReLU      <span class="token punctuation">:</span> <span class="token string">"ReLU"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>None_     <span class="token punctuation">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>Sigmoid   <span class="token punctuation">:</span> <span class="token string">"Sigmoid"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>LeakyReLU <span class="token punctuation">:</span> <span class="token string">"LeakyReLU"</span>
    <span class="token punctuation">}</span>

    algo_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        ConvAlgo<span class="token punctuation">.</span>MaskImplicitGemm      <span class="token punctuation">:</span> <span class="token string">"MaskImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>MaskSplitImplicitGemm <span class="token punctuation">:</span> <span class="token string">"MaskSplitImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>Native <span class="token punctuation">:</span> <span class="token string">"Native"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    output_bound <span class="token operator">=</span> <span class="token number">200000</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"output_bound"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        output_bound <span class="token operator">=</span> self<span class="token punctuation">.</span>output_bound

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"SparseConvolution"</span><span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"conv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> 
            ndim <span class="token operator">=</span> self<span class="token punctuation">.</span>ndim<span class="token punctuation">,</span>
            input_spatial_shape <span class="token operator">=</span> x<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            output_spatial_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            in_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span>
            out_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span>
            kernel_size <span class="token operator">=</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span>
            output_bound <span class="token operator">=</span> output_bound<span class="token punctuation">,</span>
            stride <span class="token operator">=</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span>
            dilation <span class="token operator">=</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span>
            padding <span class="token operator">=</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
            transposed <span class="token operator">=</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">,</span>
            inverse <span class="token operator">=</span> self<span class="token punctuation">.</span>inverse<span class="token punctuation">,</span>
            output_padding <span class="token operator">=</span> self<span class="token punctuation">.</span>output_padding<span class="token punctuation">,</span>
            groups <span class="token operator">=</span> self<span class="token punctuation">.</span>groups<span class="token punctuation">,</span>
            subm <span class="token operator">=</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">,</span>
            rulebook <span class="token operator">=</span> self<span class="token punctuation">.</span>indice_key<span class="token punctuation">,</span>
            activation <span class="token operator">=</span> act_type_name<span class="token punctuation">[</span>self<span class="token punctuation">.</span>act_type<span class="token punctuation">]</span><span class="token punctuation">,</span>
            input_shape  <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
            output_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>首先我们需要知道 @register_node 是一个装饰器，装饰器在 Python 中是一个非常强大的功能，它允许你在不修改原始代码的情况下，给函数增加额外的功能。<strong>装饰器本质上是一个函数，它接受一个函数作为参数并返回一个新的函数</strong>。当看到 <code>@</code> 符号用在一个函数定义之前时，它实际上是在应用一个装饰器。</p> 
<p>下面我们详细分析一下在执行 <strong>spconv.conv.SparseConvolution.forward</strong> 方法时，代码是如何工作的，主要是涉及到装饰器 <strong>register_node</strong> 和函数 <strong>symbolic_sparse_convolution</strong> 的使用</p> 
<p>我们先来过一下装饰器 <strong>register_node</strong> 的工作原理</p> 
<ul><li><strong>1. 初始化阶段</strong> 
  <ul><li>当 export_tool.py 脚本运行时，首先会去执行 <strong>register_node(“spconv.conv.SparseConvolution.forward”)</strong> 装饰器</li><li>这个参数接收一个字符串参数，代表要修改的函数的名称</li></ul> </li><li><strong>2. register_node 功能</strong> 
  <ul><li>在 <strong>register_node</strong> 内部，它首先会根据传入的字符串找到相应的函数对象</li><li>然后，它会返回一个名为 <strong>make_hook</strong> 的函数</li></ul> </li><li><strong>3. 创建 mask_hook</strong> 
  <ul><li><strong>make_hook</strong> 是一个内部函数，它的目的是接收一个函数（这里是 <strong>symbolic_sparse_convolution</strong>）并“钩住”（hook）原始的 <strong>SparseConvolution.forward</strong> 方法</li></ul> </li></ul> 
<p>接着我们再过一下整个执行过程</p> 
<ul><li><strong>1. 应用装饰器</strong> 
  <ul><li>当 <strong>@register_node(“spconv.conv.SparseConvolution.forward”)</strong> 应用于 <strong>symbolic_sparse_convolution</strong> 函数时，实际上是一个语法糖，其作用等同于 <strong>symbolic_sparse_convolution = register_node(“spconv.conv.SparseConvolution.forward”)(symbolic_sparse_convolution)</strong></li><li><strong>make_hook</strong> 接收 <strong>symbolic_sparse_convolution</strong> 作为参数，然后在 <strong>SparseConvolution.forward</strong> 上调用 <strong>internal_forward</strong> 函数</li></ul> </li><li><strong>2. 修改 SparseConvolution.forward</strong> 
  <ul><li><strong>internal_forward</strong> 函数替换了原始的 <strong>SparseConvolution.forward</strong> 方法，这意味着每次调用 <strong>SparseConvolution.forward</strong> 时，实际上是调用 <strong>internal_forward</strong></li></ul> </li><li><strong>3. 执行 internal forward</strong> 
  <ul><li>当 <strong>SparseConvolution.forward</strong> 被调用时，<strong>internal_forward</strong> 被执行</li><li>在 <strong>inernal_forward</strong> 内部，首先会调用原始的 <strong>SparseConvolution.forward</strong> 方法（通过 <strong>oldfn(self *args)</strong>），然后会调用 <strong>symbolic_sparse_convolution</strong> 函数</li></ul> </li><li><strong>4. 执行 symbolic_sparse_convolution</strong> 
  <ul><li><strong>symbolic_sparse_convolution</strong> 函数在每次 <strong>SparseConvolution.forward</strong> 被调用后执行，用于执行追踪逻辑，如创建 onnx 图中的节点</li></ul> </li></ul> 
<p>总的来说，当 <strong>spconv.conv.SparseConvolution.forward</strong> 方法被调用时，由于装饰器 <strong>register_node</strong> 的作用，实际上是先执行了 <strong>internal_forward</strong> 函数。这个函数首先执行原始的 <strong>SparseConvolution.forward</strong> 方法，然后执行 <strong>symbolic_sparse_convolution</strong> 函数来进行追踪和收集信息。这种机制允许在不更改原始函数代码的前提下，增加额外的功能，这在许多情况下非常有用，特别是在需要追踪或记录函数行为的场景中。</p> 
<h3><a id="_816"></a>总结</h3> 
<blockquote> 
 <p>本次课程我们学习了导出带有 spconv 的 SCN 网络的 onnx，首先我们先去看了 spconv 的 C++ 推理框架，由于核心部分未开源我们也只是知道它的基本流程，它主要是通过 protobuf 的函数解析读取的 onnx，然后将解析出来的数据通过 builder 的 push_sparse_conv 函数创建 spconv 的节点，依此类推，SCN 中所有节点均可采用这种方式，这样整个 engine 就构建好了。</p> 
 <p>接着我们学习了导出 spconv 的 onnx，主要是利用钩子函数对 spconv.forward 进行重定位，重定位到我们自定义的函数中，通过 helper.make_node 创建自定义的节点，将推理所需要的信息全部都填充进去。这样把 SCN 中所有自定义的节点放到 graph 中创建一个 model 保存下来即可</p> 
 <p>OK，以上就是第 3 小节有关导出带有 spconv 的 SCN 网络的 onnx的全部内容了，下节我们将去学习 spconv 的优化方案—Explicit GEMM Conv，敬请期待😄</p> 
</blockquote> 
<h3><a id="_824"></a>下载链接</h3> 
<ul><li><a href="https://pan.baidu.com/s/1QmH51czKVOyVDmD_m_n2CA" rel="nofollow">论文下载链接【提取码：6463】</a></li><li><a href="https://pan.baidu.com/s/1MS_A2-YRvFj1LsL85RuQiQ" rel="nofollow">数据集下载链接【提取码：data】</a></li><li><a href="https://pan.baidu.com/s/1BjaKZh7XuzBehMvvGKnglQ" rel="nofollow">代码和安装包下载链接【提取码：cuda】</a></li></ul> 
<h3><a id="_830"></a>参考</h3> 
<ul><li><a href="https://blog.csdn.net/qq_40672115/article/details/129914076">AutoCV第四课：Python基础</a></li><li><a href="https://blog.csdn.net/qq_40672115/article/details/131480952">复杂onnx解决方案（以sparseconv为例）</a></li><li><a href="https://github.com/tianweiy/CenterPoint">https://github.com/tianweiy/CenterPoint</a></li><li><a href="https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution">https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/14712fe820042dc7d685be90d431fc4b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言——函数栈帧的创建和销毁</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/77ea59aad86a9dff847e48978b0552e2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">常用的排序算法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>