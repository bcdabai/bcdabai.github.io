<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>APB协议UVM验证环境的搭建 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="APB协议UVM验证环境的搭建" />
<meta property="og:description" content="APB协议UVM验证环境的搭建 一、编译文件 只需编译这两个文件即可
apb_pkg.sv
里面包含了&#34;apb.svh&#34;，即编译apb_pkg.sv这个文件的同时，也会编译所需要的所有的头文件。
`ifndef APB_PKG_SV `define APB_PKG_SV package apb_pkg; import uvm_pkg::*; `include &#34;uvm_macros.svh&#34; `include &#34;apb.svh&#34; endpackage : apb_pkg `endif // `ifndef APB_PKG_SV apb.svh
`ifndef APB_SVH `define APB_SVH `include &#34;apb_transfer.sv&#34; `include &#34;apb_config.sv&#34; //master所有的头文件 `include &#34;apb_master_driver.svh&#34; `include &#34;apb_master_monitor.svh&#34; `include &#34;apb_master_sequencer.svh&#34; `include &#34;apb_master_agent.svh&#34; //slave所有的头文件 `include &#34;apb_slave_driver.svh&#34; `include &#34;apb_slave_monitor.svh&#34; `include &#34;apb_slave_sequencer.svh&#34; `include &#34;apb_slave_agent.svh&#34; //master头文件里面具体的实现方法 `include &#34;apb_master_driver.sv&#34; `include &#34;apb_master_monitor.sv&#34; `include &#34;apb_master_sequencer.sv&#34; `include &#34;apb_master_agent.sv&#34; `include &#34;apb_master_seq_lib.sv&#34; //slave头文件里面具体的实现方法 `include &#34;apb_slave_driver.sv&#34; `include &#34;apb_slave_monitor.sv&#34; `include &#34;apb_slave_sequencer.sv&#34; `include &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/033f298a1fc320665525c4afe12335bb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-09T15:27:18+08:00" />
<meta property="article:modified_time" content="2021-03-09T15:27:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">APB协议UVM验证环境的搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="APBUVM_0"></a>APB协议UVM验证环境的搭建</h2> 
<h2><a id="_3"></a>一、编译文件</h2> 
<p>只需编译这两个文件即可<br> <img src="https://images2.imgbox.com/65/a5/agj09kQE_o.png" alt="在这里插入图片描述"></p> 
<p><strong>apb_pkg.sv</strong></p> 
<p>里面包含了"apb.svh"，即编译apb_pkg.sv这个文件的同时，也会编译所需要的所有的头文件。</p> 
<pre><code class="prism language-cpp">`ifndef APB_PKG_SV
`define APB_PKG_SV

package apb_pkg<span class="token punctuation">;</span>

import uvm_pkg<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
`include <span class="token string">"uvm_macros.svh"</span>

`include <span class="token string">"apb.svh"</span>

endpackage <span class="token operator">:</span> apb_pkg

   
`endif <span class="token comment">//  `ifndef APB_PKG_SV</span>

</code></pre> 
<p><strong>apb.svh</strong></p> 
<pre><code class="prism language-cpp">`ifndef APB_SVH
`define APB_SVH


`include <span class="token string">"apb_transfer.sv"</span>
`include <span class="token string">"apb_config.sv"</span>

<span class="token comment">//master所有的头文件</span>
`include <span class="token string">"apb_master_driver.svh"</span>
`include <span class="token string">"apb_master_monitor.svh"</span>
`include <span class="token string">"apb_master_sequencer.svh"</span>
`include <span class="token string">"apb_master_agent.svh"</span>

<span class="token comment">//slave所有的头文件</span>
`include <span class="token string">"apb_slave_driver.svh"</span>
`include <span class="token string">"apb_slave_monitor.svh"</span>
`include <span class="token string">"apb_slave_sequencer.svh"</span>
`include <span class="token string">"apb_slave_agent.svh"</span>

<span class="token comment">//master头文件里面具体的实现方法</span>
`include <span class="token string">"apb_master_driver.sv"</span>       
`include <span class="token string">"apb_master_monitor.sv"</span>
`include <span class="token string">"apb_master_sequencer.sv"</span>
`include <span class="token string">"apb_master_agent.sv"</span>
`include <span class="token string">"apb_master_seq_lib.sv"</span>

<span class="token comment">//slave头文件里面具体的实现方法</span>
`include <span class="token string">"apb_slave_driver.sv"</span>       
`include <span class="token string">"apb_slave_monitor.sv"</span>
`include <span class="token string">"apb_slave_sequencer.sv"</span>
`include <span class="token string">"apb_slave_agent.sv"</span>
`include <span class="token string">"apb_slave_seq_lib.sv"</span>



   
`endif <span class="token comment">//  `ifndef APB_SVH</span>
</code></pre> 
<p><strong>再来编译apb_tb.sv文件</strong></p> 
<p>编译的同时，也会编译"apb_tests.svh"、"apb_if.sv"这两个文件。例化协议接口，配置顶层环境的master和slave，默认执行“apb_single_transaction_test”这个测试用例。</p> 
<pre><code class="prism language-cpp">`timescale <span class="token number">1</span>ps<span class="token operator">/</span><span class="token number">1</span>ps
import uvm_pkg<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
`include <span class="token string">"uvm_macros.svh"</span>
`include <span class="token string">"apb_tests.svh"</span>
`include <span class="token string">"apb_if.sv"</span>
module apb_tb<span class="token punctuation">;</span>
  bit clk<span class="token punctuation">,</span> rstn<span class="token punctuation">;</span>
  initial begin
    fork
      begin 
        forever #<span class="token number">5</span>ns clk <span class="token operator">=</span> <span class="token operator">!</span>clk<span class="token punctuation">;</span>
      end
      begin
        #<span class="token number">100</span>ns<span class="token punctuation">;</span>
        rstn <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        #<span class="token number">100</span>ns<span class="token punctuation">;</span>
        rstn <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        #<span class="token number">100</span>ns<span class="token punctuation">;</span>
        rstn <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
      end
    join_none
  end

  apb_if <span class="token function">intf</span><span class="token punctuation">(</span>clk<span class="token punctuation">,</span> rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  initial begin
    uvm_config_db#<span class="token punctuation">(</span><span class="token keyword">virtual</span> apb_if<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">(</span>uvm_root<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"uvm_test_top.env.mst"</span><span class="token punctuation">,</span> <span class="token string">"vif"</span><span class="token punctuation">,</span> intf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uvm_config_db#<span class="token punctuation">(</span><span class="token keyword">virtual</span> apb_if<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">(</span>uvm_root<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"uvm_test_top.env.slv"</span><span class="token punctuation">,</span> <span class="token string">"vif"</span><span class="token punctuation">,</span> intf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">run_test</span><span class="token punctuation">(</span><span class="token string">"apb_single_transaction_test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  end

endmodule

</code></pre> 
<p><strong>apb_tests.svh</strong></p> 
<pre><code class="prism language-cpp">`ifndef APB_TESTS_SV
`define APB_TESTS_SV

import apb_pkg<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">apb_env</span> extends uvm_env<span class="token punctuation">;</span>
  apb_master_agent mst<span class="token punctuation">;</span>
  apb_slave_agent slv<span class="token punctuation">;</span>
  `<span class="token function">uvm_component_utils</span><span class="token punctuation">(</span>apb_env<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> uvm_component parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
  function <span class="token keyword">void</span> <span class="token function">build_phase</span><span class="token punctuation">(</span>uvm_phase phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token function">build_phase</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mst <span class="token operator">=</span> apb_master_agent<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"mst"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    slv <span class="token operator">=</span> apb_slave_agent<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"slv"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
endclass

<span class="token class-name">class</span> apb_base_test extends uvm_test<span class="token punctuation">;</span>
  apb_env env<span class="token punctuation">;</span>
  `<span class="token function">uvm_component_utils</span><span class="token punctuation">(</span>apb_base_test<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> uvm_component parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
  function <span class="token keyword">void</span> <span class="token function">build_phase</span><span class="token punctuation">(</span>uvm_phase phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token function">build_phase</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    env <span class="token operator">=</span> apb_env<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"env"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
endclass

<span class="token class-name">class</span> apb_base_test_sequence extends uvm_sequence #<span class="token punctuation">(</span>apb_transfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> mem<span class="token punctuation">[</span>bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">//关联数组mem，用来master和slave之间的数据比对，test和slave中都有一个mem</span>
  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_base_test_sequence<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>
  function bit <span class="token function">check_mem_data</span><span class="token punctuation">(</span>bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> addr<span class="token punctuation">,</span> bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mem<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> begin
      <span class="token keyword">if</span><span class="token punctuation">(</span>data <span class="token operator">!=</span> mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">)</span> begin
        `<span class="token function">uvm_error</span><span class="token punctuation">(</span><span class="token string">"CMPDATA"</span><span class="token punctuation">,</span> $<span class="token function">sformatf</span><span class="token punctuation">(</span><span class="token string">"addr 32'h%8x, READ DATA expected 32'h%8x != actual 32'h%8x"</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      end
      <span class="token keyword">else</span> begin
        `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token string">"CMPDATA"</span><span class="token punctuation">,</span> $<span class="token function">sformatf</span><span class="token punctuation">(</span><span class="token string">"addr 32'h%8x, READ DATA 32'h%8x comparing success!"</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      end
    end
    <span class="token keyword">else</span> begin
      <span class="token keyword">if</span><span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> begin
        `<span class="token function">uvm_error</span><span class="token punctuation">(</span><span class="token string">"CMPDATA"</span><span class="token punctuation">,</span> $<span class="token function">sformatf</span><span class="token punctuation">(</span><span class="token string">"addr 32'h%8x, READ DATA expected 32'h00000000 != actual 32'h%8x"</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      end
      <span class="token keyword">else</span> begin
        `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token string">"CMPDATA"</span><span class="token punctuation">,</span> $<span class="token function">sformatf</span><span class="token punctuation">(</span><span class="token string">"addr 32'h%8x, READ DATA 32'h%8x comparing success!"</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      end
    end
  endfunction<span class="token operator">:</span> check_mem_data

  task <span class="token function">wait_reset_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token punctuation">(</span>negedge apb_tb<span class="token punctuation">.</span>rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token punctuation">(</span>posedge apb_tb<span class="token punctuation">.</span>rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask

  task <span class="token function">wait_cycles</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> @<span class="token punctuation">(</span>posedge apb_tb<span class="token punctuation">.</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask

  function bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> addr<span class="token punctuation">;</span>
    <span class="token keyword">void</span>'<span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">randomize</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> with <span class="token punctuation">{<!-- --></span>addr<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> addr<span class="token punctuation">;</span>
  endfunction
endclass

<span class="token class-name">class</span> apb_single_transaction_sequence extends apb_base_test_sequence<span class="token punctuation">;</span>
  apb_master_single_write_sequence single_write_seq<span class="token punctuation">;</span>
  apb_master_single_read_sequence single_read_seq<span class="token punctuation">;</span>
  apb_master_write_read_sequence write_read_seq<span class="token punctuation">;</span>
  rand <span class="token keyword">int</span> test_num <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  constraint cstr<span class="token punctuation">{<!-- --></span>
    soft test_num <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_single_transaction_sequence<span class="token punctuation">)</span>    
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>
  task <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> addr<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait_reset_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait_cycles</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TEST continous write transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST continous write transaction..."</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_write_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>
    end

    <span class="token comment">// TEST continous read transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST continous read transaction..."</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> single_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end

    <span class="token comment">// TEST read transaction after write transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST read transaction after write transaction..."</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_write_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> single_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end


    <span class="token comment">// TEST read transaction immediately after write transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST read transaction immediately after write transaction"</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>write_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>
      <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> write_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait_cycles</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask
endclass<span class="token operator">:</span> apb_single_transaction_sequence

<span class="token keyword">class</span> <span class="token class-name">apb_single_transaction_test</span> extends apb_base_test<span class="token punctuation">;</span>
  `<span class="token function">uvm_component_utils</span><span class="token punctuation">(</span>apb_single_transaction_test<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> uvm_component parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
  task <span class="token function">run_phase</span><span class="token punctuation">(</span>uvm_phase phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    apb_single_transaction_sequence seq <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">raise_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token function">run_phase</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    seq<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>mst<span class="token punctuation">.</span>sequencer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">drop_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask
endclass<span class="token operator">:</span> apb_single_transaction_test

<span class="token keyword">class</span> <span class="token class-name">apb_burst_transaction_sequence</span> extends apb_base_test_sequence<span class="token punctuation">;</span>
  apb_master_burst_write_sequence burst_write_seq<span class="token punctuation">;</span>
  apb_master_burst_read_sequence burst_read_seq<span class="token punctuation">;</span>
  rand <span class="token keyword">int</span> test_num <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  constraint cstr<span class="token punctuation">{<!-- --></span>
    soft test_num <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_burst_transaction_sequence<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>
  task <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> addr<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait_reset_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait_cycles</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TEST continous write transaction</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>burst_write_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">foreach</span><span class="token punctuation">(</span>burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> begin
        mem<span class="token punctuation">[</span>addr<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      end
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>burst_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">foreach</span><span class="token punctuation">(</span>burst_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> begin
        <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      end
    end

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait_cycles</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask
endclass<span class="token operator">:</span> apb_burst_transaction_sequence

<span class="token keyword">class</span> <span class="token class-name">apb_burst_transaction_test</span> extends apb_base_test<span class="token punctuation">;</span>
  `<span class="token function">uvm_component_utils</span><span class="token punctuation">(</span>apb_burst_transaction_test<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> uvm_component parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
  task <span class="token function">run_phase</span><span class="token punctuation">(</span>uvm_phase phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    apb_burst_transaction_sequence seq <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">raise_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token function">run_phase</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    seq<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>mst<span class="token punctuation">.</span>sequencer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">drop_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask
endclass<span class="token operator">:</span> apb_burst_transaction_test



`endif <span class="token comment">// APB_TESTS_SV</span>
</code></pre> 
<p><strong>apb_if.sv</strong></p> 
<pre><code class="prism language-cpp">
`ifndef APB_IF_SV
`define APB_IF_SV

interface apb_if <span class="token punctuation">(</span>input clk<span class="token punctuation">,</span> input rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  logic <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> paddr<span class="token punctuation">;</span>
  logic        pwrite<span class="token punctuation">;</span>
  logic        psel<span class="token punctuation">;</span>
  logic        penable<span class="token punctuation">;</span>
  logic <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> pwdata<span class="token punctuation">;</span>
  logic <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> prdata<span class="token punctuation">;</span>

  <span class="token comment">// Control flags</span>
  bit                has_checks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  bit                has_coverage <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// Actual Signals </span>
  <span class="token comment">// USER: Add interface signals</span>

  clocking cb_mst @<span class="token punctuation">(</span>posedge clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// USER: Add clocking block detail</span>
    <span class="token keyword">default</span> input #<span class="token number">1</span>ps output #<span class="token number">1</span>ps<span class="token punctuation">;</span>
    output paddr<span class="token punctuation">,</span> pwrite<span class="token punctuation">,</span> psel<span class="token punctuation">,</span> penable<span class="token punctuation">,</span> pwdata<span class="token punctuation">;</span>
    input prdata<span class="token punctuation">;</span>
  endclocking <span class="token operator">:</span> cb_mst

  clocking cb_slv @<span class="token punctuation">(</span>posedge clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// USER: Add clocking block detail</span>
    <span class="token keyword">default</span> input #<span class="token number">1</span>ps output #<span class="token number">1</span>ps<span class="token punctuation">;</span>
    input paddr<span class="token punctuation">,</span> pwrite<span class="token punctuation">,</span> psel<span class="token punctuation">,</span> penable<span class="token punctuation">,</span> pwdata<span class="token punctuation">;</span>
    output prdata<span class="token punctuation">;</span>
  endclocking <span class="token operator">:</span> cb_slv

  clocking cb_mon @<span class="token punctuation">(</span>posedge clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// USER: Add clocking block detail</span>
    <span class="token keyword">default</span> input #<span class="token number">1</span>ps output #<span class="token number">1</span>ps<span class="token punctuation">;</span>
    input paddr<span class="token punctuation">,</span> pwrite<span class="token punctuation">,</span> psel<span class="token punctuation">,</span> penable<span class="token punctuation">,</span> pwdata<span class="token punctuation">,</span> prdata<span class="token punctuation">;</span>
  endclocking <span class="token operator">:</span> cb_mon

  <span class="token comment">// Coverage and assertions to be implemented here.</span>
  <span class="token comment">// USER: Add assertions/coverage here</span>

  <span class="token comment">// APB command covergroup</span>
  covergroup cg_apb_command @<span class="token punctuation">(</span>posedge clk iff rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwrite<span class="token operator">:</span> coverpoint pwrite<span class="token punctuation">{<!-- --></span>
      type_option<span class="token punctuation">.</span>weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      bins write <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      bins read  <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    psel <span class="token operator">:</span> coverpoint psel<span class="token punctuation">{<!-- --></span>
      type_option<span class="token punctuation">.</span>weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      bins sel   <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      bins unsel <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cmd  <span class="token operator">:</span> cross pwrite<span class="token punctuation">,</span> psel<span class="token punctuation">{<!-- --></span>
      bins cmd_write <span class="token operator">=</span> <span class="token function">binsof</span><span class="token punctuation">(</span>psel<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">binsof</span><span class="token punctuation">(</span>pwrite<span class="token punctuation">.</span>write<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins cmd_read  <span class="token operator">=</span> <span class="token function">binsof</span><span class="token punctuation">(</span>psel<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">binsof</span><span class="token punctuation">(</span>pwrite<span class="token punctuation">.</span>read<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins cmd_idle  <span class="token operator">=</span> <span class="token function">binsof</span><span class="token punctuation">(</span>psel<span class="token punctuation">.</span>unsel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  endgroup

  <span class="token comment">// APB transaction timing group</span>
  covergroup cg_apb_trans_timing_group @<span class="token punctuation">(</span>posedge clk iff rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    psel<span class="token operator">:</span> coverpoint psel<span class="token punctuation">{<!-- --></span>
      bins single   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_2  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_4  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">]</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_8  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_16 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    penable<span class="token operator">:</span> coverpoint penable <span class="token punctuation">{<!-- --></span>
      bins single <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins burst  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span>         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  endgroup

  <span class="token comment">// APB write &amp; read order group</span>
  covergroup cg_apb_write_read_order_group @<span class="token punctuation">(</span>posedge clk iff <span class="token punctuation">(</span>rstn <span class="token operator">&amp;&amp;</span> penable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    write_read_order<span class="token operator">:</span> coverpoint pwrite<span class="token punctuation">{<!-- --></span>
      bins write_write <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins write_read  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins read_write  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins read_read   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
  endgroup

  initial begin
    automatic cg_apb_command cg0 <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    automatic cg_apb_trans_timing_group cg1 <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    automatic cg_apb_write_read_order_group cg2 <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  end

endinterface <span class="token operator">:</span> apb_if

`endif <span class="token comment">// APB_IF_SV</span>

</code></pre> 
<h2><a id="apb_testssv_419"></a>二、<code>apb_tests.sv</code>代码分析</h2> 
<p><strong><code>apb_base_test_sequence</code>类</strong></p> 
<p><code>check_mem_data()</code>方法原理结构框图：</p> 
<p>关联数组mem，用来master和slave之间的数据比对，test和slave中都有一个mem，master通过接口发送数据给slave，slave中的mem和test中的mem都会存储这个数据，等从slave读回数据时，就可以和test中mem里面的数据进行比较。<br> <img src="https://images2.imgbox.com/83/a9/ctIGFwJ3_o.png" alt="在这里插入图片描述"></p> 
<p><strong><code>apb_single_transaction_sequence</code>类</strong></p> 
<p>随机化addr，测试连续写操作</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// TEST continous write transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST continous write transaction..."</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_write_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>
    end
</code></pre> 
<p>随机化addr，测试连续读操作，并比较数据是否一致</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// TEST continous read transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST continous read transaction..."</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> single_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end
</code></pre> 
<p>随机化addr，先进行写操作，再进行读操作，并比较读取的数据是否一致</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// TEST read transaction after write transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST read transaction after write transaction..."</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_write_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>single_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> single_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end
</code></pre> 
<p>随机化addr，写完立即读，中间没有idle空闲，并检查读取数据是否一致</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// TEST read transaction immediately after write transaction</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"TEST read transaction immediately after write transaction"</span><span class="token punctuation">,</span> UVM_LOW<span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>write_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>
      <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> write_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end
</code></pre> 
<p>例化并挂载</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">apb_single_transaction_test</span> extends apb_base_test<span class="token punctuation">;</span>
  `<span class="token function">uvm_component_utils</span><span class="token punctuation">(</span>apb_single_transaction_test<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> uvm_component parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
  task <span class="token function">run_phase</span><span class="token punctuation">(</span>uvm_phase phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    apb_single_transaction_sequence seq <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">raise_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token function">run_phase</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    seq<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>mst<span class="token punctuation">.</span>sequencer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">drop_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask
endclass<span class="token operator">:</span> apb_single_transaction_test
</code></pre> 
<p><strong><code>apb_burst_transaction_sequence</code>类</strong></p> 
<p>先全部写操作完毕，在完全读出来，地址是连续增长的</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// TEST continous write transaction</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span>test_num<span class="token punctuation">)</span> begin
      addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get_rand_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>burst_write_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">foreach</span><span class="token punctuation">(</span>burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> begin
        mem<span class="token punctuation">[</span>addr<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      end
      `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>burst_read_seq<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">foreach</span><span class="token punctuation">(</span>burst_read_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> begin
        <span class="token keyword">void</span>'<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check_mem_data</span><span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> burst_write_seq<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      end
    end
</code></pre> 
<p>例化并挂载</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">apb_burst_transaction_test</span> extends apb_base_test<span class="token punctuation">;</span>
  `<span class="token function">uvm_component_utils</span><span class="token punctuation">(</span>apb_burst_transaction_test<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> uvm_component parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction
  task <span class="token function">run_phase</span><span class="token punctuation">(</span>uvm_phase phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    apb_burst_transaction_sequence seq <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">raise_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token function">run_phase</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    seq<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>mst<span class="token punctuation">.</span>sequencer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    phase<span class="token punctuation">.</span><span class="token function">drop_objection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  endtask
endclass<span class="token operator">:</span> apb_burst_transaction_test
</code></pre> 
<h2><a id="apb_master_agentsv_534"></a>三、<code>apb_master_agent.sv</code>代码分析</h2> 
<p><code>agent</code>包括三个组件<code>driver</code>、<code>sequencer</code>、<code>monitor</code>，以及<code>config</code>和<code>interface</code>。</p> 
<p>例化<code>monitor</code>，根据配置决定是否例化<code>driver</code>和<code>sequencer</code></p> 
<pre><code class="prism language-cpp">function <span class="token keyword">void</span> apb_master_agent<span class="token operator">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  super<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// get config</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>uvm_config_db#<span class="token punctuation">(</span>apb_config<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"cfg"</span><span class="token punctuation">,</span> cfg<span class="token punctuation">)</span><span class="token punctuation">)</span> begin
    `<span class="token function">uvm_warning</span><span class="token punctuation">(</span><span class="token string">"GETCFG"</span><span class="token punctuation">,</span><span class="token string">"cannot get config object from config DB"</span><span class="token punctuation">)</span>
     cfg <span class="token operator">=</span> apb_config<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"cfg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  end
  <span class="token comment">// get virtual interface</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>uvm_config_db#<span class="token punctuation">(</span><span class="token keyword">virtual</span> apb_if<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"vif"</span><span class="token punctuation">,</span> vif<span class="token punctuation">)</span><span class="token punctuation">)</span> begin
    `<span class="token function">uvm_fatal</span><span class="token punctuation">(</span><span class="token string">"GETVIF"</span><span class="token punctuation">,</span><span class="token string">"cannot get vif handle from config DB"</span><span class="token punctuation">)</span>
  end
  monitor <span class="token operator">=</span> apb_master_monitor<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"monitor"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  monitor<span class="token punctuation">.</span>cfg <span class="token operator">=</span> cfg<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>is_active <span class="token operator">==</span> UVM_ACTIVE<span class="token punctuation">)</span> begin
    sequencer <span class="token operator">=</span> apb_master_sequencer<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"sequencer"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sequencer<span class="token punctuation">.</span>cfg <span class="token operator">=</span> cfg<span class="token punctuation">;</span>
    driver <span class="token operator">=</span> apb_master_driver<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    driver<span class="token punctuation">.</span>cfg <span class="token operator">=</span> cfg<span class="token punctuation">;</span>
  end
endfunction <span class="token operator">:</span> build
</code></pre> 
<p>根据配置决定是否连接<code>driver</code>和<code>sequencer</code></p> 
<pre><code class="prism language-cpp">function <span class="token keyword">void</span> apb_master_agent<span class="token operator">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assign_vi</span><span class="token punctuation">(</span>vif<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>is_active <span class="token operator">==</span> UVM_ACTIVE<span class="token punctuation">)</span> begin
    driver<span class="token punctuation">.</span>seq_item_port<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>sequencer<span class="token punctuation">.</span>seq_item_export<span class="token punctuation">)</span><span class="token punctuation">;</span>       
  end

endfunction <span class="token operator">:</span> connect
</code></pre> 
<p>根据配置决定是否vif和driver、sequencer之间的连接</p> 
<pre><code class="prism language-cpp">function <span class="token keyword">void</span> apb_master_agent<span class="token operator">::</span><span class="token function">assign_vi</span><span class="token punctuation">(</span><span class="token keyword">virtual</span> apb_if vif<span class="token punctuation">)</span><span class="token punctuation">;</span>
   monitor<span class="token punctuation">.</span>vif <span class="token operator">=</span> vif<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>is_active <span class="token operator">==</span> UVM_ACTIVE<span class="token punctuation">)</span> begin
      sequencer<span class="token punctuation">.</span>vif <span class="token operator">=</span> vif<span class="token punctuation">;</span> 
      driver<span class="token punctuation">.</span>vif <span class="token operator">=</span> vif<span class="token punctuation">;</span> 
    end
endfunction <span class="token operator">:</span> assign_vi
</code></pre> 
<h2><a id="apb_master_driversv_586"></a>四、<code>apb_master_driver.sv</code>代码分析</h2> 
<p>并行触发<code>get_and_drive()</code>、<code>reset_listener()</code></p> 
<pre><code class="prism language-cpp">task apb_master_driver<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   fork
     <span class="token function">get_and_drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">reset_listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   join_none
endtask <span class="token operator">:</span> run
</code></pre> 
<p>捕捉到复位信号以后，所以信号清零</p> 
<pre><code class="prism language-cpp">task apb_master_driver<span class="token operator">::</span><span class="token function">reset_listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"reset_listener ..."</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  fork
    forever begin
      @<span class="token punctuation">(</span>negedge vif<span class="token punctuation">.</span>rstn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ASYNC reset</span>
      vif<span class="token punctuation">.</span>paddr <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      vif<span class="token punctuation">.</span>pwrite <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      vif<span class="token punctuation">.</span>psel <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      vif<span class="token punctuation">.</span>penable <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      vif<span class="token punctuation">.</span>pwdata <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    end
  join_none
endtask
</code></pre> 
<p><code>sequence</code>和<code>sequencer</code>需要握手，获取<code>transaction</code>以后调用<code>driver_transfer()</code>发送。发送成功以后克隆<code>request</code>生成新的<code>response</code>，作为响应发送回去。</p> 
<pre><code class="prism language-cpp">task apb_master_driver<span class="token operator">::</span><span class="token function">get_and_drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  forever begin
    seq_item_port<span class="token punctuation">.</span><span class="token function">get_next_item</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sequencer got next item"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
    <span class="token function">drive_transfer</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>'<span class="token punctuation">(</span>$<span class="token function">cast</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rsp<span class="token punctuation">.</span><span class="token function">set_sequence_id</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">get_sequence_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seq_item_port<span class="token punctuation">.</span><span class="token function">item_done</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sequencer item_done_triggered"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  end
endtask <span class="token operator">:</span> get_and_drive

task apb_master_driver<span class="token operator">::</span>drive_transfer <span class="token punctuation">(</span>apb_transfer t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"drive_transfer"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  <span class="token keyword">case</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>trans_kind<span class="token punctuation">)</span>
    IDLE    <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    WRITE   <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_write</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    READ    <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_read</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token operator">:</span> `<span class="token function">uvm_error</span><span class="token punctuation">(</span><span class="token string">"ERRTYPE"</span><span class="token punctuation">,</span> <span class="token string">"unrecognized transaction type"</span><span class="token punctuation">)</span>
  endcase
endtask <span class="token operator">:</span> drive_transfer
</code></pre> 
<p>根据<code>trans_kind</code>判断操作命令，分别调用相对应的方法。</p> 
<pre><code class="prism language-cpp">task apb_master_driver<span class="token operator">::</span><span class="token function">do_write</span><span class="token punctuation">(</span>apb_transfer t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"do_write ..."</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  <span class="token comment">//写操作一共分为两个周期，根据协议第一个周期setup准备阶段需要如下操作</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>paddr <span class="token operator">&lt;=</span> t<span class="token punctuation">.</span>addr<span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>pwrite <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>psel <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>penable <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>pwdata <span class="token operator">&lt;=</span> t<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token comment">//第二个阶段拉高penable信号，发送数据</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>penable <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">repeat</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>idle_cycles<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//取决于transaction里面的idle</span>
endtask<span class="token operator">:</span> do_write

task apb_master_driver<span class="token operator">::</span><span class="token function">do_read</span><span class="token punctuation">(</span>apb_transfer t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"do_write ..."</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  <span class="token comment">//第一个阶段</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>paddr <span class="token operator">&lt;=</span> t<span class="token punctuation">.</span>addr<span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>pwrite <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>psel <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>penable <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//第二个阶段</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>penable <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  #<span class="token number">100</span>ps<span class="token punctuation">;</span>	<span class="token comment">//需要采样数据，人为添加100ps的delay，是为了避免delta-cycle</span>
  t<span class="token punctuation">.</span>data <span class="token operator">=</span> vif<span class="token punctuation">.</span>prdata<span class="token punctuation">;</span>		<span class="token comment">//采样数据</span>
  <span class="token function">repeat</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>idle_cycles<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
endtask<span class="token operator">:</span> do_read

task apb_master_driver<span class="token operator">::</span><span class="token function">do_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"do_idle ..."</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//根据协议，paddr、pwrite可以保持不变，等待下一次的传输，这是为了省电</span>
  <span class="token comment">//vif.cb_mst.paddr &lt;= 0;</span>
  <span class="token comment">//vif.cb_mst.pwrite &lt;= 0;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>psel <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>penable <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>cb_mst<span class="token punctuation">.</span>pwdata <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
endtask<span class="token operator">:</span>do_idle
</code></pre> 
<h2><a id="apb_master_monitorsv_690"></a>五、<code>apb_master_monitor.sv</code>代码分析</h2> 
<p><strong><code>collect_transfer()</code>方法</strong></p> 
<p>在时钟上升沿，同时<code>psel=1</code>和<code>penabl=0</code>的时候，判断当前情况下<code>pwrite</code>信号，在第二个周期进行读或者写操作。</p> 
<pre><code class="prism language-cpp">task apb_master_monitor<span class="token operator">::</span><span class="token function">collect_transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  apb_transfer t<span class="token punctuation">;</span>
  <span class="token comment">// Advance clock</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mon<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">.</span>psel <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span><span class="token string">'b1 &amp;&amp; vif.cb_slv.penable === 1'</span>b0<span class="token punctuation">)</span> begin
    t <span class="token operator">=</span> apb_transfer<span class="token operator">::</span>type_id<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span><span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">.</span>pwrite<span class="token punctuation">)</span>
      <span class="token number">1</span>'b1    <span class="token operator">:</span> begin
                  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mon<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  t<span class="token punctuation">.</span>addr <span class="token operator">=</span> vif<span class="token punctuation">.</span>cb_mon<span class="token punctuation">.</span>paddr<span class="token punctuation">;</span>
                  t<span class="token punctuation">.</span>data <span class="token operator">=</span> vif<span class="token punctuation">.</span>cb_mon<span class="token punctuation">.</span>pwdata<span class="token punctuation">;</span>
                  t<span class="token punctuation">.</span>trans_kind <span class="token operator">=</span> WRITE<span class="token punctuation">;</span>
                end 
      <span class="token number">1</span>'b0    <span class="token operator">:</span> begin
                  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_mon<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  t<span class="token punctuation">.</span>addr <span class="token operator">=</span> vif<span class="token punctuation">.</span>cb_mon<span class="token punctuation">.</span>paddr<span class="token punctuation">;</span>
                  t<span class="token punctuation">.</span>data <span class="token operator">=</span> vif<span class="token punctuation">.</span>cb_mon<span class="token punctuation">.</span>prdata<span class="token punctuation">;</span>
                  t<span class="token punctuation">.</span>trans_kind <span class="token operator">=</span> READ<span class="token punctuation">;</span>
                end
      <span class="token keyword">default</span> <span class="token operator">:</span> `<span class="token function">uvm_error</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERROR pwrite signal value"</span><span class="token punctuation">)</span>
    endcase
    item_collected_port<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  end
endtask<span class="token operator">:</span> collect_transfer
</code></pre> 
<h2><a id="apb_master_seq_libsv_723"></a>六、<code>apb_master_seq_lib.sv</code>代码分析</h2> 
<p><strong><code>apb_master_single_write_sequence</code>类</strong></p> 
<p>使用宏<code>'uvm_do_with</code>发送数据。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">apb_master_single_write_sequence</span> extends apb_master_base_sequence<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      addr<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      data<span class="token punctuation">;</span>

  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_master_single_write_sequence<span class="token punctuation">)</span>    
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>

  <span class="token keyword">virtual</span> task <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Starting sequence"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
	  `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> WRITE<span class="token punctuation">;</span> addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> data <span class="token operator">==</span> local<span class="token operator">::</span>data<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token function">psprintf</span><span class="token punctuation">(</span><span class="token string">"Done sequence: %s"</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span><span class="token function">convert2string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  endtask<span class="token operator">:</span> body

endclass<span class="token operator">:</span> apb_master_single_write_sequence
</code></pre> 
<p><strong><code>apb_master_single_read_sequence</code>类</strong></p> 
<p>读操作，拿到返回的<code>rsp</code>的数据后存储在成员变量<code>data</code>里。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">apb_master_single_read_sequence</span> extends apb_master_base_sequence<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      addr<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      data<span class="token punctuation">;</span>

  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_master_single_read_sequence<span class="token punctuation">)</span>    
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>

  <span class="token keyword">virtual</span> task <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Starting sequence"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
	  `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> READ<span class="token punctuation">;</span> addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> rsp<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token function">psprintf</span><span class="token punctuation">(</span><span class="token string">"Done sequence: %s"</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span><span class="token function">convert2string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  endtask<span class="token operator">:</span> body

endclass<span class="token operator">:</span> apb_master_single_read_sequence
</code></pre> 
<p><strong><code>apb_master_write_read_sequence</code>类</strong></p> 
<p>写操作后进行读操作，所以<code>idle_cycles == 0</code></p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">apb_master_write_read_sequence</span> extends apb_master_base_sequence<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>    addr<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>    data<span class="token punctuation">;</span>
  rand <span class="token keyword">int</span>           idle_cycles<span class="token punctuation">;</span> 
  constraint cstr<span class="token punctuation">{<!-- --></span>
    idle_cycles <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_master_write_read_sequence<span class="token punctuation">)</span>    
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>

  <span class="token keyword">virtual</span> task <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Starting sequence"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
	  `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>  <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> WRITE<span class="token punctuation">;</span> 
                        addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span> 
                        data <span class="token operator">==</span> local<span class="token operator">::</span>data<span class="token punctuation">;</span>
                        idle_cycles <span class="token operator">==</span> local<span class="token operator">::</span>idle_cycles<span class="token punctuation">;</span>
                       <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> READ<span class="token punctuation">;</span> addr <span class="token operator">==</span> local<span class="token operator">::</span>addr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> rsp<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token function">psprintf</span><span class="token punctuation">(</span><span class="token string">"Done sequence: %s"</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span><span class="token function">convert2string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  endtask<span class="token operator">:</span> body

endclass<span class="token operator">:</span> apb_master_write_read_sequence
</code></pre> 
<p><strong><code>apb_master_burst_write_sequence</code>类</strong></p> 
<p>连续的写操作，按照地址增长的顺序，把所有的数据写到<code>data</code>数组中。因为是连续写操作，所以<code>idle_cycles == 0</code>，即数据之间没有空闲周期。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">apb_master_burst_write_sequence</span> extends apb_master_base_sequence<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      addr<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  constraint cstr<span class="token punctuation">{<!-- --></span>
    soft data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> inside <span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">foreach</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> soft data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> addr <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_master_burst_write_sequence<span class="token punctuation">)</span>    
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>

  <span class="token keyword">virtual</span> task <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Starting sequence"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
    <span class="token function">foreach</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> begin
	    `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> WRITE<span class="token punctuation">;</span> 
                         addr <span class="token operator">==</span> local<span class="token operator">::</span>addr <span class="token operator">+</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                         data <span class="token operator">==</span> local<span class="token operator">::</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                         idle_cycles <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    end
    `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> IDLE<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token function">psprintf</span><span class="token punctuation">(</span><span class="token string">"Done sequence: %s"</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span><span class="token function">convert2string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  endtask<span class="token operator">:</span> body
endclass<span class="token operator">:</span> apb_master_burst_write_sequence
</code></pre> 
<p><strong><code>apb_master_burst_read_sequence</code>类</strong></p> 
<p>连续的读操作，每次读取回来的数据，从<code>rsp</code>中拿出来放到<code>data</code>数组中。全部读取完成之后，将总线置为<code>IDLE</code>。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">apb_master_burst_read_sequence</span> extends apb_master_base_sequence<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      addr<span class="token punctuation">;</span>
  rand bit <span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>      data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  constraint cstr<span class="token punctuation">{<!-- --></span>
    soft data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> inside <span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  `<span class="token function">uvm_object_utils</span><span class="token punctuation">(</span>apb_master_burst_read_sequence<span class="token punctuation">)</span>
  function <span class="token keyword">new</span><span class="token punctuation">(</span>string name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    super<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  endfunction <span class="token operator">:</span> <span class="token keyword">new</span>

  <span class="token keyword">virtual</span> task <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Starting sequence"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
    <span class="token function">foreach</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> begin
	    `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> READ<span class="token punctuation">;</span> 
                         addr <span class="token operator">==</span> local<span class="token operator">::</span>addr <span class="token operator">+</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                         idle_cycles <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rsp<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    end
    `<span class="token function">uvm_do_with</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>trans_kind <span class="token operator">==</span> IDLE<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">get_response</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token function">psprintf</span><span class="token punctuation">(</span><span class="token string">"Done sequence: %s"</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span><span class="token function">convert2string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  endtask<span class="token operator">:</span> body
endclass<span class="token operator">:</span> apb_master_burst_read_sequence
</code></pre> 
<h2><a id="apb_slave_driversv_871"></a>七、apb_slave_driver.sv代码分析</h2> 
<p><code>slave</code>要接收<code>master</code>发送过来的数据，所以要模拟一个存储功能，即关联数组<code>mem</code>。</p> 
<pre><code class="prism language-cpp">  bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> mem <span class="token punctuation">[</span>bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong><code>run()</code>方法</strong></p> 
<p>三个方法并行执行</p> 
<pre><code class="prism language-cpp">task apb_slave_driver<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   fork
     <span class="token function">get_and_drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">reset_listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">drive_response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   join_none
endtask <span class="token operator">:</span> run
</code></pre> 
<p><strong><code>get_and_drive()</code>方法</strong></p> 
<pre><code class="prism language-cpp">task apb_slave_driver<span class="token operator">::</span><span class="token function">get_and_drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  forever begin
    seq_item_port<span class="token punctuation">.</span><span class="token function">get_next_item</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sequencer got next item"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
    <span class="token keyword">void</span>'<span class="token punctuation">(</span>$<span class="token function">cast</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rsp<span class="token punctuation">.</span><span class="token function">set_sequence_id</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">get_sequence_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seq_item_port<span class="token punctuation">.</span><span class="token function">item_done</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sequencer item_done_triggered"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  end
endtask <span class="token operator">:</span> get_and_drive
</code></pre> 
<p><strong><code>reset_listener()</code>方法</strong></p> 
<p>等待复位信号，将<code>prdata &lt;= 0</code>，同时清空<code>mem</code>里面的数据。</p> 
<pre><code class="prism language-cpp">task apb_slave_driver<span class="token operator">::</span><span class="token function">reset_listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"reset_listener ..."</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  fork
    forever begin
      @<span class="token punctuation">(</span>negedge vif<span class="token punctuation">.</span>rstn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ASYNC reset</span>
      vif<span class="token punctuation">.</span>prdata <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mem<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reset internal memory</span>
    end
  join_none
endtask<span class="token operator">:</span> reset_listener
</code></pre> 
<p><strong><code>drive_response()</code>方法</strong></p> 
<p>如果当前这一周期是SETUP阶段，即<code>psel = 1 &amp;&amp; penable = 0</code>，进而判断是写操作还是读操作，然后调用相对应的方法。</p> 
<pre><code class="prism language-cpp">task apb_slave_driver<span class="token operator">::</span><span class="token function">drive_response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"drive_response"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  forever begin
    @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">.</span>psel <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span><span class="token string">'b1 &amp;&amp; vif.cb_slv.penable === 1'</span>b0<span class="token punctuation">)</span> begin
      <span class="token keyword">case</span><span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">.</span>pwrite<span class="token punctuation">)</span>
        <span class="token number">1</span>'b1    <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token number">1</span>'b0    <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span> <span class="token operator">:</span> `<span class="token function">uvm_error</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERROR pwrite signal value"</span><span class="token punctuation">)</span>
      endcase
    end
    <span class="token keyword">else</span> begin
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">do_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end
  end
endtask <span class="token operator">:</span> drive_response
</code></pre> 
<p><strong><code>do_write()</code>方法</strong></p> 
<p>如果是写操作，那么等待时钟下一拍，拿到<code>addr</code>和<code>data</code>并放到<code>mem</code>中。</p> 
<pre><code class="prism language-cpp">task apb_slave_driver<span class="token operator">::</span><span class="token function">do_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> addr<span class="token punctuation">;</span>
  bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> data<span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"do_write"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  addr <span class="token operator">=</span> vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">.</span>paddr<span class="token punctuation">;</span>
  data <span class="token operator">=</span> vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">.</span>pwdata<span class="token punctuation">;</span>
  mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
endtask<span class="token operator">:</span> do_write
</code></pre> 
<p><strong><code>do_read()</code>方法</strong></p> 
<p>如果是读操作，等待<code>penable=1</code>，并且判断<code>mem</code>中是否写过该<code>addr</code>，如果有则写入<code>data</code>，没有则将data置为0，即还是初始化的数据。等待一个延迟后，将<code>data</code>驱动到总线上面。</p> 
<pre><code class="prism language-cpp">task apb_slave_driver<span class="token operator">::</span><span class="token function">do_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> addr<span class="token punctuation">;</span>
  bit<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> data<span class="token punctuation">;</span>
  `<span class="token function">uvm_info</span><span class="token punctuation">(</span><span class="token function">get_type_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"do_read"</span><span class="token punctuation">,</span> UVM_HIGH<span class="token punctuation">)</span>
  <span class="token function">wait</span><span class="token punctuation">(</span>vif<span class="token punctuation">.</span>penable <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  addr <span class="token operator">=</span> vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">.</span>paddr<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mem<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> mem<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  #<span class="token number">1</span>ps<span class="token punctuation">;</span>
  vif<span class="token punctuation">.</span>prdata <span class="token operator">&lt;=</span> data<span class="token punctuation">;</span>
  @<span class="token punctuation">(</span>vif<span class="token punctuation">.</span>cb_slv<span class="token punctuation">)</span><span class="token punctuation">;</span>
endtask<span class="token operator">:</span> do_read
</code></pre> 
<h2><a id="_985"></a>八、运行仿真</h2> 
<p>执行命令</p> 
<pre><code class="prism language-cpp">run <span class="token operator">-</span>all
</code></pre> 
<p>验证环境结构<br> <img src="https://images2.imgbox.com/13/d4/eKhQ5YIx_o.png" alt="在这里插入图片描述"></p> 
<p>写操作：写入地址和写入数据相同，只有<code>penable</code>拉高才会写入，数据之间有一个空闲。<br> <img src="https://images2.imgbox.com/7c/7d/tHVSOhiH_o.png" alt="在这里插入图片描述"><br> 读操作：只有<code>penable</code>拉高才会读数据，没有写入过数据的地址，读出来的值为0。<br> <img src="https://images2.imgbox.com/cc/02/gViPHjSM_o.png" alt="在这里插入图片描述"><br> 先写后读：<br> <img src="https://images2.imgbox.com/7c/b5/qu85KQVe_o.png" alt="在这里插入图片描述"><br> 写完立即读操作：<br> <img src="https://images2.imgbox.com/98/5a/ysC9is78_o.png" alt="在这里插入图片描述"></p> 
<p>仿真结果：</p> 
<p><img src="https://images2.imgbox.com/00/88/54S0pqJe_o.png" alt="在这里插入图片描述"><br> 覆盖率：</p> 
<pre><code class="prism language-cpp">  <span class="token comment">// APB command covergroup</span>
  covergroup cg_apb_command @<span class="token punctuation">(</span>posedge clk iff rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwrite<span class="token operator">:</span> coverpoint pwrite<span class="token punctuation">{<!-- --></span>
      type_option<span class="token punctuation">.</span>weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      bins write <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      bins read  <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    psel <span class="token operator">:</span> coverpoint psel<span class="token punctuation">{<!-- --></span>
      type_option<span class="token punctuation">.</span>weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      bins sel   <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      bins unsel <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cmd  <span class="token operator">:</span> cross pwrite<span class="token punctuation">,</span> psel<span class="token punctuation">{<!-- --></span>
      bins cmd_write <span class="token operator">=</span> <span class="token function">binsof</span><span class="token punctuation">(</span>psel<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">binsof</span><span class="token punctuation">(</span>pwrite<span class="token punctuation">.</span>write<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins cmd_read  <span class="token operator">=</span> <span class="token function">binsof</span><span class="token punctuation">(</span>psel<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">binsof</span><span class="token punctuation">(</span>pwrite<span class="token punctuation">.</span>read<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins cmd_idle  <span class="token operator">=</span> <span class="token function">binsof</span><span class="token punctuation">(</span>psel<span class="token punctuation">.</span>unsel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  endgroup

  <span class="token comment">// APB transaction timing group</span>
  covergroup cg_apb_trans_timing_group @<span class="token punctuation">(</span>posedge clk iff rstn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    psel<span class="token operator">:</span> coverpoint psel<span class="token punctuation">{<!-- --></span>
      bins single   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_2  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_4  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">]</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_8  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_16 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      bins burst_32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    penable<span class="token operator">:</span> coverpoint penable <span class="token punctuation">{<!-- --></span>
      bins single <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins burst  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span>         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  endgroup

  <span class="token comment">// APB write &amp; read order group</span>
  covergroup cg_apb_write_read_order_group @<span class="token punctuation">(</span>posedge clk iff <span class="token punctuation">(</span>rstn <span class="token operator">&amp;&amp;</span> penable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    write_read_order<span class="token operator">:</span> coverpoint pwrite<span class="token punctuation">{<!-- --></span>
      bins write_write <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins write_read  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins read_write  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bins read_read   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
  endgroup


</code></pre> 
<p><img src="https://images2.imgbox.com/f0/c8/fO9LJ1mx_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d0a34f72107fa31176a08f6e2f54619f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CentOS7系统安装配置Apache Web服务器教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2ff640ec570eb5a523e63cbbf65397d0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第一个eBPF程序.md</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>