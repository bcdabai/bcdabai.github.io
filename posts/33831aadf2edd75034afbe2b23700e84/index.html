<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redis安装配置，哨兵模式配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Redis安装配置，哨兵模式配置" />
<meta property="og:description" content="Redis 入门简介 Redis（Remote Dictionary Server 远程字典服务）是一个开源的高性能key-value数据库，它通常被称为数据结构服务器，因为值（value）可以是 字符串(String), 哈希(Hash), 列表(list), 集合(sets) 和 有序集合(sorted sets)等类型，官网：https://redis.io/。
Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。
Redis不仅仅支持简单的key-value类型的数据，同时还提供 list，set，zset，hash等数据结构的存储。
Redis支持数据的备份，即master-slave模式的数据备份。
Redis 安装部署 linux下载地址 wget http://download.redis.io/releases/redis-5.0.7.tar.gz 解压/编译文件 tar xzf cd redis-5.0.7/ make 编译成功后，进入 src 文件夹，执行 make install 进行 Redis 安装。 cd src/ make install 安装成功后显示
部署 由于 src 下文件非常多，我们可以将几个常用的命令和 conf 配置文件复制出来进行统一管理，如下：
新建 bin 和 etc 文件夹 cd /root/redis-5.0.7/ mkdir etc mkdir bin 回到安装目录，将redis.conf复制到 ect 文件夹下 cp redis.conf /root/redis-5.0.7/etc 进入 src 文件夹下，将mkreleasehdr.sh、redis-benchmark、redis-check-aof、redis-check-rdb、redis-cli、redis-server、redis-sentinel文件复制到 bin 文件夹 cd src/ cp mkreleasehdr." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/33831aadf2edd75034afbe2b23700e84/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-12T19:02:55+08:00" />
<meta property="article:modified_time" content="2023-09-12T19:02:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redis安装配置，哨兵模式配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Redis__0"></a>Redis 入门简介</h2> 
<p>Redis（Remote Dictionary Server 远程字典服务）是一个开源的高性能key-value数据库，它通常被称为数据结构服务器，因为值（value）可以是 字符串(String), 哈希(Hash), 列表(list), 集合(sets) 和 有序集合(sorted sets)等类型，官网：https://redis.io/。</p> 
<p>Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。<br> Redis不仅仅支持简单的key-value类型的数据，同时还提供 list，set，zset，hash等数据结构的存储。<br> Redis支持数据的备份，即master-slave模式的数据备份。</p> 
<h2><a id="Redis__7"></a>Redis 安装部署</h2> 
<ul><li>linux下载地址</li></ul> 
<pre><code class="prism language-java">wget http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>io<span class="token operator">/</span>releases<span class="token operator">/</span>redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre> 
<ul><li>解压/编译文件</li></ul> 
<pre><code class="prism language-java">tar xzf cd redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token operator">/</span>
make
</code></pre> 
<ul><li>编译成功后，进入 src 文件夹，执行 make install 进行 Redis 安装。</li></ul> 
<pre><code class="prism language-java">cd src<span class="token operator">/</span>
make install
</code></pre> 
<p>安装成功后显示<br> <img src="https://images2.imgbox.com/3c/81/HdGNe60L_o.png" alt="在这注：如出现/bin/sh: cc: command not found错误，是因为没有安装 gcc 环境，使用命令yum install gcc安装 gcc 环境即可。里插入图片描述"></p> 
<h3><a id="_30"></a>部署</h3> 
<p>由于 src 下文件非常多，我们可以将几个常用的命令和 conf 配置文件复制出来进行统一管理，如下：</p> 
<ol><li>新建 bin 和 etc 文件夹</li></ol> 
<pre><code class="prism language-java">cd <span class="token operator">/</span>root<span class="token operator">/</span>redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token operator">/</span>
mkdir etc
mkdir bin
</code></pre> 
<ol start="2"><li>回到安装目录，将redis.conf复制到 ect 文件夹下</li></ol> 
<pre><code class="prism language-java">cp redis<span class="token punctuation">.</span>conf <span class="token operator">/</span>root<span class="token operator">/</span>redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token operator">/</span>etc
</code></pre> 
<ol start="3"><li>进入 src 文件夹下，将mkreleasehdr.sh、redis-benchmark、redis-check-aof、redis-check-rdb、redis-cli、redis-server、redis-sentinel文件复制到 bin 文件夹</li></ol> 
<pre><code class="prism language-java">cd src<span class="token operator">/</span>
cp mkreleasehdr<span class="token punctuation">.</span>sh redis<span class="token operator">-</span>benchmark redis<span class="token operator">-</span>check<span class="token operator">-</span>aof redis<span class="token operator">-</span>check<span class="token operator">-</span>rdb redis<span class="token operator">-</span>cli redis<span class="token operator">-</span>server redis<span class="token operator">-</span>sentinel <span class="token operator">/</span>root<span class="token operator">/</span>redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token operator">/</span>bin<span class="token operator">/</span>
</code></pre> 
<ol start="4"><li>启动redis服务</li></ol> 
<pre><code class="prism language-java">cd <span class="token operator">/</span>root<span class="token operator">/</span>redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token operator">/</span>bin
<span class="token punctuation">.</span>/redis<span class="token operator">-</span>server <span class="token operator">/</span>root<span class="token operator">/</span>redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/bf/MytBBTrM_o.png" alt="在这里插入图片描述"><br> 启动后查看redis的进程，如下，可以看到6379端口就是我们运行的 redis 服务（配置文件中默认端口为6379）。<br> <img src="https://images2.imgbox.com/62/ef/uELKQYtA_o.png" alt="在这里插入图片描述"><br> 使用redis-cli命令连接客户端，如下<br> <img src="https://images2.imgbox.com/f8/db/PRhVLy0r_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Redis__67"></a>Redis 集群整体架构</h2> 
<h3><a id="sentinel_68"></a>这里我们采用的集群整体架构就是主从结构+哨兵（sentinel），实现容灾的自动切换，如下图所示：</h3> 
<p><img src="https://images2.imgbox.com/56/23/hZmGZbEv_o.png" alt="在这里插入图片描述"><br> 一个主节点（master）可拥有多个从节点（slave），从节点实现对主节点的复制，保证数据同步。而哨兵（sentinel）则对各节点进行监控，主要包括主节点存活检测、主从运行情况检测等，一旦主节点宕机，哨兵可自动进行故障转移 （failover）、主从切换。<br> 接下来就开始搭建这样一个集群，首先是主从结构，然后是哨兵模式，接着往下看。</p> 
<h2><a id="Redis__72"></a>Redis 主从配置及数据同步</h2> 
<p>在第一步 Redis 安装部署中我们已经启动了 Redis 服务，但是配置文件并没有做修改，因为主从配置主要就是通过修改配置文件来实现，所以 Redis 配置文件的修改统一在这里进行讲解。</p> 
<p>这里我创建了三台虚拟机来演示，分别按照上述安装方式安装好 Redis，三台虚拟机如下配置：</p> 
<table><thead><tr><th>ip</th><th>端口</th><th>角色</th></tr></thead><tbody><tr><td>192.168.231.130</td><td>6379</td><td>主机（master）</td></tr><tr><td>192.168.231.131</td><td>6380</td><td>从机（slave）</td></tr><tr><td>192.168.231.132</td><td>6381</td><td>从机（slave）</td></tr></tbody></table> 
<p>现在进入 etc 文件夹，使用vi redis.conf命令打开编辑 redis.conf 配置文件，如下</p> 
<ol><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> <img src="https://images2.imgbox.com/b9/7a/JrIV1RyH_o.png" alt="在这里插入图片描述"><br> 首先看一下redis.conf 配置文件中的各个参数，详解如下</li></ol> 
<pre><code class="prism language-java"># redis进程是否以守护进程的方式运行，yes为是，no为否<span class="token punctuation">(</span>不以守护进程的方式运行会占用一个终端<span class="token punctuation">)</span>。
daemonize no
# 指定redis进程的<span class="token constant">PID</span>文件存放位置
pidfile <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>redis<span class="token punctuation">.</span>pid
# redis进程的端口号
port <span class="token number">6379</span>
#是否开启保护模式，默认开启。要是配置里没有指定bind和密码。开启该参数后，redis只会本地进行访问，拒绝外部访问。要是开启了密码和bind，可以开启。否则最好关闭设置为no。
<span class="token keyword">protected</span><span class="token operator">-</span>mode yes
# 绑定的主机地址
bind <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
# 客户端闲置多长时间后关闭连接，默认此参数为<span class="token number">0</span>即关闭此功能
timeout <span class="token number">300</span>
# redis日志级别，可用的级别有debug<span class="token punctuation">.</span>verbose<span class="token punctuation">.</span>notice<span class="token punctuation">.</span>warning
loglevel verbose
# log文件输出位置，如果进程以守护进程的方式运行，此处又将输出文件设置为stdout的话，就会将日志信息输出到<span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span>里面去了
logfile stdout
# 设置数据库的数量，默认为<span class="token number">0</span>可以使用select <span class="token generics"><span class="token punctuation">&lt;</span>dbid<span class="token punctuation">&gt;</span></span>命令在连接上指定数据库id
databases <span class="token number">16</span>
# 指定在多少时间内刷新次数达到多少的时候会将数据同步到数据文件
save <span class="token generics"><span class="token punctuation">&lt;</span>seconds<span class="token punctuation">&gt;</span></span> <span class="token generics"><span class="token punctuation">&lt;</span>changes<span class="token punctuation">&gt;</span></span>
# 指定存储至本地数据库时是否压缩文件，默认为yes即启用存储
rdbcompression yes
# 指定本地数据库文件名
dbfilename dump<span class="token punctuation">.</span>db
# 指定本地数据问就按存放位置
dir <span class="token punctuation">.</span>/
# 指定当本机为slave服务时，设置master服务的<span class="token constant">IP</span>地址及端口，在redis启动的时候他会自动跟master进行数据同步
replicaof <span class="token generics"><span class="token punctuation">&lt;</span>masterip<span class="token punctuation">&gt;</span></span> <span class="token generics"><span class="token punctuation">&lt;</span>masterport<span class="token punctuation">&gt;</span></span>
# 当master设置了密码保护时，slave服务连接master的密码
masterauth <span class="token operator">&lt;</span>master<span class="token operator">-</span>password<span class="token operator">&gt;</span>
# 设置redis连接密码，如果配置了连接密码，客户端在连接redis是需要通过<span class="token constant">AUTH</span><span class="token generics"><span class="token punctuation">&lt;</span>password<span class="token punctuation">&gt;</span></span>命令提供密码，默认关闭
requirepass footbared
# 设置同一时间最大客户连接数，默认无限制。redis可以同时连接的客户端数为redis程序可以打开的最大文件描述符，如果设置 maxclients <span class="token number">0</span>，表示不作限制。当客户端连接数到达限制时，<span class="token class-name">Redis</span>会关闭新的连接并向客户端返回 max number of clients reached 错误信息
maxclients <span class="token number">128</span>
# 指定<span class="token class-name">Redis</span>最大内存限制，<span class="token class-name">Redis</span>在启动时会把数据加载到内存中，达到最大内存后，<span class="token class-name">Redis</span>会先尝试清除已到期或即将到期的<span class="token class-name">Key</span>。当此方法处理后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。<span class="token class-name">Redis</span>新的vm机制，会把<span class="token class-name">Key</span>存放内存，<span class="token class-name">Value</span>会存放在swap区
maxmemory<span class="token generics"><span class="token punctuation">&lt;</span>bytes<span class="token punctuation">&gt;</span></span>
# 指定是否在每次更新操作后进行日志记录，<span class="token class-name">Redis</span>在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为redis本身同步数据文件是按上面save条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为no。
appendonly no
# 指定跟新日志文件名默认为appendonly<span class="token punctuation">.</span>aof
appendfilename appendonly<span class="token punctuation">.</span>aof
# 指定更新日志的条件，有三个可选参数 <span class="token operator">-</span> no：表示等操作系统进行数据缓存同步到磁盘<span class="token punctuation">(</span>快<span class="token punctuation">)</span>，always：表示每次更新操作后手动调用<span class="token function">fsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>将数据写到磁盘<span class="token punctuation">(</span>慢，安全<span class="token punctuation">)</span>， everysec：表示每秒同步一次<span class="token punctuation">(</span>折衷，默认值<span class="token punctuation">)</span>；
appendfsync everysec
</code></pre> 
<p>1、主机配置<br> 主机（192.168.231.130）需要改动的配置如下所示，修改完毕后先按 esc ，然后:wq命令保存退出。</p> 
<pre><code class="prism language-java">bind：<span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
port：<span class="token number">6379</span>
<span class="token keyword">protected</span><span class="token operator">-</span>mode：no
daemonize：yes
logfile：<span class="token punctuation">.</span>/redis<span class="token punctuation">.</span>log
requirepass：pwdtest<span class="token annotation punctuation">@2019</span>
masterauth：pwdtest<span class="token annotation punctuation">@2019</span>
</code></pre> 
<ul><li>bind：0.0.0.0<br> Redis 默认只允许本机访问，把 bind 修改为 0.0.0.0 表示允许所有远程访问。如果想指定限制访问，可设置对应的 ip。</li><li>port：6379<br> 监听端口默认为6379，想改其他也行。</li><li>protected-mode：no<br> 关闭保护模式，可以外部访问。</li><li>daemonize：yes<br> 设置为后台启动。</li><li>logfile：./redis.log<br> redis 日志文件，生成后在 bin 目录下可找到。</li><li>requirepass：pwdtest@2019<br> 设置 redis 连接密码。</li><li>masterauth：pwdtest@2019<br> slave 服务连接 master 的密码。<br> 2、从机配置<br> 从机的配置和主机相似，相同的地方我就不再详解，不同的地方是需要使用replicaof指定主机（master）的IP地址和端口，需要注意的是老版本使用的是 slaveof，目前我使用的5.0.7版本要使用 replicaof ，如下。</li></ul> 
<pre><code class="prism language-java">bind：<span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
port：<span class="token number">6379</span>
<span class="token keyword">protected</span><span class="token operator">-</span>mode：no
daemonize：yes
logfile：<span class="token punctuation">.</span>/redis<span class="token punctuation">.</span>log
requirepass：pwdtest<span class="token annotation punctuation">@2019</span>
masterauth：pwdtest<span class="token annotation punctuation">@2019</span>
replicaof <span class="token number">192.168</span><span class="token number">.231</span><span class="token number">.130</span> <span class="token number">6379</span> 
</code></pre> 
<ul><li>replicaof 192.168.231.130 6379<br> 指定当本机为 slave 服务时，设置 master 服务的IP地址及端口，在 redis 启动的时候会自动跟 master 进行数据同步，所以两台从机都这样配置即可。</li></ul> 
<blockquote> 
 <p>注：由于我们搭建的集群需要自动容灾切换，主数据库可能会变成从数据库，所以三台机器上都需要同时设置 requirepass 和 masterauth 配置项。</p> 
</blockquote> 
<p>3、数据同步<br> 上面我们主从节点的配置文件配置好后，重启 redis 服务，进入 bin 目录即可查看配置文件中指定的redis.log日志文件。<br> <img src="https://images2.imgbox.com/12/d2/3BOkltnT_o.png" alt="在这里插入图片描述"><br> 下面我们需要设置一下防火墙，否则主从机之间无法同步数据，命令如下，这里根据自己设置的端口进行更改。</p> 
<pre><code class="prism language-java">firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>add<span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">6379</span><span class="token operator">/</span>tcp <span class="token operator">--</span>permanent <span class="token operator">--</span>zone<span class="token operator">=</span><span class="token keyword">public</span>
#重启防火墙<span class="token punctuation">(</span>修改配置后要重启防火墙<span class="token punctuation">)</span>
firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>reload
</code></pre> 
<p>至此主从结构搭建完毕，不出意外主从机已经可以数据同步，下面我们分别查看三台机器的信息，如下</p> 
<p>192.168.231.130 6379（主）<br> <img src="https://images2.imgbox.com/54/c3/pDheFFJi_o.png" alt="在这里插入图片描述"><br> 可以看到当前角色为主机（master），并且连接了另外两台从机（slave）。</p> 
<p>192.168.231.132 6380（从）<br> <img src="https://images2.imgbox.com/91/8c/dLCUwLEm_o.png" alt="在这里插入图片描述"><br> 可以看到当前角色为从机（slave），并指明了主机地址192.168.231.130和端口6379。</p> 
<p>192.168.231.131 6381（从）</p> 
<p><img src="https://images2.imgbox.com/3c/d0/80wZbigx_o.png" alt="在这里插入图片描述"><br> 可以看到当前角色为从机（slave），并指明了主机地址192.168.231.130和端口6379。</p> 
<p>4、主从验证<br> 接下来我们在主机（master）添加几条数据，看从机（slave）是否可以获取到，如果能获取，说明数据已经同步到了从机，主机添加数据，如下：<br> <img src="https://images2.imgbox.com/08/47/DhMXyZIZ_o.png" alt="在这里插入图片描述"><br> 两台从机已经获取到数据，证明主从搭建成功并可同步数据，如下所示：<br> <img src="https://images2.imgbox.com/45/d3/uRJPmvIc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5d/0d/KgvmhNUH_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Redis__208"></a>Redis 哨兵模式搭建</h2> 
<p>1、哨兵模式详解<br> <strong>Redis Sentinel</strong>是Redis 的高可用性解决方案，由一个或多个Sentinel（哨兵）实例组成。它可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，它的主要功能如下：</p> 
<ul><li>监控(Monitoring)：Sentinel会不断地检查你的主服务器和从服务器是否运作正常。</li><li>通知(Notification)：当被监控的某个 Redis 服务器出现问题时， Sentinel可以通过API向管理员或者其他应用程序发送通知。</li><li>故障迁移：当主服务器不能正常工作时，Sentinel会自动进行故障迁移，也就是主从切换。</li><li>统一的配置管理：连接者询问sentinel取得主从的地址。</li></ul> 
<h3><a id="_217"></a>哨兵原理</h3> 
<p>**<br> 7. 2222<br> 8. 2222</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cd480eee161eaeb9537e95945825099c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">efuse相关知识</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f56687f6f696fc080caef11cf93ac738/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">jvm的内存调优</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>