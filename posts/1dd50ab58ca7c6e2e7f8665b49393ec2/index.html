<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2311rust到27版本更新 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2311rust到27版本更新" />
<meta property="og:description" content="1.23 从Rust1.0开始,有叫AsciiExt的特征来提供u8,char,[u8]和str上的ASCII相关功能.要使用它,需要如下编写代码:
use std::ascii::AsciiExt; let ascii = &#39;a&#39;; let non_ascii = &#39; &#39;; let int_ascii = 97; assert!(ascii.is_ascii()); assert!(!non_ascii.is_ascii()); assert!(int_ascii.is_ascii()); 在Rust1.23中,现在直接在这些类上定义这些方法,因此不再需要导入trait.
#[allow(unused_imports)] use std::ascii::AsciiExt; //也可继续以前导入. 来抑制相关警告.
此外,新API:
现在从非原子类型实现各种std::sync::atomic类型.如,
let x = AtomicBool::from(true); ()现在实现了FromIterator&lt;()&gt;;
RwLock&lt;T&gt;已取消发送限制
货物特点
1,Cargo Check现在可检查你的单元测试.
2,cargo uninstall现在可在一个命令中卸载多个包.
1.24 rustup component add rustfmt-preview //格式组件. 有两点:首先,在此使用的是
rustup component add //而不是 cargo install 如果以前通过cargo install使用过rustfmt,应该先卸载它.
其次,这是一个预览.
增量编译 从Rust1.24开始,默认增量编译.
要在Cargo.toml中设置codegen-units为1(或16),以提升每一滴性能.
未定义行为.Rust一般努力减少未定义行为,在安全代码中没有未定义行为,在不安全代码中尽量少.
跨越FFI边界,恐慌(panic)!时,可调用UB.即:
extern &#34;C&#34; fn panic_in_ffi() { panic!(&#34;Test&#34;); } 在Rust1.24中,代码现在中止,而不是ub.
str::find,在&amp;str中查找给定的符:它现在快了10倍!这要归功于memchr.[u8]::contains也用它." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1dd50ab58ca7c6e2e7f8665b49393ec2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-15T23:10:45+08:00" />
<meta property="article:modified_time" content="2023-11-15T23:10:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2311rust到27版本更新</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="123_1"></a><code>1.23</code></h2> 
<p>从<code>Rust1.0</code>开始,有叫<code>AsciiExt</code>的<code>特征</code>来提供<code>u8,char,[u8]</code>和<code>str</code>上的<code>ASCII</code>相关功能.要使用它,需要如下<code>编写</code>代码:</p> 
<pre><code class="prism language-cpp">use std<span class="token double-colon punctuation">::</span>ascii<span class="token double-colon punctuation">::</span>AsciiExt<span class="token punctuation">;</span>
let ascii <span class="token operator">=</span> <span class="token char">'a'</span><span class="token punctuation">;</span>
let non_ascii <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
let int_ascii <span class="token operator">=</span> <span class="token number">97</span><span class="token punctuation">;</span>
assert<span class="token operator">!</span><span class="token punctuation">(</span>ascii<span class="token punctuation">.</span><span class="token function">is_ascii</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
assert<span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">!</span>non_ascii<span class="token punctuation">.</span><span class="token function">is_ascii</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
assert<span class="token operator">!</span><span class="token punctuation">(</span>int_ascii<span class="token punctuation">.</span><span class="token function">is_ascii</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在<code>Rust1.23</code>中,现在直接在这些类上定义<code>这些方法</code>,因此不再需要导入<code>trait</code>.</p> 
<pre><code class="prism language-cpp">#<span class="token punctuation">[</span><span class="token function">allow</span><span class="token punctuation">(</span>unused_imports<span class="token punctuation">)</span><span class="token punctuation">]</span>
use std<span class="token double-colon punctuation">::</span>ascii<span class="token double-colon punctuation">::</span>AsciiExt<span class="token punctuation">;</span>
<span class="token comment">//也可继续以前导入.</span>
</code></pre> 
<p>来<code>抑制</code>相关警告.</p> 
<p>此外,新<code>API</code>:<br> 现在从非原子类型<code>实现</code>各种<code>std::sync::atomic</code>类型.如,</p> 
<pre><code class="prism language-cpp">let x <span class="token operator">=</span> <span class="token class-name">AtomicBool</span><span class="token double-colon punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>()</code>现在实现了<code>FromIterator&lt;()&gt;</code>;<br> <code>RwLock&lt;T&gt;</code>已<code>取消</code>发送限制</p> 
<p>货物特点<br> 1,<code>Cargo Check</code>现在可检查你的单<code>元测试</code>.<br> 2,<code>cargo uninstall</code>现在可在<code>一个命令</code>中<code>卸载</code>多个包.</p> 
<h2><a id="124_33"></a><code>1.24</code></h2> 
<pre><code class="prism language-cpp">rustup component add rustfmt<span class="token operator">-</span>preview
<span class="token comment">//格式组件.</span>
</code></pre> 
<p>有两点:首先,在此使用的是</p> 
<pre><code class="prism language-cpp">rustup component add
<span class="token comment">//而不是</span>
cargo install
</code></pre> 
<p>如果以前通过<code>cargo install</code>使用过<code>rustfmt</code>,应该<code>先卸载</code>它.<br> 其次,这是一个预览.</p> 
<h2><a id="_48"></a>增量编译</h2> 
<p>从<code>Rust1.24</code>开始,默认<code>增量编译</code>.<br> 要在<code>Cargo.toml</code>中设置<code>codegen-units</code>为<code>1(或16)</code>,以提升每一滴性能.</p> 
<p>未定义行为.<code>Rust</code>一般努力减少未定义行为,在安全代码中没有未定义行为,在不安全代码中尽量少.<br> 跨越<code>FFI</code>边界,<code>恐慌(panic)!</code>时,可调用<code>UB</code>.即:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> fn <span class="token function">panic_in_ffi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    panic<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>Rust1.24</code>中,<code>代码</code>现在<code>中止</code>,而不是<code>ub</code>.<br> <code>str::find</code>,在<code>&amp;str</code>中查找给定的符:它现在快了<code>10</code>倍!这要归功于<code>memchr</code>.<code>[u8]::contains</code>也用它.<br> 此外,还稳定了一些新<code>API</code>:</p> 
<pre><code class="prism language-cpp">RefCell<span class="token double-colon punctuation">::</span>replace
RefCell<span class="token double-colon punctuation">::</span>swap
std<span class="token double-colon punctuation">::</span>sync<span class="token double-colon punctuation">::</span>atomic<span class="token double-colon punctuation">::</span>spin_loop_hint
</code></pre> 
<p>最后,现在可在<code>常量式</code>中使用<code>这些函数</code>,如,<code>初化静</code>:<br> 1,<code>Cell,RefCell</code>和<code>UnsafeCell</code>的新功能<br> 2,各种<code>原子</code>整数类型的<code>新函数</code><br> 3,<code>{integer}::min_value</code>和<code>max_value</code><br> 4,<code>MEM</code>的<code>size_of</code>和<code>align_of</code><br> 5,<code>ptr::null</code>和<code>null_mut</code></p> 
<h2><a id="1241_76"></a><code>1.24.1</code>稳定版</h2> 
<p>更改细节:<br> 1,通过<code>FFI</code>展开时不会中止(恢复<code>1.24.0</code>中添加的行为)<br> 2,在<code>窗口</code>上为<code>链接器</code>参数发出<code>UTF-16</code>文件<br> 3,使<code>错误索引</code>生成器再次工作<br> 4,如果要更新,<code>Cargo</code>在<code>窗口7</code>上发出警告.</p> 
<p><code>rlua</code>的异常.<br> <code>深入</code>挖掘后,发现了原因:<code>setjmp/longjmp</code>.由C标准库提供<code>这些函数</code>来处理错误.先调用<code>setjmp</code>,然后稍后再调用<code>longjmp</code>.</p> 
<p>这样,<code>控制流</code>返回到之前调用<code>setjmp</code>的位置.它一般用来<code>实现异常</code>,甚至协程.<code>Lua</code>的实现使用<code>setjmp/longjmp</code>来实现异常:<br> 与<code>C++</code>或<code>Java</code>不同,<code>C</code>语言不提供<code>异常</code>处理机制.为了改善,<code>Lua</code>使用了C语言中的<code>setjmp</code>工具,这导致了类似<code>异常处理</code>的机制.<br> 如果用<code>C++</code>编译<code>Lua</code>,则<code>更改代码</code>来使用真正的异常并不困难.</p> 
<p>所以,问题变成了:为什么会在<code>窗口</code>上破裂<br> <code>窗口</code>有个叫"<code>结构化异常处理</code>"(<code>SEH</code>)的概念.<code>窗口</code>使用<code>SEH</code>来实现<code>setjmp/longjmp</code>,因为<code>SEH</code>的整个<code>思想</code>是有统一的错误处理.<br> 类似,<code>C++</code>异常使用<code>SEH</code>,<code>Rust</code>恐慌也是.<br> 看看<code>rlua</code>的工作原理.<code>rlua</code>有个<code>protect_lua_call</code>内部函数,来调用<code>Lua</code>.它像这样<code>使用</code>:</p> 
<pre><code class="prism language-cpp"><span class="token function">protect_lua_call</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">|</span>state<span class="token operator">|</span> <span class="token punctuation">{<!-- --></span>
    ffi<span class="token double-colon punctuation">::</span><span class="token function">lua_newtable</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre> 
<p>即,<code>protect_lua_call</code>需要一些包含<code>闭包</code>的参数.把<code>此闭包</code>传递给<code>lua_pcall</code>,它再抓<code>传递</code>给它的代码(<code>该闭包</code>)可能抛的<code>longjmp</code>.</p> 
<p>即,<code>代码</code>现在像如下<code>伪码</code>:</p> 
<pre><code class="prism language-cpp"><span class="token function">protect_lua_call</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">|</span>state<span class="token operator">|</span> <span class="token punctuation">{<!-- --></span>
    let result <span class="token operator">=</span> panic<span class="token double-colon punctuation">::</span><span class="token function">catch_unwind</span><span class="token punctuation">(</span><span class="token operator">||</span> <span class="token punctuation">{<!-- --></span>
        ffi<span class="token double-colon punctuation">::</span><span class="token function">lua_newtable</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> result<span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        process<span class="token double-colon punctuation">::</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre> 
<p>之前,在讨论<code>setjmp/longjmp</code>时,说过在<code>Rust</code>代码中的问题是,它不处理<code>Rust</code>析构器.因此,在除<code>窗口</code>之外的所有平台上,上述<code>catch_unwind</code>恶作剧都被有效地忽略了,因此一切正常.</p> 
<p>但是,在<code>窗口</code>上,因为<code>setjmp/longjmp</code>和<code>Rust</code>的<code>panic</code>都使用<code>SEH</code>,因此抓住了<code>longjmp</code>,并<code>运行</code>新的<code>中止</code>代码!</p> 
<h2><a id="1250_117"></a><code>1.25.0</code>稳定版</h2> 
<p>已从<code>LLVM4</code>升级到了<code>LLVM6</code>.<br> <code>嵌套</code>导入组.</p> 
<pre><code class="prism language-cpp">use std<span class="token double-colon punctuation">::</span>fs<span class="token double-colon punctuation">::</span>File<span class="token punctuation">;</span>
use std<span class="token double-colon punctuation">::</span>io<span class="token double-colon punctuation">::</span>Read<span class="token punctuation">;</span>
use std<span class="token double-colon punctuation">::</span>path<span class="token double-colon punctuation">::</span><span class="token punctuation">{<!-- --></span>Path<span class="token punctuation">,</span> PathBuf<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>现在可这样写:</p> 
<pre><code class="prism language-cpp"><span class="token comment">//在一行上</span>
use std<span class="token double-colon punctuation">::</span><span class="token punctuation">{<!-- --></span>fs<span class="token double-colon punctuation">::</span>File<span class="token punctuation">,</span> io<span class="token double-colon punctuation">::</span>Read<span class="token punctuation">,</span> path<span class="token double-colon punctuation">::</span><span class="token punctuation">{<!-- --></span>Path<span class="token punctuation">,</span> PathBuf<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//更多空间</span>
use std<span class="token double-colon punctuation">::</span><span class="token punctuation">{<!-- --></span>
    fs<span class="token double-colon punctuation">::</span>File<span class="token punctuation">,</span>
    io<span class="token double-colon punctuation">::</span>Read<span class="token punctuation">,</span>
    path<span class="token double-colon punctuation">::</span><span class="token punctuation">{<!-- --></span>
        Path<span class="token punctuation">,</span>
        PathBuf
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>接受允许<code>设置</code>结构对齐方式<code>属性</code>的如下对齐:</p> 
<pre><code class="prism language-cpp">#<span class="token punctuation">[</span><span class="token function">repr</span><span class="token punctuation">(</span><span class="token function">align</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<p>示例:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Number</span><span class="token punctuation">(</span>i32<span class="token punctuation">)</span><span class="token punctuation">;</span>
assert_eq<span class="token operator">!</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>mem<span class="token double-colon punctuation">::</span>align_of<span class="token double-colon punctuation">::</span><span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
assert_eq<span class="token operator">!</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>mem<span class="token double-colon punctuation">::</span>size_of<span class="token double-colon punctuation">::</span><span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
#<span class="token punctuation">[</span><span class="token function">repr</span><span class="token punctuation">(</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">struct</span> <span class="token class-name">Align16</span><span class="token punctuation">(</span>i32<span class="token punctuation">)</span><span class="token punctuation">;</span>
assert_eq<span class="token operator">!</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>mem<span class="token double-colon punctuation">::</span>align_of<span class="token double-colon punctuation">::</span><span class="token operator">&lt;</span>Align16<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
assert_eq<span class="token operator">!</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>mem<span class="token double-colon punctuation">::</span>size_of<span class="token double-colon punctuation">::</span><span class="token operator">&lt;</span>Align16<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>1,<code>std::ptr::NonNull&lt;T&gt;</code>.此类型类似<code>*mut T</code>,但为非<code>null</code>且协变.<code>NonNull&lt;T&gt;</code>保证它不会为<code>null</code>,即<code>Option&lt;NonNull&lt;T&gt;&gt;</code>的大小与<code>*mut T</code>相同.</p> 
<p>如果要用<code>不安全</code>代码<code>构建</code>数据结构,<code>NonNull&lt;T&gt;</code>适合你!</p> 
<p>2,<code>libcore</code>获得了,包含以前仅在<code>libstd</code>中可用的<code>Duration</code>类型的<code>time</code>模块.<br> 此外,与<code>Duration</code>关联的<code>from_secs</code>和<code>from_millis</code>函数都变成了常量<code>函数</code>,允许按常量式创建<code>Duration</code>.</p> 
<p>3,<code>:cargo new</code>现在默认生成<code>二进制文件</code>,而不是<code>库</code>.可用<code>--lib/--bin</code>来设置.</p> 
<h2><a id="1260_164"></a><code>1.26.0</code>稳定版</h2> 
<h2><a id="impl_167"></a><code>impl</code>特征</h2> 
<p><code>impl Trait</code>来了!提供了叫<code>"存在类型"</code>的功能.核心想法是:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> impl Trait <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>此类型签名</code>,表示<code>"foo</code>是一个<code>无参</code>但返回实现<code>Trait</code>特征的类型"的函数.也即,不会告诉你<code>foo</code>的<code>具体返回类型</code>,只告诉你它实现了<code>指定特征</code>.</p> 
<p>与<code>特征对象</code>有何不同?</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Box<span class="token operator">&lt;</span>Trait<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>假设有个针对<code>i32</code>和<code>f32</code>实现的<code>Trait</code>特征:</p> 
<pre><code class="prism language-cpp">trait Trait <span class="token punctuation">{<!-- --></span>
    fn <span class="token function">method</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
impl Trait <span class="token keyword">for</span> i32 <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//实现在此</span>
<span class="token punctuation">}</span>
impl Trait <span class="token keyword">for</span> f32 <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//实现在此</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>考虑以下函数:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">5</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如何<code>填充</code>返回类型.以前,只能用<code>特征对象</code>:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Box<span class="token operator">&lt;</span>Trait<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Box</span><span class="token double-colon punctuation">::</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> as Box<span class="token operator">&lt;</span>Trait<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>但这引入了要<code>分配</code>的<code>Box</code>.在此<code>也没有</code>返回<code>动态数据</code>,所以也会影响<code>特征</code>对象的<code>动态调度</code>.因此,从<code>Rust1.26</code>开始,可这样写:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> impl Trait <span class="token punctuation">{<!-- --></span>
    <span class="token number">5</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这不会<code>创建</code>,<code>特征</code>对象,与写了<code>-&gt; i32</code>一样,但,只提及<code>Traits</code>部分.从而得到<code>静态调度</code>,但<code>隐藏</code>了真实类型.</p> 
<p><code>闭包</code>中有用.<code>Rust</code>中<code>闭包</code>都有个<code>唯一</code>的,不可写的但实现了<code>Fn</code>特征的<code>类型</code>.即,如果<code>函数</code>返回<code>闭包</code>,可如下:</p> 
<pre><code class="prism language-cpp"><span class="token comment">//以前</span>
fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token function">Fn</span><span class="token punctuation">(</span>i32<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> i32<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Box</span><span class="token double-colon punctuation">::</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//后</span>
fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> impl <span class="token function">Fn</span><span class="token punctuation">(</span>i32<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> i32 <span class="token punctuation">{<!-- --></span>
    <span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>没有<code>装箱(Box)</code>,没有<code>动态调度</code>.<code>返回</code>迭代器类似.迭代器不仅一般甚至包含嵌套<code>闭包</code>.如:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译时,报错:</p> 
<pre><code class="prism language-cpp">error<span class="token punctuation">[</span>E0308<span class="token punctuation">]</span><span class="token operator">:</span> mismatched types
 <span class="token operator">--</span><span class="token operator">&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token number">5</span>
  <span class="token operator">|</span>
<span class="token number">5</span> <span class="token operator">|</span> <span class="token operator">/</span>     vec<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token number">6</span> <span class="token operator">|</span> <span class="token operator">|</span>         <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">7</span> <span class="token operator">|</span> <span class="token operator">|</span>         <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">8</span> <span class="token operator">|</span> <span class="token operator">|</span>         <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token operator">|</span> <span class="token operator">|</span>_______________________________<span class="token operator">^</span> <span class="token function">expected</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> found <span class="token keyword">struct</span> `std<span class="token double-colon punctuation">::</span>iter<span class="token double-colon punctuation">::</span>Filter`
  <span class="token operator">|</span>
  <span class="token operator">=</span> note<span class="token operator">:</span> expected type `<span class="token punctuation">(</span><span class="token punctuation">)</span>`
              found type `std<span class="token double-colon punctuation">::</span>iter<span class="token double-colon punctuation">::</span>Filter<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>iter<span class="token double-colon punctuation">::</span>Map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vec<span class="token double-colon punctuation">::</span>IntoIter<span class="token operator">&lt;</span><span class="token punctuation">{<!-- --></span>integer<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>closure@src<span class="token operator">/</span>main<span class="token punctuation">.</span>
 rs<span class="token operator">:</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span> <span class="token number">7</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>closure@src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span> <span class="token number">8</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>`
</code></pre> 
<p>以前,必须<code>在此</code>使用<code>特征对象</code>,但现在可<code>简单</code>这样:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> impl Iterator<span class="token operator">&lt;</span>Item <span class="token operator">=</span> i32<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    vec<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>并<code>完成</code>它.同<code>未来</code>工作类似.<br> 注意,有时仍需要<code>特征对象</code>.仅当<code>函数</code>返回<code>单个类型</code>时,才能使用<code>impl Trait</code>;如果要<code>返回</code>多个,则需要动态调度.如:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token operator">:</span> i32<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Box<span class="token operator">&lt;</span>Iterator<span class="token operator">&lt;</span>Item <span class="token operator">=</span> i32<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{<!-- --></span>
    let iter <span class="token operator">=</span> vec<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Box</span><span class="token double-colon punctuation">::</span><span class="token keyword">new</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Box</span><span class="token double-colon punctuation">::</span><span class="token keyword">new</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为了使<code>语法</code>更对称,也可在<code>参数位置</code>使用<code>impl Traits</code>:</p> 
<pre><code class="prism language-cpp"><span class="token comment">//以前</span>
fn <span class="token generic-function"><span class="token function">foo</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">:</span> Trait<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>x<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//以后</span>
fn <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token operator">:</span> impl Trait<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<h2><a id="_282"></a>更好的匹配绑定</h2> 
<p>你是否曾经引用过<code>Option</code>,并试使用<code>match</code>?如,如下<code>代码</code>:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">hello</span><span class="token punctuation">(</span>arg<span class="token operator">:</span> <span class="token operator">&amp;</span>Option<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    match arg <span class="token punctuation">{<!-- --></span>
        <span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Hello {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
        None <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"你是谁?"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果试在<code>Rust1.25</code>中编译它,会得到错误:</p> 
<pre><code class="prism language-cpp">error<span class="token punctuation">[</span>E0658<span class="token punctuation">]</span><span class="token operator">:</span> non<span class="token operator">-</span>reference pattern used to match a <span class="token function">reference</span> <span class="token punctuation">(</span>see issue #<span class="token number">42640</span><span class="token punctuation">)</span>
 <span class="token operator">--</span><span class="token operator">&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token operator">:</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">9</span>
  <span class="token operator">|</span>
<span class="token number">6</span> <span class="token operator">|</span>         <span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Hello {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token operator">|</span>         <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> help<span class="token operator">:</span> consider <span class="token keyword">using</span> a reference<span class="token operator">:</span> `<span class="token operator">&amp;</span><span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>`
error<span class="token punctuation">[</span>E0658<span class="token punctuation">]</span><span class="token operator">:</span> non<span class="token operator">-</span>reference pattern used to match a <span class="token function">reference</span> <span class="token punctuation">(</span>see issue #<span class="token number">42640</span><span class="token punctuation">)</span>
 <span class="token operator">--</span><span class="token operator">&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token operator">:</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">9</span>
  <span class="token operator">|</span>
<span class="token number">7</span> <span class="token operator">|</span>         None <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"I don't know who you are."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token operator">|</span>         <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> help<span class="token operator">:</span> consider <span class="token keyword">using</span> a reference<span class="token operator">:</span> `<span class="token operator">&amp;</span>None`
</code></pre> 
<p>好的,当然.修改代码:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">hello</span><span class="token punctuation">(</span>arg<span class="token operator">:</span> <span class="token operator">&amp;</span>Option<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    match arg <span class="token punctuation">{<!-- --></span>
        <span class="token operator">&amp;</span><span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Hello {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>None <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"你是谁?"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加了编译器抱怨的<code>&amp;s</code>.再次试编译:</p> 
<pre><code class="prism language-cpp"> 错误`<span class="token punctuation">[</span>E0507<span class="token punctuation">]</span>`<span class="token operator">:</span>无法移出借用的内容
 <span class="token operator">--</span><span class="token operator">&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token operator">:</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">9</span>
  <span class="token operator">|</span>
<span class="token number">6</span> <span class="token operator">|</span>         <span class="token operator">&amp;</span><span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Hello {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token operator">|</span>         <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">^</span>
  <span class="token operator">|</span>         <span class="token operator">|</span>     <span class="token operator">|</span>
  <span class="token operator">|</span>         <span class="token operator">|</span>     hint<span class="token operator">:</span> to prevent move<span class="token punctuation">,</span> use `ref name` <span class="token operator">or</span> `ref mut name`
 <span class="token operator">|</span>无法移出借用的内容
</code></pre> 
<p>好的如下:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">hello</span><span class="token punctuation">(</span>arg<span class="token operator">:</span> <span class="token operator">&amp;</span>Option<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    match arg <span class="token punctuation">{<!-- --></span>
        <span class="token operator">&amp;</span><span class="token function">Some</span><span class="token punctuation">(</span>ref name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Hello {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>None <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"你是谁?"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>不得不添加两个<code>&amp;s</code>和一个<code>ref</code>.<br> 从<code>Rust1.26</code>开始,没有<code>&amp;s</code>和<code>ref</code>的<code>初始代码</code>,完全按你的期望<code>编译</code>和<code>执行</code>.总之,在<code>match</code>语句中自动<code>引用或解引用</code>.所以</p> 
<pre><code class="prism language-cpp">match arg <span class="token punctuation">{<!-- --></span>
    <span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Hello {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>编译器会自动引用<code>Some</code>,且因为借用了<code>name</code>,因此<code>name</code>也自动绑定为<code>ref name</code>.如果修改为:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">hello</span><span class="token punctuation">(</span>arg<span class="token operator">:</span> <span class="token operator">&amp;</span>mut Option<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    match arg <span class="token punctuation">{<!-- --></span>
        <span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> name<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">", world"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        None <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译器自动按可变<code>引用</code>借用,且<code>name</code>也按<code>ref mut</code>绑定.</p> 
<h2><a id="main_352"></a><code>main</code>也可返回结果</h2> 
<pre><code class="prism language-cpp">use std<span class="token double-colon punctuation">::</span>fs<span class="token double-colon punctuation">::</span>File<span class="token punctuation">;</span>
fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    let f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token double-colon punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"bar.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>导致了如下编写代码:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">run</span><span class="token punctuation">(</span>config<span class="token operator">:</span> Config<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span>Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
    <span class="token keyword">if</span> let <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"Application error: {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token double-colon punctuation">::</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>Rust1.26</code>中,现在可声明返回<code>Result</code>的<code>main</code>:</p> 
<pre><code class="prism language-cpp">use std<span class="token double-colon punctuation">::</span>fs<span class="token double-colon punctuation">::</span>File<span class="token punctuation">;</span>
fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>io<span class="token double-colon punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    let f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token double-colon punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"bar.txt"</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在正常<code>工作</code>!如果<code>main</code>返回错误,则<code>退出</code>并显示错误码,并<code>打印出</code>错误的调试表示.</p> 
<h2><a id="_383"></a>包含…=</h2> 
<p>可如下使用<code>..</code>:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> i in <span class="token number">1.</span><span class="token number">.3</span> <span class="token punctuation">{<!-- --></span>
    println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"i: {}"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这打印<code>i:1,</code>然后打印<code>i:2</code>.在<code>Rust1.26</code>中,你现在可如下创建<code>包含区间</code>:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> i in <span class="token number">1.</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token number">3</span> <span class="token punctuation">{<!-- --></span>
    println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"i: {}"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这打印如前<code>i:1</code>,然后打印<code>i:2</code>,但也打印<code>i:3</code>.</p> 
<pre><code class="prism language-cpp">fn <span class="token function">takes_u8</span><span class="token punctuation">(</span>x<span class="token operator">:</span> u8<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> i in <span class="token number">0.</span><span class="token number">.256</span> <span class="token punctuation">{<!-- --></span>
        println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"i: {}"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">takes_u8</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>编译时</code>收到提示:<br> 警告:<code>U8</code>文本出域</p> 
<pre><code class="prism language-cpp"> <span class="token operator">--</span><span class="token operator">&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token operator">:</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">17</span>
  <span class="token operator">|</span>
<span class="token number">6</span> <span class="token operator">|</span>     <span class="token keyword">for</span> i in <span class="token number">0.</span><span class="token number">.256</span> <span class="token punctuation">{<!-- --></span>
  <span class="token operator">|</span>                 <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span>
  <span class="token operator">|</span>
  <span class="token operator">=</span> note<span class="token operator">:</span> #<span class="token punctuation">[</span><span class="token function">warn</span><span class="token punctuation">(</span>overflowing_literals<span class="token punctuation">)</span><span class="token punctuation">]</span> on by <span class="token keyword">default</span>
</code></pre> 
<p>但是,可用<code>包含区间</code>来完成:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">takes_u8</span><span class="token punctuation">(</span>x<span class="token operator">:</span> u8<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> i in <span class="token number">0.</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token number">255</span> <span class="token punctuation">{<!-- --></span>
        println<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"i: {}"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">takes_u8</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>产生你可能期望的<code>256</code>行输出.</p> 
<h2><a id="_433"></a>基本切片模式</h2> 
<p>允许在<code>切片</code>上匹配.如:</p> 
<pre><code class="prism language-cpp">let arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
match arr <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"starts with one"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"starts with something else"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在本例中,知道<code>arr</code>的长度为<code>3</code>,因此需要在<code>[]</code>中加入3个项.不知道<code>长度</code>时,也可<code>匹配</code>:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    match s <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>128</code>位整数,<code>Rust</code>现在有<code>128</code>位整数!</p> 
<pre><code class="prism language-cpp">let x<span class="token operator">:</span> i128 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
let y<span class="token operator">:</span> u128 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>大小是<code>u64</code>的两倍,因此可容纳<code>更多值</code>.即,</p> 
<pre><code class="prism language-cpp">u128<span class="token operator">:</span> <span class="token number">0</span> <span class="token operator">-</span> <span class="token number">340</span><span class="token punctuation">,</span><span class="token number">282</span><span class="token punctuation">,</span><span class="token number">366</span><span class="token punctuation">,</span><span class="token number">920</span><span class="token punctuation">,</span><span class="token number">938</span><span class="token punctuation">,</span><span class="token number">463</span><span class="token punctuation">,</span><span class="token number">463</span><span class="token punctuation">,</span><span class="token number">374</span><span class="token punctuation">,</span><span class="token number">607</span><span class="token punctuation">,</span><span class="token number">431</span><span class="token punctuation">,</span><span class="token number">768</span><span class="token punctuation">,</span><span class="token number">211</span><span class="token punctuation">,</span><span class="token number">455</span>
i128<span class="token operator">:</span>  <span class="token number">170</span><span class="token punctuation">,</span><span class="token number">141</span><span class="token punctuation">,</span><span class="token number">183</span><span class="token punctuation">,</span><span class="token number">460</span><span class="token punctuation">,</span><span class="token number">469</span><span class="token punctuation">,</span><span class="token number">231</span><span class="token punctuation">,</span><span class="token number">731</span><span class="token punctuation">,</span><span class="token number">687</span><span class="token punctuation">,</span><span class="token number">303</span><span class="token punctuation">,</span><span class="token number">715</span><span class="token punctuation">,</span><span class="token number">884</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">728</span> <span class="token operator">-</span> <span class="token number">170</span><span class="token punctuation">,</span><span class="token number">141</span><span class="token punctuation">,</span><span class="token number">183</span><span class="token punctuation">,</span><span class="token number">460</span><span class="token punctuation">,</span><span class="token number">469</span><span class="token punctuation">,</span><span class="token number">231</span><span class="token punctuation">,</span><span class="token number">731</span><span class="token punctuation">,</span><span class="token number">687</span><span class="token punctuation">,</span><span class="token number">303</span><span class="token punctuation">,</span><span class="token number">715</span><span class="token punctuation">,</span><span class="token number">884</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">727</span>
</code></pre> 
<h2><a id="_463"></a>库稳定</h2> 
<p>稳定了比<code>File::open</code>和<code>io::Read::read_to_string</code>更方便的<code>fs::read_to_string</code>,它可轻松地一次读取<code>整个文件</code>到<code>内存</code>中:</p> 
<pre><code class="prism language-cpp">use std<span class="token double-colon punctuation">::</span>fs<span class="token punctuation">;</span>
use std<span class="token double-colon punctuation">::</span>net<span class="token double-colon punctuation">::</span>SocketAddr<span class="token punctuation">;</span>
let foo<span class="token operator">:</span> SocketAddr <span class="token operator">=</span> fs<span class="token double-colon punctuation">::</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token string">"address.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre> 
<p>现在,你可用<code>Debug</code>格式将数字格式化为十六进制:</p> 
<pre><code class="prism language-cpp">assert<span class="token operator">!</span><span class="token punctuation">(</span>format<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"{:02x?}"</span><span class="token punctuation">,</span> b<span class="token string">"Foo\0"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"[46, 6f, 6f, 00]"</span><span class="token punctuation">)</span>
</code></pre> 
<p>标准库中的<code>所有宏</code>现在都支持<code>尾随逗号</code>.</p> 
<h2><a id="1262_479"></a><code>1.26.2</code>稳定版</h2> 
<p>漏洞:允许同时对<code>路径</code>有两个<code>可变</code>借用.</p> 
<pre><code class="prism language-cpp">let mut foo <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
let bar <span class="token operator">=</span> <span class="token operator">&amp;</span>mut foo<span class="token punctuation">;</span>
match bar <span class="token punctuation">{<!-- --></span>
    <span class="token function">Some</span><span class="token punctuation">(</span>baz<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
         bar<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//不应允许,因为`baz`唯一引用`条形指针`.</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    None <span class="token operator">=</span><span class="token operator">&gt;</span> unreachable<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>1.26.2</code>拒绝上述代码,并<code>显示</code>以下错误消息:</p> 
<pre><code class="prism language-cpp">error<span class="token punctuation">[</span>E0499<span class="token punctuation">]</span><span class="token operator">:</span> cannot borrow `<span class="token operator">*</span>bar` as <span class="token keyword">mutable</span> more than once at a time
 <span class="token operator">--</span><span class="token operator">&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token operator">:</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">9</span>
  <span class="token operator">|</span>
<span class="token number">5</span> <span class="token operator">|</span>     <span class="token function">Some</span><span class="token punctuation">(</span>baz<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token operator">|</span>          <span class="token operator">--</span><span class="token operator">-</span> first <span class="token keyword">mutable</span> borrow occurs here
<span class="token number">6</span> <span class="token operator">|</span>         bar<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//不应被允许,因为`baz`有一个......</span>
  <span class="token operator">|</span>         <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> second <span class="token keyword">mutable</span> borrow occurs here
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">9</span> <span class="token operator">|</span> <span class="token punctuation">}</span>
  <span class="token operator">|</span>第一次借用到此结束
</code></pre> 
<p>错误:因为上一个错误而中止</p> 
<h2><a id="1270_507"></a><code>1.27.0</code>稳定版</h2> 
<p><code>SIMD</code><br> 好了,现在是大新闻:现已发布<code>SIMD</code>基础!<code>SIMD</code>代表"<code>单指令,多数据</code>".考虑如下此函数:</p> 
<pre><code class="prism language-cpp">pub fn <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">:</span> <span class="token operator">&amp;</span>mut <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span> in a<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token operator">*</span>a <span class="token operator">+</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在此,<code>取两个切片</code>,并把<code>数字</code>相加,在第三个切片中放置<code>结果</code>.<br> 但是,编译器可做得更好.<code>LLVM</code>一般会"<code>自动向量化</code>"代码.<br> 在<code>Rust1.27</code>中,添加了<code>std::arch</code>模块,允许<code>直接</code>使用这类指令,<code>不必</code>依赖编译器.此外,还包括一些<code>允许</code>根据<code>各种标准</code>选择指定实现的功能.如:</p> 
<pre><code class="prism language-cpp">#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span>target_arch <span class="token operator">=</span> <span class="token string">"x86"</span><span class="token punctuation">,</span> target_arch <span class="token operator">=</span> <span class="token string">"x86_64"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      target_feature <span class="token operator">=</span> <span class="token string">"avx2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>target_arch <span class="token operator">=</span> <span class="token string">"x86"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    use std<span class="token double-colon punctuation">::</span>arch<span class="token double-colon punctuation">::</span>x86<span class="token double-colon punctuation">::</span>_mm256_add_epi64<span class="token punctuation">;</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>target_arch <span class="token operator">=</span> <span class="token string">"x86_64"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    use std<span class="token double-colon punctuation">::</span>arch<span class="token double-colon punctuation">::</span>x86_64<span class="token double-colon punctuation">::</span>_mm256_add_epi64<span class="token punctuation">;</span>
    unsafe <span class="token punctuation">{<!-- --></span>
        <span class="token function">_mm256_add_epi64</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在此,根据目标机器,使用<code>cfg</code>标志选择正确的版本;在<code>x86</code>上,使用该版本,在<code>x86_64</code>上,使用其版本.也可在<code>运行时</code>选择:</p> 
<pre><code class="prism language-cpp">fn <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span>target_arch <span class="token operator">=</span> <span class="token string">"x86"</span><span class="token punctuation">,</span> target_arch <span class="token operator">=</span> <span class="token string">"x86_64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> is_x86_feature_detected<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"avx2"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> unsafe <span class="token punctuation">{<!-- --></span> <span class="token function">foo_avx2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">foo_fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在此,有<code>两个</code>版本函数:一个使用可让你执行<code>256</code>位操作的指定类型的<code>SIMD</code>功能的<code>AVX2</code>.<br> <code>is_x86_feature_detected!</code>宏生成代码,来检测<code>CPU</code>是否支持<code>AVX2</code>,如果支持,则调用<code>foo_avx2</code>函数.如果没有,则回退到非<code>AVX</code>实现,<code>foo_fallback</code>.</p> 
<p><code>std::arch</code>专门用来<code>构建</code>这类工作.并在高级上用稳定<code>std::simd</code>的模块.<br> 如下,没有<code>simd</code>.</p> 
<pre><code class="prism language-cpp">let lots_of_3s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">123.456f</span>32<span class="token punctuation">;</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>v<span class="token operator">|</span> <span class="token punctuation">{<!-- --></span>
        <span class="token number">9.0</span> <span class="token operator">*</span> v<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4.0</span> <span class="token operator">-</span> <span class="token number">2.0</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>collect<span class="token double-colon punctuation">::</span><span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>f32<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>要用<code>SIMD</code>,请更改为:</p> 
<pre><code class="prism language-cpp">let lots_of_3s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">123.456f</span>32<span class="token punctuation">;</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">simd_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">simd_map</span><span class="token punctuation">(</span><span class="token function">f32s</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">|</span>v<span class="token operator">|</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">f32s</span><span class="token punctuation">(</span><span class="token number">9.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> v<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rsqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">f32s</span><span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">f32s</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">scalar_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>它几乎是一样的:<code>simd_iter</code>而不是<code>iter</code>,<code>simd_map</code>而不是<code>map</code>,<code>f32s(2.0)</code>而不是<code>2.0</code>.但是,你获得为你生成的<code>SIMD</code>化版本.</p> 
<h2><a id="dyn_571"></a><code>dyn</code>特征</h2> 
<p>给定<code>Foo</code>特征,如下是一个<code>特征对象</code>:</p> 
<pre><code class="prism language-cpp">Box<span class="token operator">&lt;</span>Foo<span class="token operator">&gt;</span>
</code></pre> 
<p>在<code>Rust1.27</code>中,稳定了一个新的<code>dyn Trait</code>语法.<code>特征对象</code>现在如下:</p> 
<pre><code class="prism language-cpp"><span class="token comment">//旧`=&gt;`新</span>
Box<span class="token operator">&lt;</span>Foo<span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Box<span class="token operator">&lt;</span>dyn Foo<span class="token operator">&gt;</span>
<span class="token operator">&amp;</span>Foo <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>dyn Foo
<span class="token operator">&amp;</span>mut Foo <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>mut dyn Foo
</code></pre> 
<p>同样,对其他指针类型,<code>Arc&lt;Foo&gt;</code>现在是<code>Arc&lt;dyn Foo&gt;</code>等.</p> 
<p>开发了可<code>自动升级</code>代码到<code>更新</code>习惯用语的<code>rustfix</code>的工具.</p> 
<h2><a id="must_use_589"></a><code>#[must_use]</code>函数</h2> 
<p>最后,升级了<code>#[must_use]</code>属性:现在可用于函数.<br> 以前,它仅适合<code>Result&lt;T,E&gt;</code>等类型.但是现在,可<code>这样</code>:</p> 
<pre><code class="prism language-cpp">#<span class="token punctuation">[</span>must_use<span class="token punctuation">]</span>
fn <span class="token keyword">double</span><span class="token punctuation">(</span>x<span class="token operator">:</span> i32<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> i32 <span class="token punctuation">{<!-- --></span>
    <span class="token number">2</span> <span class="token operator">*</span> x
<span class="token punctuation">}</span>
fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//警告:必须使用的`"double"`的未使用返回值</span>
    let _ <span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//(无警告)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>稳定了几个新<code>API</code>:</p> 
<pre><code class="prism language-cpp">DoubleEndedIterator<span class="token double-colon punctuation">::</span>rfind
DoubleEndedIterator<span class="token double-colon punctuation">::</span>rfold
DoubleEndedIterator<span class="token double-colon punctuation">::</span>try_rfold
Duration<span class="token double-colon punctuation">::</span>from_micros
Duration<span class="token double-colon punctuation">::</span>from_nanos
Duration<span class="token double-colon punctuation">::</span>subsec_micros
Duration<span class="token double-colon punctuation">::</span>subsec_millis
HashMap<span class="token double-colon punctuation">::</span>remove_entry
Iterator<span class="token double-colon punctuation">::</span>try_fold
Iterator<span class="token double-colon punctuation">::</span>try_for_each
NonNull<span class="token double-colon punctuation">::</span>cast
Option<span class="token double-colon punctuation">::</span>filter
String<span class="token double-colon punctuation">::</span>replace_range
Take<span class="token double-colon punctuation">::</span>set_limit
hint<span class="token double-colon punctuation">::</span>unreachable_unchecked
os<span class="token double-colon punctuation">::</span>unix<span class="token double-colon punctuation">::</span>process<span class="token double-colon punctuation">::</span>parent_id
process<span class="token double-colon punctuation">::</span>id
ptr<span class="token double-colon punctuation">::</span>swap_nonoverlapping
slice<span class="token double-colon punctuation">::</span>rsplit_mut
slice<span class="token double-colon punctuation">::</span>rsplit
slice<span class="token double-colon punctuation">::</span>swap_with_slice
</code></pre> 
<p><code>Cargo</code>更改<code>目标目录</code>,用<code>--target-dir</code>标志.<br> <code>Cargo</code>试自动发现项目中的<code>测试,示例和二进制文件</code>.但是,有时需要显式配置.</p> 
<h2><a id="_631"></a>快速摘要:</h2> 
<p>1,<code>RLS</code>不再<code>干扰</code>命令行生成<br> 2,有时,<code>Rustfmt</code>停止了<code>错误</code>文本格式<br> 3,不再允许通过非终止<code>Trait</code>的<code>impl Trait</code>返回<code>main</code>.<br> 4,对<code>implTrait</code>类型的<code>方法参数</code>,不再适合<code>::&lt;&gt;(turbofish)</code><br> 5,<code>NaN&gt;NaN</code>在<code>常量</code>环境中,不再返回<code>true</code>.<br> 6,<code>Rustup</code>应该不会再因为<code>缺少文档</code>而失败<br> 7,如果代码继续编译,则只有更改<code>浮点比较</code>,可能会改变行为.</p> 
<pre><code class="prism language-cpp">fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>io<span class="token double-colon punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如下.</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Foo</span><span class="token punctuation">;</span>
impl Foo <span class="token punctuation">{<!-- --></span>
    fn <span class="token function">bar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">,</span> _arg<span class="token operator">:</span> impl Copy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
fn <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Foo<span class="token punctuation">.</span>bar<span class="token double-colon punctuation">::</span><span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>浮点比较</code>:</p> 
<pre><code class="prism language-cpp">use std<span class="token double-colon punctuation">::</span>f64<span class="token double-colon punctuation">::</span>NAN<span class="token punctuation">;</span>
<span class="token keyword">const</span> FOO<span class="token operator">:</span> <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>f64<span class="token double-colon punctuation">::</span>NAN <span class="token operator">&gt;=</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>f64<span class="token double-colon punctuation">::</span>NAN<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">On <span class="token number">1.26</span><span class="token punctuation">.</span><span class="token number">0</span></span></span>
assert_eq<span class="token operator">!</span><span class="token punctuation">(</span>FOO<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">On <span class="token number">1.26</span><span class="token punctuation">.</span><span class="token number">1</span></span></span>
assert_eq<span class="token operator">!</span><span class="token punctuation">(</span>FOO<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//假</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d951d3a7b71a5fbbca0b00cccd0e5227/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何在GitHub中下载YOLOv5</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/96199c9b573322abf4b1a6eca406fcde/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">词云库wordcloud的安装和应用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>