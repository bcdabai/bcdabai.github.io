<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>私有镜像仓库 Harbor 安装和使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="私有镜像仓库 Harbor 安装和使用" />
<meta property="og:description" content="介绍 我们如果需要部署一个私有镜像仓库来使用，最简单的就是 registry ，一行命令就可以运行在 Docker 中，但功能也比较弱，如果想要私有镜像仓库功能更丰富些，可以使用 Harbor 。
本文简单介绍下 Harbor 的安装和使用。
环境 服务器：CentOS 7 ，Harbor 部署在内网，通过 nginx 反向代理发布到外网使用
Harbor：2.9.1
docker：23.0.5
安装 1、如果没有安装 wget ，先执行下面命令安装：
yum install -y wget 2、下载包：
wget https://github.com/goharbor/harbor/releases/download/v2.9.1/harbor-offline-installer-v2.9.1.tgz 如果无法通过 wget 进行下载，可以直接到 Github 网站：https://github.com/goharbor/harbor/releases/ 进行下载，然后拷贝到服务器中：
3、执行下面命令进行解压：
tar -xvf harbor-offline-installer-v2.9.1.tgz 4、执行下面命令新建目录，并将程序文件复制到目录中：
mkdir /opt/harbor mv harbor/* /opt/harbor cd /opt/harbor 5、修改 Harbor 配置文件：
cp -ar harbor.yml.tmpl harbor.yml vi harbor.yml hostname：如果只是内网访问，设置为内网 IP，如果需要外网访问，就必须设置为外网域名或 IP
port：Web 访问的端口
6、编辑完配置文件，接下来在 harbor 目录下安装 Harbor。先进行预处理：
./prepare 7、执行下面命令进行安装：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/310c9b7d16c2066b0962a707ef971d16/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-23T08:00:21+08:00" />
<meta property="article:modified_time" content="2024-01-23T08:00:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">私有镜像仓库 Harbor 安装和使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <h3></h3> 
 <p style="text-align:center;"><img src="https://images2.imgbox.com/ce/fa/zXiJfo12_o.jpg" alt="6ca3d23d1288f471b83dca919f97fc08.jpeg"></p> 
 介绍 
  
 <p>我们如果需要部署一个私有镜像仓库来使用，最简单的就是 registry ，一行命令就可以运行在 Docker 中，但功能也比较弱，如果想要私有镜像仓库功能更丰富些，可以使用 Harbor 。</p> 
 <p>本文简单介绍下 Harbor 的安装和使用。</p> 
 <h3>环境</h3> 
 <ul><li><p>服务器：CentOS 7 ，Harbor 部署在内网，通过 nginx 反向代理发布到外网使用</p></li><li><p>Harbor：2.9.1</p></li><li><p>docker：23.0.5</p></li></ul> 
 <h3>安装</h3> 
 <p>1、如果没有安装 wget ，先执行下面命令安装：</p> 
 <pre class="has"><code class="language-go">yum install -y wget</code></pre> 
 <p>2、下载包：</p> 
 <pre class="has"><code class="language-go">wget https://github.com/goharbor/harbor/releases/download/v2.9.1/harbor-offline-installer-v2.9.1.tgz</code></pre> 
 <p>如果无法通过 wget 进行下载，可以直接到 Github 网站：https://github.com/goharbor/harbor/releases/ 进行下载，然后拷贝到服务器中：</p> 
 <img src="https://images2.imgbox.com/51/46/3R4Huy6Y_o.jpg" alt="c9c0e329e78bcda9886591e619b7807f.jpeg"> 
 <p>3、执行下面命令进行解压：</p> 
 <pre class="has"><code class="language-go">tar -xvf harbor-offline-installer-v2.9.1.tgz</code></pre> 
 <img src="https://images2.imgbox.com/ec/10/jTR6loob_o.jpg" alt="1c5ad4f0222d63f97ad7f4dc3826a868.jpeg"> 
 <p>4、执行下面命令新建目录，并将程序文件复制到目录中：</p> 
 <pre class="has"><code class="language-go">mkdir /opt/harbor
mv harbor/* /opt/harbor
cd /opt/harbor</code></pre> 
 <p>5、修改 Harbor 配置文件：</p> 
 <pre class="has"><code class="language-go">cp -ar harbor.yml.tmpl harbor.yml
vi harbor.yml</code></pre> 
 <img src="https://images2.imgbox.com/01/c6/iCQTrjuJ_o.jpg" alt="f99be7718caaf93d76e46d5d0fafbbe2.jpeg"> 
 <ul><li><p>hostname：如果只是内网访问，设置为内网 IP，如果需要外网访问，就必须设置为外网域名或 IP</p></li><li><p>port：Web 访问的端口</p></li></ul> 
 <p>6、编辑完配置文件，接下来在 <code>harbor</code> 目录下安装 Harbor。先进行预处理：</p> 
 <pre class="has"><code class="language-go">./prepare</code></pre> 
 <img src="https://images2.imgbox.com/dd/83/TStv4bFA_o.jpg" alt="51961f87b4606544d2d57f33350e8a38.jpeg"> 
 <p>7、执行下面命令进行安装：</p> 
 <pre class="has"><code class="language-go">./install.sh</code></pre> 
 <img src="https://images2.imgbox.com/81/1c/xsRnqiIs_o.jpg" alt="b9f806c13da3155614826f6a79dd2793.jpeg"> 
 <p>8、稍等一会，执行 <code>docker-compose ps</code> ,如果所有容器的状态都是 healthy ，说明正常：</p> 
 <img src="https://images2.imgbox.com/95/f6/Kkn8oTYM_o.jpg" alt="b6a38069d1d2522de41ac6bd38a5678e.jpeg"> 
 <p>9、登录后界面如下：</p> 
 <img src="https://images2.imgbox.com/67/4f/rQOMbofn_o.jpg" alt="284ad50ed3a11bf850dc79f59fb364f5.jpeg"> 
 <h3>问题</h3> 
 <p>1、内网不能登录</p> 
 <p>安装完成后，在外网使用 docker login 发现不能正常登录，于是先进内网进行验证，发现内网也不能登陆，提示信息如下：</p> 
 <blockquote> 
   
  <p>[root@localhost data]# docker login 172.16.10.103:9998 Username: admin Password: Error response from daemon: Get "https://172.16.10.103:9998/v2/": http: server gave HTTP response to HTTPS client</p> 
 </blockquote> 
 <p>需要将内网服务器 IP 和端口配置到 daemon.json 文件中，执行下面命令进行配置：</p> 
 <pre class="has"><code class="language-go">sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'
&gt; {
&gt; "insecure-registries":["172.16.10.103:9998"]
&gt; }
&gt; EOF</code></pre> 
 <p>然后执行下面命令重启生效：</p> 
 <pre class="has"><code class="language-go">sudo systemctl daemon-reload
sudo systemctl restart docker</code></pre> 
 <p>再次登录：</p> 
 <blockquote> 
   
  <p>[root@localhost docker]# docker login 172.16.10.103:9998 Username: admin Password: WARNING! Your password will be stored unencrypted in /root/.docker/config.json. Configure a credential helper to remove this warning. See https://docs.docker.com/engine/reference/commandline/login/#credentials-store</p> 
  <p>Login Succeeded</p> 
 </blockquote> 
 <p>这个不仅仅是内网，哪台机器需要进行登录操作，都需要进行上面的配置。</p> 
 <p>2、外网不能登录</p> 
 <p>当内网正常后，发现外网依然不能正常登录，提示如下：</p> 
 <blockquote> 
   
  <p>fengwei@fengweideMBP ~ % docker login hub.fwhyy.com:1234<br>Username: admin Password: Error response from daemon: Get "http://hub.fwhyy.com:1234/v2/": Get "http://172.16.10.103:9998/service/token?account=admin&amp;client_id=docker&amp;offline_token=true&amp;service=harbor-registry": context deadline exceeded (Client.Timeout exceeded while awaiting headers) (Client.Timeout exceeded while awaiting headers)</p> 
 </blockquote> 
 <p>解决这个问题需要修改 harbor.yml 配置，将 hostname 修改为外网的 IP 或域名（不需要加端口）：</p> 
 <img src="https://images2.imgbox.com/99/9a/ccnFln81_o.jpg" alt="370fd0adc7d337037865ef26a6a9d28f.jpeg"> 
 <p>将 external_url 修改为外网访问的地址（需要加上端口）：</p> 
 <img src="https://images2.imgbox.com/77/38/pUhCoE7b_o.jpg" alt="a0df29b398478c486d8324f12e3014ac.jpeg"> 
 <p>修改完后需要重启 Harbor，执行下面命令进行重启：</p> 
 <pre class="has"><code class="language-go">cd /opt/harbor
./prepare
docker-compose down -v
docker-compose up -d</code></pre> 
 <p>外网服务器的 nginx 配置如下：</p> 
 <pre class="has"><code class="language-go">server {
    listen       1234;
    server_name  hub.fwhyy.com;
    client_max_body_size 2000M;
    gzip  on;

   location / {
      proxy_pass http://172.16.10.103:9998;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrate";


      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header referer $http_referer;
      proxy_set_header X-Forwarded-Proto $scheme;
   }
   
     location /v2/ {
      proxy_pass http://172.16.10.103:9998/v2/;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrate";

      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header referer $http_referer;
      proxy_set_header X-Forwarded-Proto $scheme;
   }
   
     location /service/ {
      proxy_pass http://172.16.10.103:9998/service/;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrate";
        
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header referer $http_referer;
      proxy_set_header X-Forwarded-Proto $scheme;
   }


   error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}</code></pre> 
 <h3>使用</h3> 
 <p>Harbor 里功能比较多，常用的有项目、用户管理、项目定额。</p> 
 <ul><li><p>项目：可以针对不同的项目单独创建，每个项目都有自己的镜像地址</p></li><li><p>用户管理：可以维护用户，不同的项目可以设置不同的维护人员</p></li><li><p>项目定额：设置项目对应的镜像仓库最大空间容量</p></li></ul> 
 <p>下面就按照步骤将一个镜像推送到 Harbor 中。</p> 
 <p>1、在用户管理中创建名称为 images_admin 的用户：</p> 
 <img src="https://images2.imgbox.com/01/3b/v2U5PGPW_o.jpg" alt="c1000c7ed69c5671759de3ef00f9bddb.jpeg"> 
 <p>2、在项目中创建名称为 fw 的项目，并添加 images_admin 为项目的维护人员：</p> 
 <img src="https://images2.imgbox.com/6f/9d/3EstRADO_o.jpg" alt="c7c0fd9ddb5a7519f8254a1f109544de.jpeg"> 
 <p>3、在项目定额中设置项目的配额大小为 2GB：</p> 
 <img src="https://images2.imgbox.com/2e/a5/Y0R4LGX0_o.jpg" alt="f6a2b560cc39766799da29a781f90a75.jpeg"> 
 <p>4、先以一个 nginx 镜像为例，直接推送试试，命令如下：</p> 
 <pre class="has"><code class="language-go">docker tag nginx:latest hub.fwhyy.com:1234/fw/nginx:latest
docker push hub.fwhyy.com:1234/fw/nginx:latest</code></pre> 
 <p>因为没有登录，会提示没有权限推送：</p> 
 <blockquote> 
   
  <p>The push refers to repository [hub.fwhyy.com:1234/fw/nginx] b074db3b55e1: Preparing e50c68532c4a: Preparing f6ba584ca3ec: Preparing 01aaa195cdad: Preparing 2a13e6a7cca6: Preparing 370869eba6e9: Waiting 7292cf786aa8: Waiting unauthorized: unauthorized to access repository: fw/nginx, action: push: unauthorized to access repository: fw/nginx, action: push</p> 
 </blockquote> 
 <p>5、使用下面命令进行登录后再进行推送：</p> 
 <pre class="has"><code class="language-go">docker login hub.fwhyy.com:1234
# 输入用户名密码
docker tag nginx:latest hub.fwhyy.com:1234/fw/nginx:latest
docker push hub.fwhyy.com:1234/fw/nginx:latest</code></pre> 
 <p>登录后，就可以正常推送了，登录进入系统，可以看到在项目的镜像仓库中已经可以看到了：</p> 
 <img src="https://images2.imgbox.com/90/b5/1qHbz3rJ_o.jpg" alt="c46ab392b03a97db25fd05eb932c789f.jpeg"> 
 <hr> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8d486ae4af355635eace78714b349b5e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Boot3整合Druid(监控功能)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6b2fa4db103c9d39105c76586c5ba599/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深入浅出LLamaSharp：打造智能.NET应用，不需GPU也能玩转LLaMA模型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>