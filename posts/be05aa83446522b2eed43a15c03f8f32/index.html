<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DM-设置定期收集统计信息作业 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DM-设置定期收集统计信息作业" />
<meta property="og:description" content="当你要根据表的变动情况进行统计信息的收集，可以设置定时作业进行收集。 1.创建临时表
--记录最大trxid
create table trxid_jilu (OWNER VARCHAR2(20),TABLE_NAME VARCHAR2(20),trx_id int,table_cnt int,riqi date);
--记录数据变化
create table gather_tab (OWNER VARCHAR2(20),TABLE_NAME VARCHAR2(20),table_cnt_bh int,table_cnt int,flag_gather int default 0);
2.插入数据，需要保留前一天的max(trxid),获取当天的max（trxid），当天的全表数据量，可以在当天晚上进行定时收集，将以下脚本放到定时作业里
begin
for tb in
(
select
owner,
table_name
from
dba_tables
where owner not like &#39;SYS%&#39;
and owner&lt;&gt;&#39;CTISYS&#39;
and table_name not like &#39;GATHER_TAB%&#39;
)
loop
execute immediate &#39;insert into trxid_jilu(OWNER,TABLE_NAME,trx_id,table_cnt,riqi) select &#39;&#39;&#39;||tb.OWNER||&#39;&#39;&#39;,&#39;&#39;&#39;||tb.TABLE_NAME||&#39;&#39;&#39;,
(select max(trxid) from &#34;&#39;||tb.owner||&#39;&#34;.&#34;&#39;||tb.table_name||&#39;&#34;),
(select count(*) from &#34;&#39;||tb.owner||&#39;&#34;.&#34;&#39;||tb.table_name||&#39;&#34;),SYSDATE from dual&#39;;
commit;
--对于前天收集的数据清理，保留当前的max（trxid）
execute immediate &#39;delete from trxid_jilu where riqi=to_char(sysdate-2,&#39;&#39;yyyy-mm-dd&#39;&#39;)&#39;;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/be05aa83446522b2eed43a15c03f8f32/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-17T17:06:43+08:00" />
<meta property="article:modified_time" content="2022-01-17T17:06:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DM-设置定期收集统计信息作业</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>       当你要根据表的变动情况进行统计信息的收集，可以设置定时作业进行收集。  </p> 
<p>1.创建临时表<br> --记录最大trxid<br> create table trxid_jilu (OWNER VARCHAR2(20),TABLE_NAME VARCHAR2(20),trx_id int,table_cnt int,riqi date);<br> --记录数据变化<br> create table gather_tab (OWNER VARCHAR2(20),TABLE_NAME VARCHAR2(20),table_cnt_bh int,table_cnt int,flag_gather int default 0);</p> 
<p><br> 2.插入数据，需要保留前一天的max(trxid),获取当天的max（trxid），当天的全表数据量，可以在当天晚上进行定时收集，将以下脚本放到定时作业里<br> begin<br>   for tb in<br>         (<br>                 select<br>                         owner,<br>                         table_name<br>                 from<br>                         dba_tables<br>                where  <br>                       owner not like 'SYS%'<br>                    and owner&lt;&gt;'CTISYS'<br>                   and table_name not like 'GATHER_TAB%'<br>         )<br>         loop<br>                 execute immediate 'insert into trxid_jilu(OWNER,TABLE_NAME,trx_id,table_cnt,riqi) <br>                 select '''||tb.OWNER||''','''||tb.TABLE_NAME||''',<br>                 (select max(trxid) from "'||tb.owner||'"."'||tb.table_name||'"),<br>                 (select count(*) from "'||tb.owner||'"."'||tb.table_name||'"),SYSDATE from dual';<br>                 commit;<br>                 --对于前天收集的数据清理，保留当前的max（trxid）<br>                 execute immediate 'delete from trxid_jilu where riqi=to_char(sysdate-2,''yyyy-mm-dd'')';<br>                 commit;<br>       end loop;<br> end;</p> 
<p>3.收集统计信息，创建一个存储过程</p> 
<p>create or replace procedure pro_gather() as<br> begin <br>    --清空临时表数据<br>     execute immediate 'truncate table gather_tab';<br>         for tb in<br>         (<br>                 select * from trxid_jilu where riqi=to_char(sysdate-1,'yyyy-mm-dd') <br>         )<br>         loop<br>                 --更新gather_tab的table_cnt_bh<br>                execute immediate 'insert into gather_tab(OWNER,TABLE_NAME,table_cnt_bh,table_cnt) <br>                 select '''||tb.OWNER||''','''||tb.TABLE_NAME||''',<br>                 (select count(*) from "'||tb.owner||'"."'||tb.table_name||'" where trxid &gt;'||tb.trx_id||'),<br>                 (select count(*) from "'||tb.owner||'"."'||tb.table_name||'") from dual';<br>                 commit;<br>        --表的数据量不为0，防止除0报错<br>         if tb.table_cnt&lt;&gt;0 then<br>          for tb1 in<br>         (<br>                 select * from gather_tab <br>         )<br>         loop<br>         --表数据变化超过20%,收集统计信息<br>               if (tb1.table_cnt_bh/tb1.table_cnt)*100&gt;20 then<br>                        DBMS_STATS.GATHER_TABLE_STATS(OWNNAME=&gt;tb1.owner, TABNAME=&gt;tb1.table_name, ESTIMATE_PERCENT=&gt;100);<br>                      --更新gather_tab的flag_gather作为收集统计信息的标识，以便后续人工校验<br>                        execute immediate 'update gather_tab set flag_gather=1 where owner='''||tb1.owner||''' and table_name='''||tb1.table_name||'''';<br>                        commit;<br>               end if;<br>         end loop;<br>         else <br>        exit;<br>         end if;<br>          end loop;<br> end;<br> 定时作业里调用这个存储过程。</p> 
<p>4.半夜收集统计信息是最佳事情，到了白天业务高峰期，需要停掉收集统计信息作业，这个脚本也可以设置一个定时作业进行执行。<br> declare<br>     v_flag int;<br> begin<br>    select count(*) into v_flag from v$sessions where state='ACTIVE' and sql_text like '%PRO_GATHER%';<br>    if v_flag&lt;&gt;0 then<br>       for tb in<br>   (  <br>       select sess_id from v$sessions where state='ACTIVE' and sql_text like '%PRO_GATHER%'<br>   ) <br>    loop<br>        call sp_close_session(tb.sess_id);<br>     end loop;<br>     end if;<br> end;</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/be04a18e37e225b9bc64f7c9d7b358fb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux中tar压缩命令详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6dc5456d2e8e6bcfc2c54bc8229716d5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Pyinstaller打包成使用了pyonnet包的exe时报错System.IO.FileNotFoundException:Unable to find assembly ‘XXX.dll‘。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>