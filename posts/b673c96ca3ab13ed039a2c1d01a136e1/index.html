<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Xilinx FPGA Partial Reconfiguration 部分重配置 详细教程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Xilinx FPGA Partial Reconfiguration 部分重配置 详细教程" />
<meta property="og:description" content="Partial Reconfiguration（部分重配置）在现在的FPGA应用中越来越常见，我们这次的教程以Project模式为例来说明部分重配置的操作过程。
这里我们使用的Vivado版本是2017.2，使用的例程是Vivado自带的wavegen工程，并在工程中增加一个计数器模块，如下图所示
这个模块的代码也很简单，就是加1计数
module count_add( input clk, input rst, output reg [7:0] res ); always @ (posedge clk ) begin if(rst) res &lt;= 8&#39;b0; else res &lt;= res &#43; 1&#39;b1; end endmodule 我们要把这个模块当做Reconfiguration Module，把它替换成另外一个module: count_sub，就是每个周期减1计数。
module count_sub( input clk, input rst, output reg [7:0] res ); always @ (posedge clk ) begin if(rst) res &lt;= 8&#39;b0; else res &lt;= res - 1&#39;b1; end endmodule 下面开始进行Partial Reconfiguration的配置
首先打开工程，并将其中一个Reconfiguration Module添加到工程中即可，这里我们选择将count_add添加到工程中，选择Tools-&gt;Enable Partial Reconfiguration" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b673c96ca3ab13ed039a2c1d01a136e1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-11T18:07:49+08:00" />
<meta property="article:modified_time" content="2020-06-11T18:07:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Xilinx FPGA Partial Reconfiguration 部分重配置 详细教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>  Partial Reconfiguration（部分重配置）在现在的FPGA应用中越来越常见，我们这次的教程以Project模式为例来说明部分重配置的操作过程。</p> 
<p>  这里我们使用的Vivado版本是2017.2，使用的例程是Vivado自带的wavegen工程，并在工程中增加一个计数器模块，如下图所示<br> <img src="https://images2.imgbox.com/f8/99/IXuiAJLj_o.png" alt="在这里插入图片描述"><br> 这个模块的代码也很简单，就是加1计数</p> 
<pre><code class="prism language-Verilog">module count_add(
 input            clk,
 input            rst,
 output reg [7:0] res
 );
    
 always @ (posedge clk ) begin 
    if(rst)
        res &lt;= 8'b0;
    else 
        res &lt;= res + 1'b1;
 end       
      
endmodule
</code></pre> 
<p>我们要把这个模块当做Reconfiguration Module，把它替换成另外一个module: <code>count_sub</code>，就是每个周期减1计数。</p> 
<pre><code class="prism language-Verilog">module count_sub(
 input            clk,
 input            rst,
 output reg [7:0] res
 );
    
 always @ (posedge clk ) begin 
    if(rst)
        res &lt;= 8'b0;
    else 
        res &lt;= res - 1'b1;
 end       
      
endmodule
</code></pre> 
<p>下面开始进行Partial Reconfiguration的配置</p> 
<ol><li>首先打开工程，并将<strong>其中一个</strong>Reconfiguration Module添加到工程中即可，这里我们选择将<code>count_add</code>添加到工程中，选择Tools-&gt;Enable Partial Reconfiguration<br> <img src="https://images2.imgbox.com/13/a8/hGwnewTx_o.png" alt="在这里插入图片描述"><br> 出现下面的对话框，点击Convert。该对话框是指如果使能了Partial Reconfiguration模式，是不能返回到普通模式的。</li></ol> 
<p><img src="https://images2.imgbox.com/71/41/5y8VHjtL_o.png" alt="在这里插入图片描述"><br> 此时在Flow Navigator的PROJECT MANAGER下面就会出现Partial Reconfiguration Wizard的选项<br> <img src="https://images2.imgbox.com/80/c0/PkOd0DeG_o.png" alt="在这里插入图片描述"><br> 2. 右键要reconfiguration的模块，即inst_count，并选择Create Partition Definition</p> 
<p><img src="https://images2.imgbox.com/57/f8/Y70VtHMI_o.png" alt="在这里插入图片描述"><br> 此时，弹出对话框提示我们输入创建的Partition的名字，我们起名为<code>count_demo</code>，点击<code>OK</code></p> 
<p><img src="https://images2.imgbox.com/80/2e/SetFTSYI_o.png" alt="在这里插入图片描述"><br> 这时我们可以看到该模块的图标发生了变化，变成了黄色的棱形，如下图所示<br> <img src="https://images2.imgbox.com/91/c2/N3xfh8EL_o.png" alt="在这里插入图片描述"></p> 
<p>在这一步我们需要提醒一下，通常我们需要进行PR的模块都是比较复杂的模块，里面很可能会包含IP Core，那样的话我们就不能直接这样操作，比如我们要对该工程中的<code>clk_gen_i0</code>模块进行PR，可以看到，这个模块中包含了<code>clk_core_i0</code>这个IP</p> 
<p><img src="https://images2.imgbox.com/02/99/7IzHtMNw_o.png" alt="在这里插入图片描述"><br> 当我们在<code>clk_gen_i0</code>这个模块上右键选择Create Partition Definition时，会提示下面的对话框：<br> <code>module with out-of-context child module cannot be made into partition definition</code></p> 
<p><img src="https://images2.imgbox.com/f3/e4/5re1t0WN_o.png" alt="在这里插入图片描述"><br> 这个意思是包含有ooc子模块的模块，是不能做成partiton的，Vivado中所有的IP Core都是ooc的模块，因此我们需要把<code>clk_gen_i0</code>这个模块导出成dcp后再使用，具体可以参考我的另一篇文章<br> <a href="https://blog.csdn.net/zhanghaijun2013/article/details/104594263">Vivado中模块封装成edif和dcp</a></p> 
<p>简单来讲，就是先将这个模块设为top，综合后导出dcp，使用的tcl脚本是</p> 
<pre><code class="prism language-tcl">write_checkpoint -noxdef &lt;path_to_file&gt;
</code></pre> 
<p>有几个需要RM(Reconfiguration Module)的模块，就要综合几次，导出几个dcp文件</p> 
<p>我看网上也有的教程是直接对整个工程进行综合，然后单独导出RM模块的dcp，使用下面的tcl</p> 
<pre><code class="prism language-tcl">write_checkpoint -cell &lt;path_to_cell&gt; &lt;path_to_file&gt;
</code></pre> 
<p>这两种导出dcp的方式是有区别的，把整个工程进行综合，每个子模块的接口很有可能会有所改变，可能是名字改了，也可能是增加或减少了一些接口。如果我们的几个RM只是接口相同，功能不同的话，这样带有不同RM模块的工程综合的结果可能不一样。因此推荐将RM模块设为top，综合后导出dcp<br> 。</p> 
<p><strong>另一点需要注意的是</strong>，如果使用了dcp文件，我们也添加一个wrapper.v到工程中，因此dcp文件是不能直接进行<code>Create Partition Definition</code>操作的。</p> 
<ol start="3"><li>选择左侧导航栏的<code>Partial Reconfiguration Wizard</code>，开始添加RM</li></ol> 
<p><img src="https://images2.imgbox.com/c0/78/HQiyjeAn_o.png" alt="在这里插入图片描述"></p> 
<p>这里，点击<code>+</code>号按钮，出现下面对话框，首先点击<code>Add Files</code>，选择<code>count_sub.v</code>；然后输入<code>Reconfiguration Module Name</code>，由于我们只有一个模块，因此top的name可以不填；如下图，Next<br> <img src="https://images2.imgbox.com/8d/6e/z6XDoyFn_o.png" alt="在这里插入图片描述"></p> 
<p>在这一步如果我们使用dcp文件和wrapper文件的话，需要把它们都添加进来</p> 
<ol start="4"><li>编辑配置，点击<code>automatically create configurations</code>，如果在这个界面没看到这个<code>auto...</code>按钮，就先返回到上一步，再next到这个界面，总会出现的；点击后出现下面的界面：<br> <img src="https://images2.imgbox.com/10/9c/OntRFx2j_o.png" alt="在这里插入图片描述"></li></ol> 
<p>我们修改配置的名字如下，next</p> 
<p><img src="https://images2.imgbox.com/b3/39/GVQAYqNP_o.png" alt="在这里插入图片描述"></p> 
<ol start="5"><li>配置runs，也是先点击<code>automatically create configuration run</code></li></ol> 
<p><img src="https://images2.imgbox.com/f6/ce/cFsjnCLe_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/fd/27/wGTSPytv_o.png" alt="在这里插入图片描述"></p> 
<p>这个图意思是工程中有两个<code>implention runs</code>，第一个叫<code>impl_1</code>，这个里面跑的是包含有<code>count_add</code>模块的程序；第一个叫<code>child_0_impl_1</code>，这个里面跑的是包含<code>count_sub</code>模块的程序。Next到Finish。</p> 
<ol start="6"><li>开始综合，完成后点击Open Synthesized Design，并在Vivado右上角，切换到<code>Floorplanning</code>视图</li></ol> 
<p><img src="https://images2.imgbox.com/9b/38/6NV6exjt_o.png" alt="在这里插入图片描述"><br> 邮件<code>inst_count</code>并点击<code>Draw Pblock</code><br> <img src="https://images2.imgbox.com/5b/ac/w1CKCLgE_o.png" alt="在这里插入图片描述"></p> 
<p>选择一个区域作为Pblock<br> <img src="https://images2.imgbox.com/f0/0c/Xv99e89f_o.png" alt="在这里插入图片描述"></p> 
<p>绘制Pblock是有讲究的，其中最简单的两个规则就是：</p> 
<ul><li>Pblock区域中包含的资源能可以覆盖我们模块需要的资源</li><li>不能与其他的Pblock冲突</li></ul> 
<p>当然，还有很多其他的规则，这里就不一一介绍了，如果Pblock没画好，很可能导致后面的DRC和Implementation不过。<br> 关于该更多Pblock的说明，可以参考UG909手册<a href="https://www.xilinx.com/support/documentation/sw_manuals/xilinx2017_1/ug909-vivado-partial-reconfiguration.pdf" rel="nofollow">UG909</a></p> 
<p>选中框之后，改一下框的属性，将<code>RESET_AFTER_RECONFIG</code>的勾选中，意思是重新配置后，会复位这个Pblock里面的内容；再将SNAPPING_MODE改为Routing（或者设为On），意思是如果我们的边界选的不太好，Vivado会自动处理，选off的话，就是完全按照我们指定的边界。</p> 
<p><img src="https://images2.imgbox.com/e0/db/8ZI4VjLg_o.png" alt="在这里插入图片描述"></p> 
<ol start="7"><li>点击<code>Tools-&gt;Report-&gt;Report DRC</code></li></ol> 
<p><img src="https://images2.imgbox.com/a2/b1/MPM4ytHU_o.png" alt="在这里插入图片描述"></p> 
<p>只选择PR即可<br> <img src="https://images2.imgbox.com/5e/ac/y203PgPx_o.png" alt="在这里插入图片描述"></p> 
<p>如果提示<code>No Violations Found</code>，则说明上面的操作过程没有问题。</p> 
<ol start="8"><li>Run Implementation，可以看到有两个runs需要进行<br> 补充小知识：<a href="https://blog.csdn.net/zhanghaijun2013/article/details/105766955">Vivado中jobs和threads的区别？选择多个jobs能加快实现速度么？</a></li></ol> 
<p><img src="https://images2.imgbox.com/9d/bf/eM6XZBJZ_o.png" alt="在这里插入图片描述"></p> 
<ol start="9"><li>Generate Bitstream，OK</li></ol> 
<p>在这一步进行前，Vivado会自动执行<code>pr_verify</code>，并生成<code>&lt;impl_name&gt;_pr_verify.log</code>文件。</p> 
<p>对于7系列的FPGA，会在impl_1文件夹下生成两个bit文件：<br> <code>wave_gen.bit</code>和<code>inst_count_count_add_partial.bit</code>，第一个bit文件是整个工程且包含<code>count_add</code>模块的bit文件，第二个bit文件是当我们需要进行Partial Reconfiguration的时候需要下载的bit文件；在child_0_impl_1文件夹下会生成一个bit文件<code>inst_count_count_sub_partial.bit</code>，是当我们需要进行Partial Reconfiguration的时候需要下载的bit文件。</p> 
<p>对于UltraScale系列的FPGA，会在生成<code>*_partial.bit</code>的同时多出来一个<code>*_partial_clear.bit</code>，意思是在进行Partial Reconfiguration的时候，先下载<code>*_partial_clear.bit</code>把那一部分的内容先清空，再下载<code>*_partial.bit</code>进行配置。</p> 
<p>使用Project模式的好处就是比较简单，敲的指令也比较少，如果是Non-Project模式，在这中间还需要很多操作，虽然麻烦，但对我们理解它的工作模块很有帮助，有兴趣的同学可以再用Non-Project模式下操作一遍。</p> 
<p>加FPGA技术交流群的朋友，请加微信：xhclsys2</p> 
<p>欢迎关注微信公众号：</p> 
<p><img src="https://images2.imgbox.com/18/32/lSIEXWzG_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93c30c3b5eb83555a53636e1bcc228f4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">采用基于“五元中值组取中值分割法”的线性 时间选择算法，找出 N 个元素集合 S 中的第 k个最小的元素，使其在线性时间内解决</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/466f00acec6c8f06cefaafb2f186f1e0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用iai_kinect2标定kinectV2相机</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>