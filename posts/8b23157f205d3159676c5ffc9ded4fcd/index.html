<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ä½¿ç”¨åŒå¼‚æ­¥åï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ä½¿ç”¨åŒå¼‚æ­¥åï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ" />
<meta property="og:description" content="ç›®å½• ä¸€ã€å‰æƒ…æè¦äºŒã€é€šè¿‡Futureè·å–å¼‚æ­¥è¿”å›å€¼1ã€FutureTask æ˜¯åŸºäº AbstractQueuedSynchronizerå®ç°çš„2ã€FutureTaskæ‰§è¡Œæµç¨‹3ã€get()æ–¹æ³•æ‰§è¡Œæµç¨‹ ä¸‰ã€FutureTaskæºç å…·ä½“åˆ†æ1ã€FutureTaskæºç 2ã€å°†å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼æ”¹ä¸º```Future&lt;Integer&gt;```ï¼Œå°†è¿”å›å€¼æ”¾åˆ°```new AsyncResult&lt;&gt;();```ä¸­ï¼› 3ã€é€šè¿‡```Future&lt;Integer&gt;.get()```è·å–è¿”å›å€¼ï¼š4ã€è¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡æ–°çº¿ç¨‹&#43;Futureè·å–Futureè¿”å›å€¼åœ¨BUGä¸­ç£¨ç ºï¼Œåœ¨ä¼˜åŒ–ä¸­æˆé•¿ å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å“ªå’ã€‚
ä¸€ã€å‰æƒ…æè¦ åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åŒå¼‚æ­¥çš„æ–¹å¼å¯¼å…¥äº†10ä¸‡è¡Œçš„Excelï¼Œæœ‰ä¸ªå°ä¼™ä¼´åœ¨è¯„è®ºåŒºé—®æˆ‘ï¼Œå¦‚ä½•ä¿è¯æ’å…¥åæ•°æ®çš„ä¸€è‡´æ€§å‘¢ï¼Ÿ
å¾ˆç®€å•ï¼Œé€šè¿‡å¯¹æ¯”Excelæ–‡ä»¶è¡Œæ•°å’Œå…¥åº“æ•°é‡æ˜¯å¦ç›¸ç­‰å³å¯ã€‚
é‚£ä¹ˆï¼Œå¦‚ä½•è·å–å¼‚æ­¥çº¿ç¨‹çš„è¿”å›å€¼å‘¢ï¼Ÿ
äºŒã€é€šè¿‡Futureè·å–å¼‚æ­¥è¿”å›å€¼ æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™å¼‚æ­¥æ–¹æ³•æ·»åŠ Futureè¿”å›å€¼çš„æ–¹å¼è·å–ç»“æœã€‚
FutureTask é™¤äº†å®ç° Future æ¥å£å¤–ï¼Œè¿˜å®ç°äº† Runnable æ¥å£ã€‚å› æ­¤ï¼ŒFutureTask å¯ä»¥äº¤ç»™ Executor æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ç”±è°ƒç”¨çº¿ç¨‹ç›´æ¥æ‰§è¡ŒFutureTask.run(ï¼‰ã€‚
1ã€FutureTask æ˜¯åŸºäº AbstractQueuedSynchronizerå®ç°çš„ AbstractQueuedSynchronizerç®€ç§°AQSï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥æ¡†æ¶ï¼Œå®ƒæä¾›é€šç”¨æœºåˆ¶æ¥åŸå­æ€§ç®¡ç†åŒæ­¥çŠ¶æ€ã€é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œä»¥åŠ ç»´æŠ¤è¢«é˜»å¡çº¿ç¨‹çš„é˜Ÿåˆ—ã€‚
åŸºäº AQS å®ç°çš„åŒæ­¥å™¨åŒ…æ‹¬ï¼š ReentrantLockã€Semaphoreã€ReentrantReadWriteLockã€ CountDownLatch å’Œ FutureTaskã€‚
åŸºäº AQSå®ç°çš„åŒæ­¥å™¨åŒ…å«ä¸¤ç§æ“ä½œï¼š
acquireï¼Œé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°AQSçš„çŠ¶æ€å…è®¸è¿™ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œåœ¨FutureTaskä¸­ï¼Œget()å°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼›releaseï¼Œæ”¹å˜AQSçš„çŠ¶æ€ï¼Œä½¿stateå˜ä¸ºéé˜»å¡çŠ¶æ€ï¼Œåœ¨FutureTaskä¸­ï¼Œå¯ä»¥é€šè¿‡run()å’Œcancel()å®ç°ã€‚ 2ã€FutureTaskæ‰§è¡Œæµç¨‹ æ‰§è¡Œ@Asyncå¼‚æ­¥æ–¹æ³•ï¼›å»ºç«‹æ–°çº¿ç¨‹async-executor-Xï¼Œæ‰§è¡ŒRunnableçš„run()æ–¹æ³•ï¼Œï¼ˆFutureTaskå®ç°RunnableFutureï¼ŒRunnableFutureå®ç°Runnableï¼‰ï¼›åˆ¤æ–­çŠ¶æ€stateï¼› å¦‚æœæœªæ–°å»ºæˆ–è€…ä¸å¤„äºAQSï¼Œç›´æ¥è¿”å›ï¼›å¦åˆ™è¿›å…¥COMPLETINGçŠ¶æ€ï¼Œæ‰§è¡Œå¼‚æ­¥çº¿ç¨‹ä»£ç ï¼› å¦‚æœæ‰§è¡Œcancel()æ–¹æ³•æ”¹å˜AQSçš„çŠ¶æ€æ—¶ï¼Œä¼šå”¤é†’AQSç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹çº¿ç¨‹async-executor-1ï¼›çº¿ç¨‹async-executor-1è¢«å”¤é†’å å°†è‡ªå·±ä»AQSé˜Ÿåˆ—ä¸­ç§»é™¤ï¼›ç„¶åå”¤é†’nextçº¿ç¨‹async-executor-2ï¼›æ”¹å˜çº¿ç¨‹async-executor-1çš„stateï¼›ç­‰å¾…get()çº¿ç¨‹å–å€¼ã€‚ nextç­‰å¾…çº¿ç¨‹è¢«å”¤é†’åï¼Œå¾ªç¯çº¿ç¨‹async-executor-1çš„æ­¥éª¤ è¢«å”¤é†’ä»AQSé˜Ÿåˆ—ä¸­ç§»é™¤å”¤é†’nextçº¿ç¨‹æ”¹å˜å¼‚æ­¥çº¿ç¨‹çŠ¶æ€ æ–°å»ºçº¿ç¨‹async-executor-Nï¼Œç›‘å¬å¼‚æ­¥æ–¹æ³•çš„state å¦‚æœå¤„äºEXCEPTIONALä»¥ä¸ŠçŠ¶æ€ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›å¦‚æœå¤„äºCOMPLETINGçŠ¶æ€ï¼ŒåŠ å…¥AQSé˜Ÿåˆ—ç­‰å¾…ï¼›å¦‚æœå¤„äºNORMALçŠ¶æ€ï¼Œè¿”å›ç»“æœï¼› 3ã€get()æ–¹æ³•æ‰§è¡Œæµç¨‹ get()æ–¹æ³•é€šè¿‡åˆ¤æ–­çŠ¶æ€stateè§‚æµ‹å¼‚æ­¥çº¿ç¨‹æ˜¯å¦å·²ç»“æŸï¼Œå¦‚æœç»“æŸç›´æ¥å°†ç»“æœè¿”å›ï¼Œå¦åˆ™ä¼šå°†ç­‰å¾…èŠ‚ç‚¹æ‰”è¿›ç­‰å¾…é˜Ÿåˆ—è‡ªæ—‹ï¼Œé˜»å¡ä½çº¿ç¨‹ã€‚
è‡ªæ—‹ç›´è‡³å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œè·å–å¦ä¸€è¾¹çš„çº¿ç¨‹è®¡ç®—å‡ºç»“æœæˆ–å–æ¶ˆåï¼Œå°†ç­‰å¾…é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ä¾æ¬¡å”¤é†’å¹¶ç§»é™¤é˜Ÿåˆ—ã€‚
å¦‚æœstateå°äºç­‰äºCOMPLETINGï¼Œè¡¨ç¤ºä»»åŠ¡è¿˜åœ¨æ‰§è¡Œä¸­ï¼› å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼›å¦‚æœstateå¤§äºCOMPLETINGï¼› å¦‚æœå·²æœ‰ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼Œå°†çº¿ç¨‹ç½®ç©ºï¼›è¿”å›å½“å‰çŠ¶æ€ï¼› å¦‚æœä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè®©å‡ºæ—¶é—´ç‰‡ï¼›å¦‚æœè¿˜æœªæ„é€ ç­‰å¾…èŠ‚ç‚¹ï¼Œåˆ™newä¸€ä¸ªæ–°çš„ç­‰å¾…èŠ‚ç‚¹ï¼›å¦‚æœæœªå…¥é˜Ÿåˆ—ï¼ŒCASå°è¯•å…¥é˜Ÿï¼›å¦‚æœæœ‰è¶…æ—¶æ—¶é—´å‚æ•°ï¼› è®¡ç®—è¶…æ—¶æ—¶é—´ï¼›å¦‚æœè¶…æ—¶ï¼Œåˆ™ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼Œè¿”å›å½“å‰çŠ¶æ€stateï¼›é˜»å¡é˜Ÿåˆ—nanosæ¯«ç§’ã€‚ å¦åˆ™é˜»å¡é˜Ÿåˆ—ï¼› å¦‚æœstateå¤§äºCOMPLETINGï¼› å¦‚æœæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœï¼›å¦‚æœå¤§äºç­‰äºå–æ¶ˆçŠ¶æ€ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ å¾ˆå¤šå°æœ‹å‹å¯¹è¯»æºç ï¼Œå—¤ä¹‹ä»¥é¼»ï¼Œå·¥ä½œ3å¹´ã€5å¹´ï¼Œè¿˜æ˜¯æ²¡è®¤çœŸè¯»è¿‡ä»»ä½•æºç ï¼Œè§‰å¾—è¯»äº†ä¹Ÿæ²¡å•¥ç”¨ï¼Œæˆ–è€…è¯»äº†ä¹Ÿçœ‹ä¸æ‡‚~
å…¶å®ï¼Œåªè¦æŠŠæºç çš„æ‰§è¡Œæµç¨‹é€šè¿‡ç”»å›¾çš„å½¢å¼å‘ˆç°å‡ºæ¥ï¼Œä½ å°±ä¼šå¹¡ç„¶é†’æ‚Ÿï¼ŒåŸæ¥æ˜¯è¿™æ ·çš„~
ç®€è€Œè¨€ä¹‹ï¼š
1. å¦‚æœå¼‚æ­¥çº¿ç¨‹è¿˜æ²¡æ‰§è¡Œå®Œï¼Œåˆ™è¿›å…¥CASè‡ªæ—‹ï¼›
2. å…¶å®ƒçº¿ç¨‹è·å–ç»“æœæˆ–å–æ¶ˆåï¼Œé‡æ–°å”¤é†’CASé˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹ï¼›
3. å†é€šè¿‡get()åˆ¤æ–­çŠ¶æ€stateï¼›
4. ç›´è‡³è¿”å›ç»“æœæˆ–ï¼ˆå–æ¶ˆã€è¶…æ—¶ã€å¼‚å¸¸ï¼‰ä¸ºæ­¢ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8b23157f205d3159676c5ffc9ded4fcd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-22T08:18:17+08:00" />
<meta property="article:modified_time" content="2024-01-22T08:18:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ä½¿ç”¨åŒå¼‚æ­¥åï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/1f/3a/2q3sFLUG_o.gif" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p></p> 
<div class="toc"> 
 <h4>ç›®å½•</h4> 
 <ul><li><ul><li><a href="#_5" rel="nofollow">ä¸€ã€å‰æƒ…æè¦</a></li><li><a href="#Future_14" rel="nofollow">äºŒã€é€šè¿‡Futureè·å–å¼‚æ­¥è¿”å›å€¼</a></li><li><ul><li><a href="#1FutureTask__AbstractQueuedSynchronizer_19" rel="nofollow">1ã€FutureTask æ˜¯åŸºäº AbstractQueuedSynchronizerå®ç°çš„</a></li><li><a href="#2FutureTask_29" rel="nofollow">2ã€FutureTaskæ‰§è¡Œæµç¨‹</a></li><li><a href="#3get_54" rel="nofollow">3ã€get()æ–¹æ³•æ‰§è¡Œæµç¨‹</a></li></ul> 
   </li><li><a href="#FutureTask_91" rel="nofollow">ä¸‰ã€FutureTaskæºç å…·ä½“åˆ†æ</a></li><li><ul><li><a href="#1FutureTask_92" rel="nofollow">1ã€FutureTaskæºç </a></li><li><ul><li><a href="#2FutureIntegernew_AsyncResult_188" rel="nofollow">2ã€å°†å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼æ”¹ä¸º```Future&lt;Integer&gt;```ï¼Œå°†è¿”å›å€¼æ”¾åˆ°```new AsyncResult&lt;&gt;();```ä¸­ï¼›</a></li></ul> 
    </li><li><a href="#3FutureIntegerget_218" rel="nofollow">3ã€é€šè¿‡```Future&lt;Integer&gt;.get()```è·å–è¿”å›å€¼ï¼š</a></li><li><a href="#4FutureFuture_249" rel="nofollow">4ã€è¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡æ–°çº¿ç¨‹+Futureè·å–Futureè¿”å›å€¼</a></li><li><a href="#BUG_279" rel="nofollow">åœ¨BUGä¸­ç£¨ç ºï¼Œåœ¨ä¼˜åŒ–ä¸­æˆé•¿</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å“ªå’ã€‚</p> 
<h3><a id="_5"></a>ä¸€ã€å‰æƒ…æè¦</h3> 
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬<a href="https://blog.csdn.net/guorui_java/article/details/135143234"><strong>é€šè¿‡åŒå¼‚æ­¥çš„æ–¹å¼å¯¼å…¥äº†10ä¸‡è¡Œçš„Excel</strong></a>ï¼Œæœ‰ä¸ªå°ä¼™ä¼´åœ¨è¯„è®ºåŒºé—®æˆ‘ï¼Œ<strong>å¦‚ä½•ä¿è¯æ’å…¥åæ•°æ®çš„ä¸€è‡´æ€§å‘¢ï¼Ÿ</strong></p> 
<p>å¾ˆç®€å•ï¼Œé€šè¿‡å¯¹æ¯”Excelæ–‡ä»¶è¡Œæ•°å’Œå…¥åº“æ•°é‡æ˜¯å¦ç›¸ç­‰å³å¯ã€‚</p> 
<p><font face="æ¥·ä½“" size="5" color="#dd0000">é‚£ä¹ˆï¼Œå¦‚ä½•è·å–å¼‚æ­¥çº¿ç¨‹çš„è¿”å›å€¼å‘¢ï¼Ÿ</font></p> 
<p><img src="https://images2.imgbox.com/41/38/QfEzJSHD_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="Future_14"></a>äºŒã€é€šè¿‡Futureè·å–å¼‚æ­¥è¿”å›å€¼</h3> 
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™å¼‚æ­¥æ–¹æ³•æ·»åŠ Futureè¿”å›å€¼çš„æ–¹å¼è·å–ç»“æœã€‚</p> 
<p>FutureTask é™¤äº†å®ç° Future æ¥å£å¤–ï¼Œè¿˜å®ç°äº† Runnable æ¥å£ã€‚å› æ­¤ï¼ŒFutureTask å¯ä»¥äº¤ç»™ Executor æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ç”±è°ƒç”¨çº¿ç¨‹ç›´æ¥æ‰§è¡ŒFutureTask.run(ï¼‰ã€‚</p> 
<h4><a id="1FutureTask__AbstractQueuedSynchronizer_19"></a>1ã€FutureTask æ˜¯åŸºäº AbstractQueuedSynchronizerå®ç°çš„</h4> 
<blockquote> 
 <p>AbstractQueuedSynchronizerç®€ç§°AQSï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥æ¡†æ¶ï¼Œå®ƒæä¾›é€šç”¨æœºåˆ¶æ¥åŸå­æ€§ç®¡ç†åŒæ­¥çŠ¶æ€ã€é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œä»¥åŠ ç»´æŠ¤è¢«é˜»å¡çº¿ç¨‹çš„é˜Ÿåˆ—ã€‚<br> åŸºäº AQS å®ç°çš„åŒæ­¥å™¨åŒ…æ‹¬ï¼š ReentrantLockã€Semaphoreã€ReentrantReadWriteLockã€ CountDownLatch å’Œ FutureTaskã€‚</p> 
</blockquote> 
<p>åŸºäº AQSå®ç°çš„åŒæ­¥å™¨åŒ…å«ä¸¤ç§æ“ä½œï¼š</p> 
<ol><li>acquireï¼Œé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°AQSçš„çŠ¶æ€å…è®¸è¿™ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œåœ¨FutureTaskä¸­ï¼Œget()å°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼›</li><li>releaseï¼Œæ”¹å˜AQSçš„çŠ¶æ€ï¼Œä½¿stateå˜ä¸ºéé˜»å¡çŠ¶æ€ï¼Œåœ¨FutureTaskä¸­ï¼Œå¯ä»¥é€šè¿‡run()å’Œcancel()å®ç°ã€‚</li></ol> 
<h4><a id="2FutureTask_29"></a>2ã€FutureTaskæ‰§è¡Œæµç¨‹</h4> 
<p><img src="https://images2.imgbox.com/2c/38/YeOHHmny_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<ol><li>æ‰§è¡Œ@Asyncå¼‚æ­¥æ–¹æ³•ï¼›</li><li>å»ºç«‹æ–°çº¿ç¨‹async-executor-Xï¼Œæ‰§è¡ŒRunnableçš„run()æ–¹æ³•ï¼Œï¼ˆFutureTaskå®ç°RunnableFutureï¼ŒRunnableFutureå®ç°Runnableï¼‰ï¼›</li><li>åˆ¤æ–­çŠ¶æ€stateï¼› 
  <ul><li>å¦‚æœæœªæ–°å»ºæˆ–è€…ä¸å¤„äºAQSï¼Œç›´æ¥è¿”å›ï¼›</li><li>å¦åˆ™è¿›å…¥COMPLETINGçŠ¶æ€ï¼Œæ‰§è¡Œå¼‚æ­¥çº¿ç¨‹ä»£ç ï¼›</li></ul> </li><li>å¦‚æœæ‰§è¡Œcancel()æ–¹æ³•æ”¹å˜AQSçš„çŠ¶æ€æ—¶ï¼Œä¼šå”¤é†’AQSç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹çº¿ç¨‹async-executor-1ï¼›</li><li>çº¿ç¨‹async-executor-1è¢«å”¤é†’å 
  <ul><li>å°†è‡ªå·±ä»AQSé˜Ÿåˆ—ä¸­ç§»é™¤ï¼›</li><li>ç„¶åå”¤é†’nextçº¿ç¨‹async-executor-2ï¼›</li><li>æ”¹å˜çº¿ç¨‹async-executor-1çš„stateï¼›</li><li>ç­‰å¾…get()çº¿ç¨‹å–å€¼ã€‚</li></ul> </li><li>nextç­‰å¾…çº¿ç¨‹è¢«å”¤é†’åï¼Œå¾ªç¯çº¿ç¨‹async-executor-1çš„æ­¥éª¤ 
  <ul><li>è¢«å”¤é†’</li><li>ä»AQSé˜Ÿåˆ—ä¸­ç§»é™¤</li><li>å”¤é†’nextçº¿ç¨‹</li><li>æ”¹å˜å¼‚æ­¥çº¿ç¨‹çŠ¶æ€</li></ul> </li><li>æ–°å»ºçº¿ç¨‹async-executor-Nï¼Œç›‘å¬å¼‚æ­¥æ–¹æ³•çš„state 
  <ul><li>å¦‚æœå¤„äºEXCEPTIONALä»¥ä¸ŠçŠ¶æ€ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›</li><li>å¦‚æœå¤„äºCOMPLETINGçŠ¶æ€ï¼ŒåŠ å…¥AQSé˜Ÿåˆ—ç­‰å¾…ï¼›</li><li>å¦‚æœå¤„äºNORMALçŠ¶æ€ï¼Œè¿”å›ç»“æœï¼›</li></ul> </li></ol> 
<h4><a id="3get_54"></a>3ã€get()æ–¹æ³•æ‰§è¡Œæµç¨‹</h4> 
<p>get()æ–¹æ³•é€šè¿‡åˆ¤æ–­çŠ¶æ€stateè§‚æµ‹å¼‚æ­¥çº¿ç¨‹æ˜¯å¦å·²ç»“æŸï¼Œå¦‚æœç»“æŸç›´æ¥å°†ç»“æœè¿”å›ï¼Œå¦åˆ™ä¼šå°†ç­‰å¾…èŠ‚ç‚¹æ‰”è¿›ç­‰å¾…é˜Ÿåˆ—è‡ªæ—‹ï¼Œé˜»å¡ä½çº¿ç¨‹ã€‚</p> 
<p>è‡ªæ—‹ç›´è‡³å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œè·å–å¦ä¸€è¾¹çš„çº¿ç¨‹è®¡ç®—å‡ºç»“æœæˆ–å–æ¶ˆåï¼Œå°†ç­‰å¾…é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ä¾æ¬¡å”¤é†’å¹¶ç§»é™¤é˜Ÿåˆ—ã€‚</p> 
<p><img src="https://images2.imgbox.com/af/7d/2gmlaoCj_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<ol><li>å¦‚æœstateå°äºç­‰äºCOMPLETINGï¼Œè¡¨ç¤ºä»»åŠ¡è¿˜åœ¨æ‰§è¡Œä¸­ï¼› 
  <ul><li>å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼›</li><li>å¦‚æœstateå¤§äºCOMPLETINGï¼› 
    <ul><li>å¦‚æœå·²æœ‰ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼Œå°†çº¿ç¨‹ç½®ç©ºï¼›</li><li>è¿”å›å½“å‰çŠ¶æ€ï¼›</li></ul> </li><li>å¦‚æœä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè®©å‡ºæ—¶é—´ç‰‡ï¼›</li><li>å¦‚æœè¿˜æœªæ„é€ ç­‰å¾…èŠ‚ç‚¹ï¼Œåˆ™newä¸€ä¸ªæ–°çš„ç­‰å¾…èŠ‚ç‚¹ï¼›</li><li>å¦‚æœæœªå…¥é˜Ÿåˆ—ï¼ŒCASå°è¯•å…¥é˜Ÿï¼›</li><li>å¦‚æœæœ‰è¶…æ—¶æ—¶é—´å‚æ•°ï¼› 
    <ul><li>è®¡ç®—è¶…æ—¶æ—¶é—´ï¼›</li><li>å¦‚æœè¶…æ—¶ï¼Œåˆ™ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼Œè¿”å›å½“å‰çŠ¶æ€stateï¼›</li><li>é˜»å¡é˜Ÿåˆ—nanosæ¯«ç§’ã€‚</li></ul> </li><li>å¦åˆ™é˜»å¡é˜Ÿåˆ—ï¼›</li></ul> </li><li>å¦‚æœstateå¤§äºCOMPLETINGï¼› 
  <ul><li>å¦‚æœæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœï¼›</li><li>å¦‚æœå¤§äºç­‰äºå–æ¶ˆçŠ¶æ€ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li></ul> </li></ol> 
<p>å¾ˆå¤šå°æœ‹å‹å¯¹è¯»æºç ï¼Œå—¤ä¹‹ä»¥é¼»ï¼Œå·¥ä½œ3å¹´ã€5å¹´ï¼Œè¿˜æ˜¯æ²¡è®¤çœŸè¯»è¿‡ä»»ä½•æºç ï¼Œè§‰å¾—è¯»äº†ä¹Ÿæ²¡å•¥ç”¨ï¼Œæˆ–è€…è¯»äº†ä¹Ÿçœ‹ä¸æ‡‚~</p> 
<p>å…¶å®ï¼Œåªè¦æŠŠæºç çš„æ‰§è¡Œæµç¨‹é€šè¿‡ç”»å›¾çš„å½¢å¼å‘ˆç°å‡ºæ¥ï¼Œä½ å°±ä¼šå¹¡ç„¶é†’æ‚Ÿï¼ŒåŸæ¥æ˜¯è¿™æ ·çš„~</p> 
<p><font face="æ¥·ä½“" size="4" color="#dd0000">ç®€è€Œè¨€ä¹‹ï¼š</font></p> 
<p><font face="æ¥·ä½“" size="4" color="#dd0000">1. å¦‚æœå¼‚æ­¥çº¿ç¨‹è¿˜æ²¡æ‰§è¡Œå®Œï¼Œåˆ™è¿›å…¥CASè‡ªæ—‹ï¼›</font><br> <font face="æ¥·ä½“" size="4" color="#dd0000">2. å…¶å®ƒçº¿ç¨‹è·å–ç»“æœæˆ–å–æ¶ˆåï¼Œé‡æ–°å”¤é†’CASé˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹ï¼›</font><br> <font face="æ¥·ä½“" size="4" color="#dd0000">3. å†é€šè¿‡get()åˆ¤æ–­çŠ¶æ€stateï¼›</font><br> <font face="æ¥·ä½“" size="4" color="#dd0000">4. ç›´è‡³è¿”å›ç»“æœæˆ–ï¼ˆå–æ¶ˆã€è¶…æ—¶ã€å¼‚å¸¸ï¼‰ä¸ºæ­¢ã€‚</font></p> 
<h3><a id="FutureTask_91"></a>ä¸‰ã€FutureTaskæºç å…·ä½“åˆ†æ</h3> 
<h4><a id="1FutureTask_92"></a>1ã€FutureTaskæºç </h4> 
<p>é€šè¿‡å®šä¹‰æ•´å½¢çŠ¶æ€å€¼ï¼Œåˆ¤æ–­stateå¤§å°ï¼Œè¿™ä¸ªæ€æƒ³å¾ˆæœ‰æ„æ€ï¼Œå€¼å¾—å­¦ä¹ ã€‚</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * Sets this Future to the result of its computation
     * unless it has been cancelled.
     */</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// æœ€åˆå§‹çš„çŠ¶æ€æ˜¯new æ–°å»ºçŠ¶æ€</span>
	<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NEW</span>          <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ–°å»ºçŠ¶æ€</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMPLETING</span>   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// å®Œæˆä¸­</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NORMAL</span>       <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// æ­£å¸¸æ‰§è¡Œå®Œ</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXCEPTIONAL</span>  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// å¼‚å¸¸</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span>    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// å–æ¶ˆ</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTING</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// æ­£åœ¨ä¸­æ–­</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTED</span>  <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// å·²ä¸­æ–­</span>

	<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
	    <span class="token comment">// ä»»åŠ¡è¿˜åœ¨æ‰§è¡Œä¸­</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;=</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span>
	        s <span class="token operator">=</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> <span class="token function">report</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> deadline <span class="token operator">=</span> timed <span class="token operator">?</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> nanos <span class="token operator">:</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token class-name">WaitNode</span> q <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> queued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// çº¿ç¨‹è¢«ä¸­æ–­ï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">removeWaiter</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
            <span class="token comment">// ä»»åŠ¡å·²æ‰§è¡Œå®Œæ¯•æˆ–å–æ¶ˆ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// å¦‚æœå·²æœ‰ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼Œå°†çº¿ç¨‹ç½®ç©º</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    q<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> s<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè®©å‡ºæ—¶é—´ç‰‡</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span> <span class="token comment">// cannot time out yet</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¿˜æœªæ„é€ ç­‰å¾…èŠ‚ç‚¹ï¼Œåˆ™newä¸€ä¸ªæ–°çš„ç­‰å¾…èŠ‚ç‚¹</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaitNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æœªå…¥é˜Ÿåˆ—ï¼ŒCASå°è¯•å…¥é˜Ÿ</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queued<span class="token punctuation">)</span>
                queued <span class="token operator">=</span> <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> waitersOffset<span class="token punctuation">,</span>
                                                     q<span class="token punctuation">.</span>next <span class="token operator">=</span> waiters<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœæœ‰è¶…æ—¶æ—¶é—´å‚æ•°</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// è®¡ç®—è¶…æ—¶æ—¶é—´</span>
                nanos <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å¦‚æœè¶…æ—¶ï¼Œåˆ™ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç­‰å¾…èŠ‚ç‚¹WaitNodeï¼Œè¿”å›å½“å‰çŠ¶æ€state</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">removeWaiter</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// é˜»å¡é˜Ÿåˆ—nanosæ¯«ç§’</span>
                <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            	<span class="token comment">// é˜»å¡é˜Ÿåˆ—</span>
                <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
	<span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// è·å–outcomeä¸­è®°å½•çš„è¿”å›ç»“æœ</span>
        <span class="token class-name">Object</span> x <span class="token operator">=</span> outcome<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>x<span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœå¤§äºç­‰äºå–æ¶ˆçŠ¶æ€ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CancellationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2FutureIntegernew_AsyncResult_188"></a>2ã€å°†å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼æ”¹ä¸º<code>Future&lt;Integer&gt;</code>ï¼Œå°†è¿”å›å€¼æ”¾åˆ°<code>new AsyncResult&lt;&gt;();</code>ä¸­ï¼›</h5> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span><span class="token string">"async-executor"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readXls</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">,</span> <span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// æ­¤ä»£ç ä¸ºç®€åŒ–å…³é”®æ€§ä»£ç </span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futureList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> time <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> time<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sumFuture <span class="token operator">=</span> readExcelDataAsyncFutureService<span class="token punctuation">.</span><span class="token function">readXlsCacheAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            futureList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sumFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"readXlsCacheAsync---æ’å…¥æ•°æ®å¼‚å¸¸ï¼š"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span><span class="token string">"async-executor"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">readXlsCacheAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// æ­¤ä»£ç ä¸ºç®€åŒ–å…³é”®æ€§ä»£ç </span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3FutureIntegerget_218"></a>3ã€é€šè¿‡<code>Future&lt;Integer&gt;.get()</code>è·å–è¿”å›å€¼ï¼š</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">getFutureResult</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futureList<span class="token punctuation">,</span> <span class="token keyword">int</span> excelRow<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> futureSumArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>futureList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>futureList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> futureList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Integer</span> futureSum <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"è·å–Futureè¿”å›å€¼æˆåŠŸ"</span><span class="token operator">+</span><span class="token string">"----Future:"</span> <span class="token operator">+</span> future
                            <span class="token operator">+</span> <span class="token string">",Result:"</span> <span class="token operator">+</span> futureSum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    futureSumArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> futureSum<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Futureæ­£åœ¨æ‰§è¡Œ---è·å–Futureè¿”å›å€¼ä¸­---ç­‰å¾…3ç§’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"è·å–Futureè¿”å›å€¼å¼‚å¸¸: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">boolean</span> insertFlag <span class="token operator">=</span> <span class="token function">getInsertSum</span><span class="token punctuation">(</span>futureSumArr<span class="token punctuation">,</span> excelRow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"è·å–æ‰€æœ‰å¼‚æ­¥çº¿ç¨‹Futureçš„è¿”å›å€¼æˆåŠŸï¼ŒExcelæ’å…¥ç»“æœ="</span><span class="token operator">+</span>insertFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> insertFlag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="4FutureFuture_249"></a>4ã€è¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡æ–°çº¿ç¨‹+Futureè·å–Futureè¿”å›å€¼</h4> 
<p>ä¸è¿‡æ„Ÿè§‰å¤šæ­¤ä¸€ä¸¾äº†ï¼Œå°±å½“ç»ƒä¹ Futureå¼‚æ­¥å–è¿”å›å€¼äº†~</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFutureResultThreadFuture</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futureList<span class="token punctuation">,</span> <span class="token keyword">int</span> excelRow<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> insertFlag <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    service<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                insertFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getFutureResult</span><span class="token punctuation">(</span>futureList<span class="token punctuation">,</span> excelRow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"æ–°çº¿ç¨‹+Futureè·å–Futureè¿”å›å€¼å¼‚å¸¸: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                insertFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    service<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>insertFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>è·å–å¼‚æ­¥çº¿ç¨‹ç»“æœåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ äº‹åŠ¡çš„æ–¹å¼ï¼Œå®ç°Excelå…¥åº“æ“ä½œçš„æ•°æ®ä¸€è‡´æ€§ã€‚</p> 
<p><font face="æ¥·ä½“" size="5" color="#dd0000">ä½†Futureä¼šé€ æˆä¸»çº¿ç¨‹çš„é˜»å¡ï¼Œè¿™ä¸ªå°±å¾ˆä¸å‹å¥½äº†ï¼Œæœ‰æ²¡æœ‰æ›´ä¼˜è§£å‘¢ï¼Ÿ</font></p> 
<br> 
<h4><a id="BUG_279"></a>åœ¨BUGä¸­ç£¨ç ºï¼Œåœ¨ä¼˜åŒ–ä¸­æˆé•¿</h4> 
<p><a href="https://blog.csdn.net/guorui_java/article/details/135143234">ä½¿ç”¨åŒå¼‚æ­¥åï¼Œä» 191s ä¼˜åŒ–åˆ° 2s</a></p> 
<p><a href="https://blog.csdn.net/guorui_java/article/details/135423211">å¢åŠ ç´¢å¼• + å¼‚æ­¥ + ä¸è½åœ°åï¼Œä» 12h ä¼˜åŒ–åˆ° 15 min</a></p> 
<p><a href="https://blog.csdn.net/guorui_java/article/details/135511089">ä½¿ç”¨æ‡’åŠ è½½ + é›¶æ‹·è´åï¼Œç¨‹åºçš„ç§’å¼€ç‡æå‡è‡³99.99%</a></p> 
<p><a href="https://blog.csdn.net/guorui_java/article/details/135538341">æ€§èƒ½ä¼˜åŒ–2.0ï¼Œæ–°å¢ç¼“å­˜åï¼Œç¨‹åºçš„ç§’å¼€ç‡ä¸å‡åé™</a></p> 
<br> 
<p>ğŸ†æ–‡ç« æ”¶å½•äºï¼š<a href="https://blog.csdn.net/guorui_java/category_12196381.html">100å¤©ç²¾é€šJavaä»å…¥é—¨åˆ°å°±ä¸š</a></p> 
<p>å…¨ç½‘æœ€ç»†Javaé›¶åŸºç¡€æ‰‹æŠŠæ‰‹å…¥é—¨æ•™ç¨‹ï¼Œç³»åˆ—è¯¾ç¨‹åŒ…æ‹¬ï¼šJavaåŸºç¡€ã€Java8æ–°ç‰¹æ€§ã€Javaé›†åˆã€é«˜å¹¶å‘ã€æ€§èƒ½ä¼˜åŒ–ç­‰ï¼Œé€‚åˆé›¶åŸºç¡€å’Œè¿›é˜¶æå‡çš„åŒå­¦ã€‚</p> 
<p>ğŸ†å“ªå’å¤šå¹´å·¥ä½œæ€»ç»“ï¼š<a href="https://blog.csdn.net/guorui_java/article/details/120098618"><strong>Javaå­¦ä¹ è·¯çº¿æ€»ç»“ï¼Œæ¬ç –å·¥é€†è¢­Javaæ¶æ„å¸ˆ</strong></a>ã€‚</p> 
<blockquote> 
 <p><font face="æ¥·ä½“" size="4">åä¸ºODæœºè¯• 2023Bå·é¢˜åº“ç–¯ç‹‚æ”¶å½•ä¸­ï¼Œåˆ·é¢˜<a href="https://blog.csdn.net/guorui_java/article/details/132683473"><font color="#dd0000"><u><strong>ç‚¹è¿™é‡Œ</strong></u></font></a></font></p> 
</blockquote> 
<p><strong>åˆ·çš„è¶Šå¤šï¼ŒæŠ½ä¸­çš„æ¦‚ç‡è¶Šå¤§</strong>ï¼Œæ¯ä¸€é¢˜éƒ½æœ‰è¯¦ç»†çš„ç­”é¢˜æ€è·¯ã€è¯¦ç»†çš„ä»£ç æ³¨é‡Šã€æ ·ä¾‹æµ‹è¯•ï¼Œå‘ç°æ–°é¢˜ç›®ï¼Œéšæ—¶æ›´æ–°ï¼Œå…¨å¤©CSDNåœ¨çº¿ç­”ç–‘ã€‚</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e31e059c2d5b5377eff3021e8cda33de/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">springbootç¬¬51é›†ï¼šlombokï¼ŒSwaggerï¼Œk8sï¼Œç¼“å­˜ï¼Œsentinelå‘¨åˆŠ</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/183e944ed8161fda149040c3bf8c54d5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">ï¼ˆé™„æºç ï¼‰djangoå½±é™¢å®¢æœè®¢ç¥¨ç³»ç»Ÿ æ¯•ä¸šè®¾è®¡43697</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>