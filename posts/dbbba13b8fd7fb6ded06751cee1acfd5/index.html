<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PHP 一一 微信公众号开发(二次开发) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PHP 一一 微信公众号开发(二次开发)" />
<meta property="og:description" content="两个星期前,学校请了传智播客的老师给我们做实训,讲了一个微信公众号开发,感觉挺有意思,在这里做一下记录,以便以后复习.
一、了解微信公众平台
1. 什么是微信公众平台?
微信公众平台是腾讯为了让用户申请和管理微信公众账号而推出的一个Web平台,而微信公众账号的操作管理在这个平台下进行.换句话说,凡是关注自己公众号的用户,在这个网站中都可以去管理他们. 平台地址: https://mp.weixin.qq.com/
2. 微信的两种运行模式
编辑模式与开发者模式,这两种模式是互斥的.
编辑模式是平台内置的web系统,不需要专业的技术.
开发者模式可以通过腾讯的API接口进行二次开发,需要专业的PHP技术.
3. 首先要在平台地址中,创建一个订阅号.
订阅号和服务号的区别: 订阅号是针对个人的,服务号针对有营业执照的商户.
二、微信公众平台开发(开发者模式)
0. 在讲下面的一些知识之前: 大家首先把这个网盘中的一些 要使用的的文件,下载下来,后面会使用到.
网盘地址: 链接：https://pan.baidu.com/s/1qZzwLGC 密码：v9vk
1. 开发者模式原理图
根据上图,我们联想平时我们关注的微信公众号,当我们发消息给公众号,公众号都会自动回复我们一些东西. 还有一点,我们必须要有自己的服务器,在阿里云买一个服务器肯定需要钱啊,我们不想花钱怎么办?
这里就要使用到 内网渗透 的技术,把我们自己的电脑充当服务器(拥有自己的域名).
2、在开发之前,首先我们要下载并启动PhpStudy,做过php开发的,都应该了解什么是phpStudy.他是php的配置环境,具体参考链接中的PHP环境配置:
http://blog.csdn.net/m0_37989980/article/details/78971478 3、NATAPP内网渗透技术.(将本机充当一个服务器)
在 http://natapp.cn/ 使用手机号注册一个自己的账号.如下图所示
此时我们需要下载一个natapp的客户端. 我在这里提供了网盘地址: 大家可以下载.
1): 首先将下载好的natapp.exe 与 config.ini 同时赋值到 D盘的natapp目录下(这个natapp目录是自己创建的)
2): 打开config.ini中的隧道密钥,改成我们自己的密钥.
这个authtoken就是我们的密钥,把这个密钥复制到config.ini的这个位置
4): 打开cmd窗口,将刚才D盘下natapp目录下的natapp.exe拖动到命令行中,如下图所示
这样我们的服务器就已经创建好了,以后我们就可以通过 上面的 http:// 来访问自己的电脑了
注意: 在运行过程中,cmd命令行不可以关闭/
5): 下载腾讯提供的API接口, 叫api.php,也在刚才你所下载的网盘文件中.
我们把api.php文件放到 我们安装的phpStudy的目录下的 PHPTutorial的WWW目录下;
6): 把api.php放进去之后,打开这个文件, 查看这个文件中的 define(&#34;TOKEN&#34;,&#34;weixin&#34;) ,记住这个接口中的密钥是 weixin" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dbbba13b8fd7fb6ded06751cee1acfd5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-11T19:14:21+08:00" />
<meta property="article:modified_time" content="2018-01-11T19:14:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PHP 一一 微信公众号开发(二次开发)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>两个星期前,学校请了传智播客的老师给我们做实训,讲了一个微信公众号开发,感觉挺有意思,在这里做一下记录,以便以后复习.</p> 
<p>一、了解微信公众平台</p> 
<p>1. 什么是微信公众平台?</p> 
<p>微信公众平台是腾讯为了让用户申请和管理微信公众账号而推出的一个Web平台,而微信公众账号的操作管理在这个平台下进行.换句话说,凡是关注自己公众号的用户,在这个网站中都可以去管理他们. 平台地址: <a target="_blank" href="https://mp.weixin.qq.com/" rel="nofollow noopener noreferrer">https://mp.weixin.qq.com/</a></p> 
<p>2. 微信的两种运行模式</p> 
<p>编辑模式与开发者模式,这两种模式是互斥的.</p> 
<p><span style="color:#ff0000">编辑模式</span>是平台内置的web系统,不需要专业的技术.</p> 
<p><span style="color:#ff0000">开发者模式</span>可以通过腾讯的API接口进行二次开发,需要专业的PHP技术.</p> 
<p>3. 首先要在平台地址中,创建一个订阅号.</p> 
<p>订阅号和服务号的区别: <span style="color:#ff0000">订阅号是针对个人的,服务号针对有营业执照的商户.</span></p> 
<p><span style="color:#ff0000"><br> </span></p> 
<p>二、微信公众平台开发(开发者模式)</p> 
<p>0. 在讲下面的一些知识之前: 大家首先把这个网盘中的一些 要使用的的文件,下载下来,后面会使用到.</p> 
<p>网盘地址: 链接：https://pan.baidu.com/s/1qZzwLGC 密码：v9vk</p> 
<p>1. 开发者模式原理图</p> 
<p><img src="https://images2.imgbox.com/e2/7a/yss8wH15_o.png" alt=""><br> </p> 
<p>根据上图,我们联想平时我们关注的微信公众号,当我们发消息给公众号,公众号都会自动回复我们一些东西. </p> 
<p>还有一点,我们必须要有自己的服务器,在阿里云买一个服务器肯定需要钱啊,我们不想花钱怎么办?</p> 
<p>这里就要使用到 <span style="color:#ff0000">内网渗透</span> 的技术,把我们自己的电脑充当服务器(<span style="color:#ff0000">拥有自己的域名</span>).</p> 
<p>2、在开发之前,首先我们要下载并启动PhpStudy,做过php开发的,都应该了解什么是phpStudy.他是php的配置环境,具体参考链接中的PHP环境配置:</p> 
<p><a target="_blank" href="http://blog.csdn.net/m0_37989980/article/details/78971478" rel="noopener noreferrer">http://blog.csdn.net/m0_37989980/article/details/78971478</a> <br> </p> 
<p>3、NATAPP内网渗透技术.(将本机充当一个服务器)</p> 
<p>在 <a target="_blank" href="http://natapp.cn/" rel="nofollow noopener noreferrer">http://natapp.cn/</a> 使用手机号注册一个自己的账号.如下图所示</p> 
<p><img src="https://images2.imgbox.com/c1/22/y7Y5uRsg_o.png" alt=""><br> </p> 
<p>此时我们需要下载一个natapp的客户端. 我在这里提供了网盘地址:  大家可以下载.</p> 
<p>1): 首先将下载好的natapp.exe 与 config.ini 同时赋值到 D盘的natapp目录下(这个natapp目录是自己创建的)</p> 
<p>2): 打开config.ini中的隧道密钥,改成我们自己的密钥.</p> 
<p><img src="https://images2.imgbox.com/0f/7d/eHdlMIIq_o.png" alt=""><br> </p> 
<p>这个authtoken就是我们的密钥,把这个密钥复制到config.ini的这个位置</p> 
<p><img src="https://images2.imgbox.com/67/0e/r0qk8N5e_o.png" alt=""><br> </p> 
<p>4): 打开cmd窗口,将刚才D盘下natapp目录下的natapp.exe拖动到命令行中,如下图所示</p> 
<p><img src="https://images2.imgbox.com/73/f1/1xs1JL6Y_o.png" alt=""><br> </p> 
<p>这样我们的服务器就已经创建好了,以后我们就可以通过 上面的 http:// 来访问自己的电脑了</p> 
<p><span style="color:#ff0000">注意: </span>在运行过程中,cmd命令行不可以关闭/</p> 
<p>5): 下载腾讯提供的API接口, 叫api.php,也在刚才你所下载的网盘文件中.</p> 
<p>我们把api.php文件放到 我们安装的phpStudy的目录下的 PHPTutorial的WWW目录下;</p> 
<p><img src="https://images2.imgbox.com/b4/02/9fKRexY3_o.png" alt=""><br> </p> 
<p>6): 把api.php放进去之后,打开这个文件, 查看这个文件中的 define("TOKEN","weixin") ,记住这个接口中的密钥是 weixin</p> 
<p>7): 打开我们注册过的微信公众平台,找到工具下 的<span style="color:#ff0000">基本配置</span></p> 
<p><img src="https://images2.imgbox.com/fc/2a/ke7dQiLg_o.png" alt=""><br> </p> 
<p>提交成功后,并点击右侧的启动按钮,就启动成功了.(注意这里有一些注意点:如果提交不成功,多提交几次. 后面有写有哪些注意点)</p> 
<p>8): 此时做到这里就基本上完成了,然后我们可以用自己的微信关注自己所创的公众号.随便发送一条消息.会出现下面问题:</p> 
<p><img src="https://images2.imgbox.com/d8/03/Tdz3jdin_o.png" alt=""><br> </p> 
<p>4、手动开启自动回复(这里有个坑,一定要注意)</p> 
<p>我们使用sublime将www下的api.php 文件打开,做下面操作</p> 
<p><img src="https://images2.imgbox.com/7f/50/hzhY3Tbs_o.png" alt=""><br> </p> 
<p>做了这些操作后,我们再向自己的公众号中发送消息,就可以正常回复了!</p> 
<p>三、微信的6大接收接口</p> 
<p>1. 我们想公众号发送文字消息,其就可以回复,发送图片,语音 就无法回复,这是为什么呢?</p> 
<p>只要设置就在api.php接口中.</p> 
<p>2. 微信如何接收消息的?</p> 
<p>在微信公众平台下,打开开发者工具--&gt;消息管理---&gt;接收普通消息下</p> 
<p>其中包括文本消息、图片,语音,图文等消息</p> 
<p><img src="https://images2.imgbox.com/4b/16/Ls748OvH_o.png" alt=""><br> </p> 
<p>3. 我们来分析一下api.php文件(重点)</p> 
<p>首先 $msgType = "text"; 是表示接收的是什么类型的数据</p> 
<p>$ contentStr 用来返回给我们是什么样的数据.</p> 
<p>如果我们要使用 图片,图文等相关模板,需要将平台中的&lt;XML&gt;文件复制到api.php文件中.</p> 
<p>将我们的需要展示的内容填充进去,就可以了</p> 
<p>四、具体讲解图文消息接口</p> 
<p></p> 
<h3><a target="_blank" name="_Toc502329249">1</a>、文本回复接口（文本回复四步走）</h3> 
<p></p> 
<p>问题：微信公众平台是如何把数据发送给我们的APP的。</p> 
<p>文本回复一共分为这样的几个步骤：</p> 
<p><span style="background:yellow">第一步：组装</span><span style="background:yellow">XML</span><span style="background:yellow">数据</span></p> 
<p><img src="https://images2.imgbox.com/be/25/0WTjvRDn_o.png" alt=""><br> <span style="background:yellow">第二步：定义相关的变量</span><span style="background:yellow">$msgType</span><span style="background:yellow">，</span><span style="background:yellow">$contentStr</span></p> 
<p><img src="https://images2.imgbox.com/cc/a5/VP79ym9B_o.png" alt=""></p> 
<p><span style="background:yellow">第三步：使用</span><span style="background:yellow">sprintf</span><span style="background:yellow">函数，格式化变量到</span><span style="background:yellow">%s</span><span style="background:yellow">的位置</span></p> 
<p><span style="color:red">要用到的知识点：</span><span style="color:red">sprintf</span><span style="color:red">函数，在实际项目开发主要用于格式化字符串</span></p> 
<p><span style="color:red">sprint(</span><span style="color:red">要格式化的字符串，变量</span><span style="color:red">1</span><span style="color:red">，变量</span><span style="color:red">2</span><span style="color:red">，变量</span><span style="color:red">3...)</span></p> 
<p><span style="color:red">到底有多少个变量呢，就是要格式化的字符串中，有多少个</span><span style="color:red">%s</span><span style="color:red">就有多少个变量。</span></p> 
<p><img src="https://images2.imgbox.com/c9/ed/uXR4UVmh_o.png" alt=""></p> 
<p></p> 
<p><span style="background:yellow">第四步：使用</span><span style="background:yellow">echo</span><span style="background:yellow">输出返回</span><span style="background:yellow">XML</span><span style="background:yellow">数据到微信</span><span style="background:yellow">APP</span></p> 
<p><span style="background:yellow"><img src="https://images2.imgbox.com/19/cd/yTsIBULG_o.png" alt=""><br> </span></p> 
<h3>2、微信中的图文回复接口（重点中的重点）</h3> 
<div> 
 <img src="https://images2.imgbox.com/f6/45/Gkw0Gpd5_o.png" alt=""> 
 <br> 
</div> 
<p></p> 
<h3><a target="_blank" name="_Toc502329252">3</a>、编写图文接口（四步走）</h3> 
<p><span style="background:yellow">第一步：组装</span><span style="background:yellow">XML</span><span style="background:yellow">数据（设置</span><span style="background:yellow">%s</span><span style="background:yellow">）</span></p> 
<p><span style="background:yellow"><img src="https://images2.imgbox.com/de/b4/WokmquWj_o.png" alt=""><br> </span></p> 
<p></p> 
<p>XML模板从哪里来，从微信的手册中获取：</p> 
<p><img src="https://images2.imgbox.com/aa/2e/JCOTIFPr_o.png" alt=""><br> </p> 
<p></p> 
<p>把以上代码复制放到$newsTpl代码中：</p> 
<p><img src="https://images2.imgbox.com/05/bc/8qS1UPTp_o.png" alt=""><br> </p> 
<p></p> 
<p><span style="color:red">放置完成后，不能立即停止，因为我们还没有放</span><span style="color:red">%s</span><span style="color:red">呢，必须放置</span><span style="color:red">%s</span></p> 
<p><span style="color:red"><img src="https://images2.imgbox.com/0a/c9/eng96eVR_o.png" alt=""><br> </span></p> 
<p></p> 
<p>记住：有几个%s，因为一会还要定义几个变量。</p> 
<p><span style="background:yellow">第二步：设置相关的变量（有几个</span><span style="background:yellow">%s</span><span style="background:yellow">就要定义几个变量）</span></p> 
<p><span style="color:red">我们需要定义</span><span style="color:red">6</span><span style="color:red">个变量，但是前</span><span style="color:red">3</span><span style="color:red">个变量，系统默认已经有了，</span><span style="color:red">$fromUserName</span><span style="color:red">，</span><span style="color:red">$toUserName</span><span style="color:red">，</span><span style="color:red">$time</span><span style="color:red">。所以咱们真正定义的只有</span><span style="color:red">3</span><span style="color:red">个变量。</span></p> 
<p><img src="https://images2.imgbox.com/e3/3e/52af7Szh_o.png" alt=""></p> 
<p><span style="background:yellow">第三步：使用</span><span style="background:yellow">sprintf</span><span style="background:yellow">函数格式化第一步中的字符串</span></p> 
<p><img src="https://images2.imgbox.com/7f/33/hEgcJktt_o.png" alt=""></p> 
<p><span style="background:yellow">第四步：使用</span><span style="background:yellow">echo</span><span style="background:yellow">把图文消息返回给微信的</span><span style="background:yellow">APP</span></p> 
<p><img src="https://images2.imgbox.com/9d/12/NXizKQaQ_o.png" alt=""></p> 
<p>运行结果：</p> 
<p><img src="https://images2.imgbox.com/1d/78/QRZ8MkxH_o.png" alt=""></p> 
<p></p> 
<h3><a target="_blank" name="_Toc502329253">4</a>、如果微信开发时遇到故障，改如何调试呢？</h3> 
<p></p> 
<p><span style="background:yellow">①</span><span style="background:yellow">打开浏览器，输入</span><span style="background:yellow">http://</span><span style="background:yellow">域名</span><span style="background:yellow">/api.php</span><span style="background:yellow">，看一下语法是否有错误</span></p> 
<p><span style="background:yellow"><img src="https://images2.imgbox.com/1a/40/DtDxVCS8_o.png" alt=""><br> </span></p> 
<p></p> 
<p>如果出现以上代码，代表微信接口没有问题，因为HTTP_RAW_POST_DATA没有经过腾讯服务器，只经过我们自己的服务器，所以报HTTP_RAW_POST_DATA.</p> 
<p><br> </p> 
<p><span style="font-size:18px; color:#ff0000"><strong>注意点:</strong></span></p> 
<p>1. 在运行中我们不可以关闭命令行,否则就会出现错误</p> 
<p>2. 要开启phpStudy</p> 
<p>3. 当我们电脑重启后,将natapp.exe拖入到命令行后,会从新生成一个域名.</p> 
<p><span style="white-space:pre"></span>3.1 首先先把vaild()方法给打开, 把responseMsg()方法关闭,然后在valid()方法中 添加ob_clean()方法,清除缓存,否则会验证token失败.</p> 
<p></p> 
<pre><code class="language-php">public function valid()
    {
        $echoStr = $_GET["echostr"];

        //valid signature , option
        if($this-&gt;checkSignature()){
            ob_clean(); 
            echo $echoStr;
            exit;
        }
    }</code></pre> 
<span style="white-space:pre"> </span>3.2 当启动成功后,一定要记住将api.php中的valid()方法注释掉,打开responseMsg()方法 
<br> 
<br> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2c0419b9c83f93fe757c0e27bac91361/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">（ssl 1760）商店选址问题#floyd，dijkstra#</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/db39546296c04be15a4dd3438b0f6c29/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vim 中文编码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>