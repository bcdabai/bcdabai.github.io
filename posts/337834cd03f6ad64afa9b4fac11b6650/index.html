<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>记录一次生产问题：当线程池打满，CallerRunsPolicy这个策略导致主调线程ThreadLocal变量丢失 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="记录一次生产问题：当线程池打满，CallerRunsPolicy这个策略导致主调线程ThreadLocal变量丢失" />
<meta property="og:description" content="用户信息丢失的事故总结 复现事故场景 微服务架构，用户在ThreadLocal变量中存储，每次请求进服务的时候都需要将传递过来的用户放进ThreadLocal变量，某些请求的步骤较多，导致耗时很长。
为了加快响应速度，将某些步骤并发执行。于是创建了一个线程池，参数给了核心5，最大20，队列100，拒绝策略用了自带的CallerRunsPolicy（即调用者自己执行任务）。
那么线程池如何解决ThreadLocal透传的问题呢，这里用了一个wrap包装，自己实现的，很简单：
public static Runnable wrap(Runnable r, String user) { return () -&gt; { setUser(user); try { callable.run(); } finally { setUser(null); } }; } 业务日志发现某些请求在跨越线程之后，用户信息丢失了。
同时发现另一个重要线索：用户丢失的时候线程池的使用频率很高。
于是很自然的想到是不是因为线程池被打满了，让主调线程自己执行任务的时候导致了用户信息丢失。正常情况下，任务在线程池中执行完毕了就释放用户信息，释放的是子线程的啊，是不会释放到主调线程的用户的啊。但如果主调线程亲自执行任务，会不会也释放了主掉线程的用户信息呢？
为了验证这个问题，我写了一段代码来验证：
public class Test { @Test public void test_拒绝策略() throws InterruptedException { AtomicInteger count = new AtomicInteger(); ThreadPoolExecutorWithUser executor = new ThreadPoolExecutorWithUser( 1, 2, // 1个核心线程，2个总线程数 1, TimeUnit.HOURS, new LinkedBlockingQueue&lt;&gt;(2), // 队列长度为2 r -&gt; new Thread(r, &#34;t-&#34; &#43; count." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/337834cd03f6ad64afa9b4fac11b6650/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-22T07:57:58+08:00" />
<meta property="article:modified_time" content="2023-02-22T07:57:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">记录一次生产问题：当线程池打满，CallerRunsPolicy这个策略导致主调线程ThreadLocal变量丢失</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>用户信息丢失的事故总结</h2> 
<h3><a id="_2"></a>复现事故场景</h3> 
<p>微服务架构，用户在ThreadLocal变量中存储，每次请求进服务的时候都需要将传递过来的用户放进ThreadLocal变量，某些请求的步骤较多，导致耗时很长。<br> 为了加快响应速度，将某些步骤并发执行。于是创建了一个线程池，参数给了核心5，最大20，队列100，拒绝策略用了自带的CallerRunsPolicy（即调用者自己执行任务）。</p> 
<p>那么线程池如何解决ThreadLocal透传的问题呢，这里用了一个wrap包装，自己实现的，很简单：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            callable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>业务日志发现某些请求在跨越线程之后，用户信息丢失了。<br> 同时发现另一个重要线索：用户丢失的时候线程池的使用频率很高。<br> 于是很自然的想到是不是因为线程池被打满了，让主调线程自己执行任务的时候导致了用户信息丢失。正常情况下，任务在线程池中执行完毕了就释放用户信息，释放的是子线程的啊，是不会释放到主调线程的用户的啊。但如果主调线程亲自执行任务，会不会也释放了主掉线程的用户信息呢？<br> 为了验证这个问题，我写了一段代码来验证：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> test_拒绝策略<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadPoolExecutorWithUser</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutorWithUser</span><span class="token punctuation">(</span>
                <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 1个核心线程，2个总线程数</span>
                <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 队列长度为2</span>
                r <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"t-"</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// 拒绝策略：JDK自带的调用者自己执行任务的策略</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在提交给线程池之前，先在主调线程中设置user信息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> taskId <span class="token operator">=</span> i<span class="token punctuation">;</span>
            executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 睡眠，是为了模拟真是业务场景，否则线程执行太快，还没提交完任务呢，前面提交的任务就结束了，这样不能打满线程池</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">String</span> user <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取线程本地中的用户信息</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"taskId: '%s', thread: '%s', user: '%s'\n"</span><span class="token punctuation">,</span> taskId<span class="token punctuation">,</span> name<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"t-"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 识别线程池的名称，如果不是线程池的线程执行的任务，则打印出来</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"taskId: '%s', 我是拒绝策略执行的\n"</span><span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 当用户信息为null的时候，打印出来</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"taskId: '%s', thread: '%s' is null\n"</span><span class="token punctuation">,</span> taskId<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> user <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main user = "</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"done. "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorWithUser</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutorWithUser</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> threadFactory<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">wrap</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 线程本地变量，用来储存用户信息，每个线程有独立的存储空间</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tlUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        tlUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        <span class="token keyword">return</span> tlUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>输出结果：</p> 
<pre><code class="prism language-sql">taskId: <span class="token string">'0'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-0'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'4'</span><span class="token punctuation">,</span> thread: <span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'3'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-1'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'4'</span><span class="token punctuation">,</span> 我是拒绝策略执行的 				<span class="token comment">-- 红色</span>
<span class="token punctuation">[</span>Running<span class="token punctuation">,</span> pool size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> active threads <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> queued tasks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> completed tasks <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">]</span>
taskId: <span class="token string">'2'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-1'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'1'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-0'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'5'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-1'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'null'</span>
taskId: <span class="token string">'5'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-1'</span> <span class="token operator">is</span> <span class="token boolean">null</span> 				<span class="token comment">-- 红色</span>
<span class="token punctuation">[</span><span class="token keyword">Terminated</span><span class="token punctuation">,</span> pool size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> active threads <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> queued tasks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> completed tasks <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">]</span>
<span class="token keyword">user</span> <span class="token operator">=</span> <span class="token boolean">null</span>
done<span class="token punctuation">.</span> 
</code></pre> 
<p>线程池的容量为2，队列的容量为2，也就是说线程池最大能够同时吃下的任务数量是线程池容量2+队列容量2 = 4个任务。<br> 但是for循环给了6个任务，为了防止任务执行太快在任务里面加了睡眠100ms，以保证可以打满线程池。</p> 
<ul><li>0号任务，由于线程池是空的，所以分配一个核心线程去执行，于是0号任务给了0号线程</li><li>1号任务，由于线程池的核心线程数已经满了，所以加入队列等待，从结果来看1号任务在中后部的位置出被执行</li><li>2号任务，由于核心线程满了，但队列还有一个位置，所以同样加入队列等待，此时队列满了</li><li>3号任务，由于核心和队列都已满了，但还未达到线程池的最大数量，于是开启了一个新的线程（1号线程）来执行任务3。从结果来看任务3是在任务0之后就被执行了</li><li>4号任务，由于核心线程数、等待队列已满，并且线程池活动的线程数量也达到了上限（2个），所以走线程池的拒绝策略，拒绝策略的逻辑如下：<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 看源码其实就是判断线程池未关闭就直接调用run方法，也就是主调线程自己执行任务。<br> 所以4号任务的线程名称是“main”，而不是<code>t-1</code> 这样的线程池名称。<br> 由于main线程都亲自上战场执行任务了，所以for循环也被阻塞了，直到4号任务执行完毕后，main线程才能继续执行for循环。但是，就在4号任务睡眠了100ms醒来即将结束任务之际，由于这个任务被包装过，在原始任务执行完毕后，就进入了包装任务的finally代码块，在这里将执行代码：<code>setUser(null);</code> 。这句话将在main线程中将用户信息设置为<code>null</code>。于是下一个任务就拿不到用户信息了。</li><li>5号任务，等到4号任务执行结束后，main线程才将流程恢复for循环，于是到了5号任务提交到线程池，此时发现线程池有空余资源来处理了，应该放入了队列，因为此时两个线程正在执行此前放入队列的1号和2号任务，这两个任务此刻应该还在睡眠中，但等到1号和2号任务都处理完毕了，就会将5号任务开始执行。由于5号任务是在main线程清空了user信息之后才提交的，所以在线程池里也没有用户信息，可以看打打印了用户为null</li></ul> 
<p>以上就是6个任务的执行过程<br> 另外，我还多打印了一些变量，两次打印了线程池的状态信息，第一次是刚提交完任务的时候：</p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>Running<span class="token punctuation">,</span> pool size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> active threads <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> queued tasks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> completed tasks <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> 
<p>可以看到线程池的线程数量是2，已经最大了，计划线程数量也是2，而队列数量是1，为什么队列没有满，别着急，看看已完成任务数是2，加起来已经5个任务了，再加上main线程还执行了一个任务，总共是6个任务，齐了。所以队列没有满，并不是什么问题，而是因为曾经满过，但被线程消费了一个任务，所以还剩余1个任务。此时线程池的状态是运行状态</p> 
<p>等到关闭线程池后，再次打印线程池的状态信息：</p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span><span class="token keyword">Terminated</span><span class="token punctuation">,</span> pool size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> active threads <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> queued tasks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> completed tasks <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> 
<p>首先可以看到线程池的状态是<code>Terminated</code>，表示线程池已经终止了，已完成任务从上一次的2变为5个，从这里也能证明线程池总共只执行了5个任务，确实有一个任务是被main线程执行了。</p> 
<p>在往下面，还打印了user，这是main线程提交完所有的任务后，再次查看main线程的用户信息，结果发现被清空了，这就是生产环境出现的场景。原本的设计是让主掉线程的用户信息能够透传进线程池的，结果没想到一行finally块的清理代码却引发了这么大个生产事故，罪过罪过！</p> 
<p>但还是要自我鼓励一下，毕竟一个高逼格的程序员就是在不停的犯错和解决问题中茁壮成长的。发现问题就已经解决了一半的问题了，剩下的就是写一个应对策略</p> 
<h3><a id="_153"></a>自定义拒绝策略</h3> 
<p>自己实现接口<code>RejectedExecutionHandler</code>，在内部直接调用任务的run方法。不同的是，在调用run方法的前后增加一个读取user和设置user的动作：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CallerRunsWithUser</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 调用执行之前先保留线程本地变量，因为run方法之后会清理线程本地变量</span>
            <span class="token class-name">String</span> oldUser <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 将执行任务之前的变量存回去</span>
                <span class="token function">setUser</span><span class="token punctuation">(</span>oldUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将这个自定义的拒绝策略带入之前的代码中：</p> 
<pre><code class="prism language-java"><span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ThreadPoolExecutorWithUser</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutorWithUser</span><span class="token punctuation">(</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        r <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"t-"</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token comment">//        new ThreadPoolExecutor.CallerRunsPolicy()</span>
        <span class="token keyword">new</span> <span class="token class-name">CallerRunsWithUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果如下：</p> 
<pre><code class="prism language-sql">taskId: <span class="token string">'3'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-1'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'4'</span><span class="token punctuation">,</span> thread: <span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'4'</span><span class="token punctuation">,</span> 我是拒绝策略执行的 			<span class="token comment">-- 红色</span>
<span class="token punctuation">[</span>Running<span class="token punctuation">,</span> pool size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> active threads <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> queued tasks <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> completed tasks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">]</span>
taskId: <span class="token string">'0'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-0'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'1'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-1'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'2'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-0'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
taskId: <span class="token string">'5'</span><span class="token punctuation">,</span> thread: <span class="token string">'t-1'</span><span class="token punctuation">,</span> <span class="token keyword">user</span>: <span class="token string">'张三'</span>
<span class="token punctuation">[</span><span class="token keyword">Terminated</span><span class="token punctuation">,</span> pool size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> active threads <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> queued tasks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> completed tasks <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">]</span>
main <span class="token keyword">user</span> <span class="token operator">=</span> 张三
done<span class="token punctuation">.</span> 
</code></pre> 
<p>同样的任务数量，同样的线程数量，同样的队列容量，但不同的拒绝策略。从结果可以看到，4号任务已经是被拒绝策略执行的，是用err流打印，在console是红色，但在这里就丢失了颜色信息，我在后面追加了红色的备注。</p> 
<p>与上次执行不同的是，5号任务中的用户信息不再是<code>null</code>了，并且提交完所有任务后的main线程中的用户信息也不再是<code>null</code>了。</p> 
<p>至此，成功修复一个bug，下班！</p> 
<hr> 
<p>你有更多多线程的问题欢迎撩我。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab06d1bece68a12a46213e89e353bee4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Kafka 提交 offset 机制</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3f292f2669bee331ce58d2a8536dc845/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java继承中的子类父类构造方法的调用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>