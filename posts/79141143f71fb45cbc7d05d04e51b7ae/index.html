<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboot&#43;thymeleaf&#43;shiro标签 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboot&#43;thymeleaf&#43;shiro标签" />
<meta property="og:description" content="1，pom中加入依赖 &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt; &lt;version&gt;1.5.6.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.thymeleaf/thymeleaf --&gt; &lt;dependency&gt; &lt;groupId&gt;org.thymeleaf&lt;/groupId&gt; &lt;artifactId&gt;thymeleaf&lt;/artifactId&gt; &lt;version&gt;${thymeleaf.version}&lt;/version&gt; &lt;/dependency&gt; &lt;!-- shiro安全框架 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt; &lt;/dependency&gt; &lt;!--thymeleaf-shiro-extras--&gt; &lt;dependency&gt; &lt;groupId&gt;com.github.theborakompanioni&lt;/groupId&gt; &lt;artifactId&gt;thymeleaf-extras-shiro&lt;/artifactId&gt; &lt;version&gt;1.2.1&lt;/version&gt; &lt;/dependency&gt; 2，用户-角色-权限的表关系 实体类
//用户表 public class User { private Integer userId; private String userName; private Set&lt;Role&gt; roles = new HashSet&lt;&gt;(); } //角色表 public class Role { private Integer id; private String role; private Set&lt;Module&gt; modules = new HashSet&lt;&gt;(); private Set&lt;User&gt; users = new HashSet&lt;&gt;(); } //权限表 public class Module { private Integer mid; private String mname; private Set&lt;Role&gt; roles = new HashSet&lt;&gt;(); } 查询接口" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/79141143f71fb45cbc7d05d04e51b7ae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-07T10:24:07+08:00" />
<meta property="article:modified_time" content="2022-04-07T10:24:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboot&#43;thymeleaf&#43;shiro标签</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="1pom_0"></a>1，pom中加入依赖</h4> 
<pre><code>	&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
			&lt;version&gt;1.5.6.RELEASE&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;!-- https://mvnrepository.com/artifact/org.thymeleaf/thymeleaf --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.thymeleaf&lt;/groupId&gt;
			&lt;artifactId&gt;thymeleaf&lt;/artifactId&gt;
			&lt;version&gt;${thymeleaf.version}&lt;/version&gt;
		&lt;/dependency&gt;
        &lt;!-- shiro安全框架 --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;
			&lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;
			&lt;version&gt;1.4.0&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;!--thymeleaf-shiro-extras--&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.github.theborakompanioni&lt;/groupId&gt;
			&lt;artifactId&gt;thymeleaf-extras-shiro&lt;/artifactId&gt;
			&lt;version&gt;1.2.1&lt;/version&gt;
		&lt;/dependency&gt;
</code></pre> 
<h4><a id="2_27"></a>2，用户-角色-权限的表关系</h4> 
<p>实体类</p> 
<pre><code>//用户表
public class User {
    private Integer userId;
    private String userName;
    private Set&lt;Role&gt; roles = new HashSet&lt;&gt;();
}
//角色表
public class Role {
    private Integer id;
    private String role;
    private Set&lt;Module&gt; modules = new HashSet&lt;&gt;();
    private Set&lt;User&gt; users = new HashSet&lt;&gt;();
}
//权限表
public class Module {
    private Integer mid;
    private String mname;
    private Set&lt;Role&gt; roles = new HashSet&lt;&gt;();
}
</code></pre> 
<p>查询接口</p> 
<pre><code class="prism language-java"><span class="token comment">//用户查询</span>
<span class="token operator">&lt;</span>resultMap id<span class="token operator">=</span><span class="token string">"BaseResultMap"</span> type<span class="token operator">=</span><span class="token string">"com.lanyu.common.model.User"</span> <span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>id column<span class="token operator">=</span><span class="token string">"user_id"</span> property<span class="token operator">=</span><span class="token string">"userId"</span> jdbcType<span class="token operator">=</span><span class="token string">"INTEGER"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result column<span class="token operator">=</span><span class="token string">"user_name"</span> property<span class="token operator">=</span><span class="token string">"userName"</span> jdbcType<span class="token operator">=</span><span class="token string">"VARCHAR"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 多对多关联映射：collection <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>collection property<span class="token operator">=</span><span class="token string">"roles"</span> ofType<span class="token operator">=</span><span class="token string">"Role"</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>id property<span class="token operator">=</span><span class="token string">"id"</span> column<span class="token operator">=</span><span class="token string">"c_id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">"role"</span> column<span class="token operator">=</span><span class="token string">"role"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>collection property<span class="token operator">=</span><span class="token string">"modules"</span> ofType<span class="token operator">=</span><span class="token string">"Module"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>id property<span class="token operator">=</span><span class="token string">"mid"</span> column<span class="token operator">=</span><span class="token string">"mid"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">"mname"</span> column<span class="token operator">=</span><span class="token string">"mname"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>collection<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>collection<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>resultMap<span class="token operator">&gt;</span>
  
<span class="token comment">//查询用户信息，返回结果会自动分组，得到用户信息</span>
  <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"selectByPhone"</span> resultMap<span class="token operator">=</span><span class="token string">"BaseResultMap"</span> parameterType<span class="token operator">=</span><span class="token string">"java.lang.String"</span> <span class="token operator">&gt;</span>
    SELECT
	  u<span class="token punctuation">.</span>*<span class="token punctuation">,</span> r<span class="token punctuation">.</span>*<span class="token punctuation">,</span> m<span class="token punctuation">.</span>*
    FROM
        sys_user u
    INNER JOIN sys_user_role ur ON ur<span class="token punctuation">.</span>userId <span class="token operator">=</span> u<span class="token punctuation">.</span>user_id
    INNER JOIN sys_role r ON r<span class="token punctuation">.</span>rid <span class="token operator">=</span> ur<span class="token punctuation">.</span>roleid
    INNER JOIN sys_role_module mr ON mr<span class="token punctuation">.</span>rid <span class="token operator">=</span> r<span class="token punctuation">.</span>rid
    INNER JOIN sys_module m ON mr<span class="token punctuation">.</span>mid <span class="token operator">=</span> m<span class="token punctuation">.</span>mid
    WHERE
	  u<span class="token punctuation">.</span>user_name<span class="token operator">=</span>#<span class="token punctuation">{<!-- --></span>username<span class="token punctuation">}</span> or u<span class="token punctuation">.</span>phone<span class="token operator">=</span>#<span class="token punctuation">{<!-- --></span>username<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="3shiro_83"></a>3，编写shiro核心类</h4> 
<pre><code>@Configuration
public class ShiroConfiguration {
    
    //用于thymeleaf模板使用shiro标签
    @Bean
    public ShiroDialect shiroDialect() {
        return new ShiroDialect();
    }

    @Bean(name="shiroFilter")
    public ShiroFilterFactoryBean shiroFilter(@Qualifier("securityManager") SecurityManager manager) {
        ShiroFilterFactoryBean bean=new ShiroFilterFactoryBean();
        bean.setSecurityManager(manager);
        //配置登录的url和登录成功的url
        bean.setLoginUrl("/loginpage");
        bean.setSuccessUrl("/indexpage");
        //配置访问权限
        LinkedHashMap&lt;String, String&gt; filterChainDefinitionMap=new LinkedHashMap&lt;&gt;();
//        filterChainDefinitionMap.put("/loginpage*", "anon"); //表示可以匿名访问
        filterChainDefinitionMap.put("/admin/*", "authc");//表示需要认证才可以访问
        filterChainDefinitionMap.put("/logout*","anon");
        filterChainDefinitionMap.put("/img/**","anon");
        filterChainDefinitionMap.put("/js/**","anon");
        filterChainDefinitionMap.put("/css/**","anon");
        filterChainDefinitionMap.put("/fomts/**","anon");
        filterChainDefinitionMap.put("/**", "anon");
        bean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        return bean;
    }
    //配置核心安全事务管理器
    @Bean(name="securityManager")
    public SecurityManager securityManager(@Qualifier("authRealm") AuthRealm authRealm) {
        System.err.println("--------------shiro已经加载----------------");
        DefaultWebSecurityManager manager=new DefaultWebSecurityManager();
        manager.setRealm(authRealm);
        return manager;
    }
    //配置自定义的权限登录器
    @Bean(name="authRealm")
    public AuthRealm authRealm(@Qualifier("credentialsMatcher") CredentialsMatcher matcher) {
        AuthRealm authRealm=new AuthRealm();
        authRealm.setCredentialsMatcher(matcher);
        return authRealm;
    }
    //配置自定义的密码比较器
    @Bean(name="credentialsMatcher")
    public CredentialsMatcher credentialsMatcher() {
        return new CredentialsMatcher();
    }
    @Bean
    public LifecycleBeanPostProcessor lifecycleBeanPostProcessor(){
        return new LifecycleBeanPostProcessor();
    }
    @Bean
    public DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator(){
        DefaultAdvisorAutoProxyCreator creator=new DefaultAdvisorAutoProxyCreator();
        creator.setProxyTargetClass(true);
        return creator;
    }
    @Bean
    public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(@Qualifier("securityManager") SecurityManager manager) {
        AuthorizationAttributeSourceAdvisor advisor=new AuthorizationAttributeSourceAdvisor();
        advisor.setSecurityManager(manager);
        return advisor;
    }
}

— - - -- - -- - -- - -- - - -- - - - -- 
public class AuthRealm extends AuthorizingRealm {
    @Autowired
    private UserService userService;

    //认证.登录
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
        UsernamePasswordToken utoken=(UsernamePasswordToken) token;//获取用户输入的token
        String username = utoken.getUsername();
        User user = userService.selectByPhone(username);
        return new SimpleAuthenticationInfo(user, user.getPassword(),this.getClass().getName());//放入shiro.调用CredentialsMatcher检验密码
    }
    //授权
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principal) {
        User user=(User) principal.fromRealm(this.getClass().getName()).iterator().next();//获取session中的用户
        List&lt;String&gt; permissions=new ArrayList&lt;&gt;();
        Set&lt;Role&gt; roles = user.getRoleList();
        SimpleAuthorizationInfo info=new SimpleAuthorizationInfo();
        List&lt;String&gt; listrole = new ArrayList&lt;&gt;();
        if(roles.size()&gt;0) {
            for(Role role : roles) {
                if(!listrole.contains(role.getRole())){
                    listrole.add(role.getRole());
                }
                Set&lt;Module&gt; modules = role.getModules();
                if(modules.size()&gt;0) {
                    for(Module module : modules) {
                        permissions.add(module.getMname());
                    }
                }
            }
        }
        info.addRoles(listrole);                       //将角色放入shiro中.
    info.addStringPermissions(permissions);         //将权限放入shiro中.
        return info;
    }

}


//自定义密码比较器
public class CredentialsMatcher extends SimpleCredentialsMatcher {

    private  Logger logger = Logger.getLogger(CredentialsMatcher.class);

    @Override
    public boolean doCredentialsMatch(AuthenticationToken token, AuthenticationInfo info) {
        UsernamePasswordToken utoken=(UsernamePasswordToken) token;
        //所需加密的参数  即  用户输入的密码
        String source = String.valueOf(utoken.getPassword());
        //[盐] 一般为用户名 或 随机数
        String salt = utoken.getUsername();
        //加密次数
        int hashIterations = 50;
        SimpleHash sh = new SimpleHash("md5", source, salt, hashIterations);
        String Strsh =sh.toHex();
        //打印最终结果
        logger.info("正确密码为："+Strsh);
        //获得数据库中的密码
        String dbPassword= (String) getCredentials(info);
        logger.info("数据库密码为："+dbPassword);
        //进行密码的比对
        return this.equals(Strsh, dbPassword);
    }

}
</code></pre> 
<h4><a id="4_222"></a>4，登录控制器</h4> 
<pre><code>    @RequestMapping("/loginUser")
    public String loginUser(String username,String password,HttpSession session) {
        UsernamePasswordToken usernamePasswordToken=new UsernamePasswordToken(username,password);
        Subject subject = SecurityUtils.getSubject();
        Map map=new HashMap();
        try {
            subject.login(usernamePasswordToken);   //完成登录
            User user=(User) subject.getPrincipal();
            session.setAttribute("user", user);
            return "index";
        } catch (IncorrectCredentialsException e) {
            map.put("msg", "密码错误");
        } catch (LockedAccountException e) {
            map.put("msg", "登录失败，该用户已被冻结");
        } catch (AuthenticationException e) {
            map.put("msg", "该用户不存在");
        } catch (Exception e) {
            return "login";//返回登录页面
        }
        return map.toString();
    }
</code></pre> 
<h4><a id="5thymeleaf_247"></a>5，thymeleaf页面权限控制</h4> 
<pre><code>&lt;html lang="zh_CN" xmlns:th="http://www.thymeleaf.org"
	  xmlns:shiro="http://www.pollix.at/thymeleaf/shiro"&gt;
	  
//作为属性控制
&lt;button  type="button" shiro:authenticated="true" class="btn btn-outline btn-default"&gt;
	&lt;i class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/i&gt;
&lt;/button&gt;
//作为标签
&lt;shiro:hasRole name="admin"&gt;
	&lt;button type="button" class="btn btn-outline btn-default"&gt;
		&lt;i class="glyphicon glyphicon-heart" aria-hidden="true"&gt;&lt;/i&gt;
	&lt;/button&gt;
&lt;/shiro:hasRole&gt;
</code></pre> 
<h4><a id="6_264"></a>6,标签说明</h4> 
<pre><code>guest标签
　　&lt;shiro:guest&gt;
　　&lt;/shiro:guest&gt;
　　用户没有身份验证时显示相应信息，即游客访问信息。

user标签
　　&lt;shiro:user&gt;　　
　　&lt;/shiro:user&gt;
　　用户已经身份验证/记住我登录后显示相应的信息。

authenticated标签
　　&lt;shiro:authenticated&gt;　　
　　&lt;/shiro:authenticated&gt;
　　用户已经身份验证通过，即Subject.login登录成功，不是记住我登录的。

notAuthenticated标签
　　&lt;shiro:notAuthenticated&gt;
　　&lt;/shiro:notAuthenticated&gt;
　　用户没有身份验证通过，即没有调用Subject.login进行登录，包括记住我自动登录的也属于未进行身份验证。

principal标签
　　&lt;shiro: principal/&gt;
　　&lt;shiro:principal property="username"/&gt;
　　相当于((User)Subject.getPrincipals()).getUsername()。

lacksPermission标签
　　&lt;shiro:lacksPermission name="org:create"&gt;
　　&lt;/shiro:lacksPermission&gt;
　　如果当前Subject没有权限将显示body体内容。

hasRole标签
　　&lt;shiro:hasRole name="admin"&gt;　　
　　&lt;/shiro:hasRole&gt;
　　如果当前Subject有指定角色将显示body体内容。

hasAnyRoles标签
　　&lt;shiro:hasAnyRoles name="admin,user"&gt;
　　&lt;/shiro:hasAnyRoles&gt;
　　如果当前Subject有任意一个角色（或的关系）将显示body体内容。

lacksRole标签
　　&lt;shiro:lacksRole name="abc"&gt;　　
　　&lt;/shiro:lacksRole&gt;
　　如果当前Subject没有角色将显示body体内容。

hasPermission标签
　　&lt;shiro:hasPermission name="user:create"&gt;　　
　　&lt;/shiro:hasPermission&gt;
　　如果当前Subject有权限将显示body体内容
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/da1186c2b2cf5f8a29abd23868ecdb6c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">逻辑卷管理 LVM</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/518e03b8c0bf2b39f3ea728c51cecc76/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于ARM核心板实现的BMS可行性方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>