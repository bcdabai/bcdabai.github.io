<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PHP &amp; Golang 关于Grpc 学习笔记 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PHP &amp; Golang 关于Grpc 学习笔记" />
<meta property="og:description" content="Grpc 入门介绍 gRPC 官方文档中文版_V1.0
安装教程 在Golang 下安装 go get google.golang.org/grpc v1.56.1 go get google.golang.org/protobuf v1.30.0 在PHP下安装grpc 扩展 使用composer 安装grpc和protobuf（推荐使用）。
{ &#34;name&#34;: &#34;root/work&#34;, &#34;type&#34;: &#34;composer-plugin&#34;, &#34;autoload&#34;: { &#34;psr-4&#34;: { &#34;Root\\Work\\&#34;: &#34;src/&#34; } }, &#34;authors&#34;: [ { &#34;name&#34;: &#34;wangxiaoyang&#34; } ], &#34;require&#34;: { &#34;grpc/grpc&#34;: &#34;^1.52&#34;, &#34;google/protobuf&#34;: &#34;^3.23&#34; } } 安装php扩展（grpc.so,protobuf.so）
pecl install grpc pecl install protobuf grpc_php_plugin 依赖安装(安装过程较慢)(用于生成客户端代码，可手动写客户端代码)
git clone -b RELEASE_TAG_HERE https://github.com/grpc/grpc cd grpc git submodule update --init mkdir -p cmake/build cd cmake/build cmake ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f6a82f63d651f8ace98ff458c647fd0b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-07T16:07:53+08:00" />
<meta property="article:modified_time" content="2023-07-07T16:07:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PHP &amp; Golang 关于Grpc 学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4><strong>Grpc 入门介绍</strong></h4> 
<p><a href="http://doc.oschina.net/grpc?t=58008" rel="nofollow" title="gRPC 官方文档中文版_V1.0">gRPC 官方文档中文版_V1.0</a></p> 
<h4><strong>安装教程</strong></h4> 
<h5>在Golang 下安装</h5> 
<pre><code class="hljs">go get google.golang.org/grpc v1.56.1 
go get google.golang.org/protobuf v1.30.0 </code></pre> 
<h5>在PHP下安装grpc 扩展</h5> 
<ol><li> <p>使用composer 安装grpc和protobuf（推荐使用）。</p> <pre><code class="hljs">{
  "name": "root/work",
  "type": "composer-plugin",
  "autoload": {
    "psr-4": {
      "Root\\Work\\": "src/"
    }
  },
  "authors": [
    {
      "name": "wangxiaoyang"
    }
  ],
  "require": {
    "grpc/grpc": "^1.52",
    "google/protobuf": "^3.23"
  }
}</code></pre> <p></p> </li><li> <p>安装php扩展（grpc.so,protobuf.so）</p> <pre><code class="hljs">pecl install grpc
pecl install protobuf</code></pre> <p></p> </li><li> <p>grpc_php_plugin 依赖安装(安装过程较慢)(用于生成客户端代码，可手动写客户端代码)</p> <pre><code class="hljs">git clone -b RELEASE_TAG_HERE https://github.com/grpc/grpc
cd grpc
git submodule update --init
mkdir -p cmake/build
cd cmake/build
cmake ../..
make protoc grpc_php_plugin</code></pre> </li></ol> 
<p>安装protobuf 代码编辑器</p> 
<ol><li> <p>Mac 下推荐使用 brew 安装。安装命令</p> <pre><code class="hljs">brew install protobuf</code></pre> <p></p> </li><li> <p>Windows 下参考：https://zhuanlan.zhihu.com/p/361997082</p> </li><li> <p>安装完成后通过命令： protoc 检查是否成功</p> <p><img alt="" height="612" src="https://images2.imgbox.com/8a/74/Gd6u1y0L_o.png" width="1200"></p> <p> </p> </li><li> <p>关于对protoc 的使用说明</p> 
  <ol><li> <p>在Golang 下编译命令</p> <pre><code class="hljs">protoc --proto_path=. --go_out=. proto/greeter/greeter.proto </code></pre> </li><li> <p>PHP下编译命令</p> <pre><code class="hljs">protoc --proto_path=. --php_out=. proto/greeter/greeter.proto </code></pre> </li></ol></li><li> <p>搜索参数路径</p> 
  <ol><li> <p>即 -IPATH,--proto_path=PATH ,表示要在哪个文件路径下搜索.proto 文件，既可以用-I 指定，也可以通过--proto_path= 指定路径。</p> </li><li> <p>当不指定路径时，默认当前路径， 也可以指定多个路径，在多个路径下搜索。</p> </li><li> <p>如下命令。含义相同</p> <pre><code class="hljs">protoc --go_out=. proto/greeter/greeter.proto

#点号表示当前路径，注意-I参数没有等于号
protoc -I. --go_out=. proto/greeter/greeter.proto 

protoc --proto_path=. --go_out=. proto/greeter/greeter.proto </code></pre> <p></p> </li></ol></li><li> <p>语言插件路径</p> 
  <ol><li> <p>如： --cpp_out=, php_out= 等，若protoc 内置语言，则无需另外安装。内置语言如下：</p> <img alt="" height="636" src="https://images2.imgbox.com/e6/e4/NzjUYiet_o.png" width="1200"></li></ol><p> </p> </li><li> <p>若使用没有内置的语言，则需要单独安装插件。如：golang 的--go_out= , 对应的插件为：<em>protoc-gen-go</em></p> 
  <ol><li> <p>安装命令如下</p> <pre><code class="hljs"># 最新版
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

# 指定版本
go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.3.0</code></pre> <p></p> </li></ol></li><li> <p>proto文件位置参数</p> 
  <ol><li> <p>即@&lt;filename&gt; 参数，指定了.proto 的文件具体位置， 如:</p> <p>        <em>/Users/yancy/project/go/src/grpc-client/hello/hello.proto</em></p> </li></ol></li><li> <p>Protobuf 语法规范</p> <p>https://www.topgoer.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Protobuf%E8%AF%AD%E6%B3%95.html</p> 
  <ol><li> <p>见资料：<a href="https://www.topgoer.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Protobuf%E8%AF%AD%E6%B3%95.html" rel="nofollow" title="Protobuf语法 · Go语言中文文档">Protobuf语法 · Go语言中文文档</a></p> </li></ol></li></ol> 
<h4>Demo </h4> 
<ol><li> <p>编写.proto 文件</p> <pre><code class="language-python">syntax = "proto3"; // 指定proto版本

package hello;     // 指定默认包名// 指定golang包名
option go_package = "./hello";// 定义Hello服务
service Hello {
  // 定义SayHello方法
  rpc SayHello(HelloRequest) returns (HelloResponse) {}
}
// HelloRequest 请求结构
message HelloRequest {
  string name = 1;
}
// HelloResponse 响应结构
message HelloResponse {
  string message = 1;
  int64 code = 2;
}</code></pre> <p></p> </li><li> <p>在golang下生成go文件</p> <pre><code class="language-python">protoc --go_out=./ --go_opt=paths=source_relative --go-grpc_out=./ --go-grpc_opt=paths=source_relative hello.proto</code></pre> <p></p> </li><li> <p>生成文件路径</p> <img alt="" height="850" src="https://images2.imgbox.com/f4/24/Ex7IShVs_o.png" width="898"></li><li> <p>编写gRpc服务端代码</p> <pre><code class="language-Go">// Package server /**
package main

import (
   "context"
   "fmt"
   "google.golang.org/grpc"
   pb "grpc-client/hello"
   "log"
   "net"
)

const Port = ":50051"

type server struct {
   pb.UnimplementedHelloServer
}

func (s *server) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloResponse, error) {
   log.Printf("Received: %v\n", in.GetName())
   return &amp;pb.HelloResponse{Message: "Hello, " + in.GetName()}, nil
}

func main() {
   listen, err := net.Listen("tcp", Port)

   if err != nil {
      log.Fatalf("failed to listen: %v", err)
   }
   s := grpc.NewServer()
   pb.RegisterHelloServer(s, &amp;server{})
   fmt.Printf("Starting listen on port: %s", Port)
   if err := s.Serve(listen); err != nil {
      log.Fatalf("failed to serve: %v", err)
   }
}</code></pre> <p></p> </li><li> <p>编写客户端代码</p> 
  <ol><li> <p>Golang 客户端代码</p> <pre><code class="language-Go">// Package client /**
package main

import (
   "golang.org/x/net/context"
   "google.golang.org/grpc"
   "google.golang.org/grpc/credentials/insecure"
   "google.golang.org/grpc/grpclog"
   pb "grpc-client/hello"
   "log"
)

const (
   Addr = "127.0.0.1:50051"
)

func main() {
   conn, err := grpc.Dial(Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
   if err != nil {
      log.Fatalf("could not greet: %v", err)
   }
   defer conn.Close()

   // 初始化客户端
   c := pb.NewHelloClient(conn)
   // 调用方法
   req := &amp;pb.HelloRequest{Name: "gRPC"}
   res, err := c.SayHello(context.Background(), req)

   if err != nil {
      grpclog.Fatalln(err)
   }
   log.Printf("Greeting: %s", res.GetMessage())
}</code></pre> <p></p> </li><li> <p>PHP 客户端代码</p> <pre><code class="language-php">&lt;?php

namespace Grpc\Client;

use Grpc\BaseStub;
use Grpc\Hello\HelloRequest;
use Grpc\UnaryCall;

class HelloClient extends BaseStub
{
    /**
     * @throws \Exception
     */
    public function __construct($hostname, $opts, $channel = null)
    {
        parent::__construct($hostname, $opts, $channel);
    }


    public function sayHello(HelloRequest $argument, $metadata = [], $options = []): UnaryCall
    {
        return $this-&gt;_simpleRequest('Grpc.Hello.Hello/SayHello',
            $argument,
            ['Grpc\Hello\HelloResponse', 'decode'],
            $metadata, $options);
    }

}</code></pre> <p></p> </li></ol></li><li> <p>测试</p> <p></p> 
  <ol><li> <p>PHP客户端接口测试代码</p> <pre><code class="language-php">public function helloRpcAction()
{

    $hostname = "127.0.0.1:50051";
    try {
        $client = new HelloClient($hostname, [
            'credentials' =&gt; ChannelCredentials::createInsecure(),
        ]);
        $request = new HelloRequest();

        $request-&gt;setName("phalcon");

        list($response, $status) = $client-&gt;SayHello($request)-&gt;wait();
        if ($status-&gt;code != STATUS_OK) {
            ErrorHandler::setErrorInfo($status-&gt;code, $status-&gt;details);
            return FALSE;
        }
        var_dump($response-&gt;getMessage());
        var_dump($response-&gt;getCode());
        var_dump($response-&gt;getData());
        die;
    } catch (\Exception $exception) {
        var_dump($exception-&gt;getMessage());
    }
}</code></pre> <p></p> </li><li> <p>启用服务端</p> <img alt="" height="138" src="https://images2.imgbox.com/f7/68/SOdpOdVR_o.png" width="1078"></li><li> <p>客户端调用</p> <p></p> 
    <ol><li> <p>golang客户端调用：</p> <img alt="" height="240" src="https://images2.imgbox.com/11/b9/k5GBDBBC_o.png" width="1200"></li><li> <p>php客户端调用：</p> <img alt="" height="668" src="https://images2.imgbox.com/19/eb/eQUvIqjw_o.png" width="882"></li><li></ol></li></ol></li></ol> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cf384798af103f9d9d0b612c834c7325/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">easyexcel自定义样式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9ed352271b200b963ed36488f739387a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">根据Java实体生成建表SQL(2.0版本)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>