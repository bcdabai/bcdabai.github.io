<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【共享内存】共享内存（Shared Memory）与进程通信 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【共享内存】共享内存（Shared Memory）与进程通信" />
<meta property="og:description" content="目录
一、共享内存概述
二、共享内存操作
1）获得一个共享存储标识符：shmget函数
2）共享内存映射(attach)：shmat函数
3）解除共享内存映射(detach)：shmdt函数
4）共享内存控制：shmctl函数
总结：
一、共享内存概述 共享内存允许两个或者多个进程共享给定的存储区域。
共享内存的特点：
1）共享内存是进程间共享数据的一种最快的方法。
一个进程向共享内存区域写入了数据，共享这个内存区域的所有进程就可以立刻看到其中的内容。
2）使用共享内存要注意的是多个进程之间对一个给定存储区域访问的互斥。
若一个进程正在向共享内存区写数据，则在它做完这一步操作前，别的进程不应当去读、写这些数据。
共享内存示意图：
共享内存是进程间通信方式中效率最高的，原因在于进程是直接在物理内存上进行操作，将物理地址映射到用户进程这，所以只要对其地址进行操作，就是直接对物理地址操作。
二、共享内存操作 在ubuntu12.04中共享内存限制如下：
共享存储区的最小字节数：1共享存储区的最大字节数：32M共享内存区的最大个数：4096每个进程最多能映射的共享存储区的个数：4096 使用shell命令操作共享内存：
查看共享内存：ipcs -m
删除共享内存：ipcrm -m shmid
1）获得一个共享存储标识符：shmget函数 shmget函数：
#include&lt;sys/ipc.h&gt;
#include&lt;sys/shm.h&gt;
int shmget(key_t key, size_t size, int shmflg);
功能：创建一个共享内存
参数：
key：键值，唯一的键值确定唯一的共享内存
size：创建的共享内存的大小
shmflg：共享内存的访问权限
一般为IPC_CREAT | 0777
返回值：
成功：共享内存的id
失败：-1 代码示例：
#include&lt;sys/ipc.h&gt; #include&lt;sys/shm.h&gt; #include&lt;unistd.h&gt; #include&lt;stdio.h&gt; #include&lt;stdlib.h&gt; int main() { key_t key; if ((key = ftok(&#34;.&#34;, 100)) == -1) { perror(&#34;fail to ftok&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d7ded0fa4d93df73df1d8566aa3b8633/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-29T12:18:53+08:00" />
<meta property="article:modified_time" content="2023-06-29T12:18:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【共享内存】共享内存（Shared Memory）与进程通信</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E4%B8%80%E3%80%81%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%A6%82%E8%BF%B0-toc" style="margin-left:40px;"><a href="#%E4%B8%80%E3%80%81%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%A6%82%E8%BF%B0" rel="nofollow">一、共享内存概述</a></p> 
<p id="%E4%BA%8C%E3%80%81%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C-toc" style="margin-left:40px;"><a href="#%E4%BA%8C%E3%80%81%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C" rel="nofollow">二、共享内存操作</a></p> 
<p id="1%EF%BC%89%E8%8E%B7%E5%BE%97%E4%B8%80%E4%B8%AA%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E6%A0%87%E8%AF%86%E7%AC%A6%EF%BC%9Ashmget%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#1%EF%BC%89%E8%8E%B7%E5%BE%97%E4%B8%80%E4%B8%AA%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E6%A0%87%E8%AF%86%E7%AC%A6%EF%BC%9Ashmget%E5%87%BD%E6%95%B0" rel="nofollow">1）获得一个共享存储标识符：shmget函数</a></p> 
<p id="2%EF%BC%89%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84(attach)%EF%BC%9Ashmat%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#2%EF%BC%89%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%28attach%29%EF%BC%9Ashmat%E5%87%BD%E6%95%B0" rel="nofollow">2）共享内存映射(attach)：shmat函数</a></p> 
<p id="3%EF%BC%89%E8%A7%A3%E9%99%A4%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84(detach)%EF%BC%9Ashmdt%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#3%EF%BC%89%E8%A7%A3%E9%99%A4%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%28detach%29%EF%BC%9Ashmdt%E5%87%BD%E6%95%B0" rel="nofollow">3）解除共享内存映射(detach)：shmdt函数</a></p> 
<p id="4%EF%BC%89%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%8E%A7%E5%88%B6%EF%BC%9Ashmctl%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#4%EF%BC%89%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%8E%A7%E5%88%B6%EF%BC%9Ashmctl%E5%87%BD%E6%95%B0" rel="nofollow">4）共享内存控制：shmctl函数</a></p> 
<p id="%E6%80%BB%E7%BB%93%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E6%80%BB%E7%BB%93%EF%BC%9A" rel="nofollow">总结：</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3><span style="color:#0d0016;">一、共享内存概述</span></h3> 
<p><span style="color:#0d0016;"><strong>        共享内存允许两个或者多个进程共享给定的存储区域。</strong></span></p> 
<p><span style="color:#0d0016;">共享内存的特点：</span></p> 
<p><span style="color:#0d0016;">1）共享内存是进程间共享数据的一种最快的方法。</span></p> 
<p><span style="color:#0d0016;">        一个进程向共享内存区域写入了数据，共享这个内存区域的所有进程就可以立刻看到其中的内容。</span></p> 
<p><span style="color:#0d0016;">2）使用共享内存要注意的是多个进程之间对一个给定存储区域访问的互斥。</span></p> 
<p><span style="color:#0d0016;">        若一个进程正在向共享内存区写数据，则在它做完这一步操作前，别的进程不应当去读、写这些数据。</span></p> 
<p><span style="color:#0d0016;">共享内存示意图：</span></p> 
<p><span style="color:#0d0016;"><img alt="" class="left" height="350" src="https://images2.imgbox.com/8b/96/Trro7Vmp_o.png" width="518"></span></p> 
<p><span style="color:#0d0016;">        共享内存是进程间通信方式中效率最高的，原因在于进程是直接在物理内存上进行操作，将物理地址映射到用户进程这，所以只要对其地址进行操作，就是直接对物理地址操作。</span></p> 
<h3 id="%E4%BA%8C%E3%80%81%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C"><span style="color:#0d0016;">二、共享内存操作</span></h3> 
<p><span style="color:#0d0016;">在ubuntu12.04中共享内存限制如下：</span></p> 
<ul><li><span style="color:#0d0016;">共享存储区的最小字节数：1</span></li><li><span style="color:#0d0016;">共享存储区的最大字节数：32M</span></li><li><span style="color:#0d0016;">共享内存区的最大个数：4096</span></li><li><span style="color:#0d0016;">每个进程最多能映射的共享存储区的个数：4096</span></li></ul> 
<p><span style="color:#0d0016;">使用shell命令操作共享内存：</span></p> 
<blockquote> 
 <p><span style="color:#0d0016;">查看共享内存：ipcs -m</span></p> 
 <p><span style="color:#0d0016;">删除共享内存：ipcrm -m shmid</span></p> 
</blockquote> 
<h4 id="1%EF%BC%89%E8%8E%B7%E5%BE%97%E4%B8%80%E4%B8%AA%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E6%A0%87%E8%AF%86%E7%AC%A6%EF%BC%9Ashmget%E5%87%BD%E6%95%B0"><span style="color:#0d0016;">1）获得一个共享存储标识符：shmget函数</span></h4> 
<p><span style="color:#0d0016;">shmget函数：</span></p> 
<blockquote> 
 <p><span style="color:#0d0016;">#include&lt;sys/ipc.h&gt;</span></p> 
 <p><span style="color:#0d0016;">#include&lt;sys/shm.h&gt;</span></p> 
 <p><span style="color:#0d0016;">int shmget(key_t key, size_t size, int shmflg);</span></p> 
 <p><span style="color:#0d0016;">功能：创建一个共享内存</span></p> 
 <p><span style="color:#0d0016;">参数：</span></p> 
 <p><span style="color:#0d0016;">        key：键值，唯一的键值确定唯一的共享内存</span></p> 
 <p><span style="color:#0d0016;">        size：创建的共享内存的大小</span></p> 
 <p><span style="color:#0d0016;">        shmflg：共享内存的访问权限</span></p> 
 <p><span style="color:#0d0016;">                        一般为IPC_CREAT | 0777</span></p> 
 <p><span style="color:#0d0016;">返回值：</span></p> 
 <p><span style="color:#0d0016;">        成功：共享内存的id</span></p> 
 <p><span style="color:#0d0016;">        失败：-1 </span></p> 
</blockquote> 
<p><span style="color:#0d0016;">代码示例：</span></p> 
<pre><code class="language-cpp">#include&lt;sys/ipc.h&gt;
#include&lt;sys/shm.h&gt;
#include&lt;unistd.h&gt;
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;

int main()
{
    key_t key;
    if ((key = ftok(".", 100)) == -1)
    {
        perror("fail to ftok");
        exit(1);
    }
    int shmid;
    if ((shmid = shmget(key, 500, IPC_CREAT | 0666)) == -1)
    {
        perror("fail to shmget");
        exit(1);
    }

    printf("shmid = %d\n", shmid);
    system("ipcs -m");

    return 0;
}
</code></pre> 
<p><span style="color:#0d0016;">执行截图：</span></p> 
<p><span style="color:#0d0016;"><img alt="" class="left" height="300" src="https://images2.imgbox.com/f7/e1/06yQS5CQ_o.png" width="557"></span></p> 
<h4 id="2%EF%BC%89%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84(attach)%EF%BC%9Ashmat%E5%87%BD%E6%95%B0"><span style="color:#0d0016;">2）共享内存映射(attach)：shmat函数</span></h4> 
<p><span style="color:#0d0016;">shmat函数：</span></p> 
<blockquote> 
 <p><span style="color:#0d0016;">#include&lt;sys/types.h&gt;</span></p> 
 <p><span style="color:#0d0016;">#include&lt;sys/shm.h&gt;</span></p> 
 <p><span style="color:#0d0016;">void *shmat(int shmid, const void *shmaddr, int shmflg);</span></p> 
 <p><span style="color:#0d0016;">功能：映射共享内存</span></p> 
 <p><span style="color:#0d0016;">参数：</span></p> 
 <p><span style="color:#0d0016;">        shmid：共享内存的id</span></p> 
 <p><span style="color:#0d0016;">        shmaddr：映射的地址，设置为NULL为系统自动分配</span></p> 
 <p><span style="color:#0d0016;">        shmflg：标志位</span></p> 
 <p><span style="color:#0d0016;">                0：共享内存具有可读可写权限</span></p> 
 <p><span style="color:#0d0016;">                SHM_RDONLY：只读</span></p> 
 <p><span style="color:#0d0016;">返回值：</span></p> 
 <p><span style="color:#0d0016;">        成功：映射的地址</span></p> 
 <p><span style="color:#0d0016;">        失败：-1</span></p> 
</blockquote> 
<h4 id="3%EF%BC%89%E8%A7%A3%E9%99%A4%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84(detach)%EF%BC%9Ashmdt%E5%87%BD%E6%95%B0"><span style="color:#0d0016;">3）解除共享内存映射(detach)：shmdt函数</span></h4> 
<p><span style="color:#0d0016;">shmdt函数：</span></p> 
<blockquote> 
 <p><span style="color:#0d0016;">#include&lt;sys/types.h&gt;</span></p> 
 <p><span style="color:#0d0016;">#include&lt;sys/shm.h&gt;</span></p> 
 <p><span style="color:#0d0016;">int shmdt(const void *shmaddr);</span></p> 
 <p><span style="color:#0d0016;">功能：</span></p> 
 <p><span style="color:#0d0016;">        解除共享内存的映射</span></p> 
 <p><span style="color:#0d0016;">参数：</span></p> 
 <p><span style="color:#0d0016;">        shmaddr：映射的地址，shmat的返回值</span></p> 
 <p><span style="color:#0d0016;">返回值：</span></p> 
 <p><span style="color:#0d0016;">        成功：0</span></p> 
 <p><span style="color:#0d0016;">        失败：-1 </span></p> 
</blockquote> 
<p>共享内存映射与解除内存映射代码案例： </p> 
<p><span style="color:#0d0016;">write.c</span></p> 
<pre><code class="language-cpp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;
#include&lt;sys/types.h&gt;
#include&lt;sys/shm.h&gt;

int main()
{
    key_t key;
    if ((key = ftok(".", 100)) == -1)
    {
        perror("fail to ftok");
        exit(1);
    }
    int shmid;
    if ((shmid = shmget(key, 500, IPC_CREAT | 0666)) == -1)
    {
        perror("fail to shmget");
        exit(1);
    }

    char* text;
    if ((text = shmat(shmid, NULL, 0)) == (void*)-1)
    {
        perror("fail to shmat");
        exit(1);
    }
    //写入
    strcpy(text, "hello world");
    if (shmdt(text) == -1)
    {
        perror("fail to text");
        exit(1);
    }
    system("ipcs -m");
    return 0;
}
</code></pre> 
<p><span style="color:#0d0016;">read.c</span></p> 
<pre><code class="language-cpp">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;
#include&lt;sys/types.h&gt;
#include&lt;sys/shm.h&gt;
#include&lt;sys/ipc.h&gt;

int main()
{
    //创建共享内存
    key_t key;
    if ((key = ftok(".", 100)) == -1)
    {
        perror("fail to ftok");
        exit(1);
    }
    int shmid;
    if ((shmid = shmget(key, 500, IPC_CREAT | 0666)) == -1)
    {
        perror("fail to shmget");
        exit(1);
    }

    //      system("ipcs -m");
    //映射
    char* text;
    if ((text = shmat(shmid, NULL, 0)) == (void*)-1)
    {
        perror("fail to shmat");
        exit(1);
    }
    printf("text = %s\n", text);
    //解除映射
    if (shmdt(text) == -1)
    {
        perror("fail to shmdt");
        exit;
    }
    system("ipcs -m");
    return 0;
}

</code></pre> 
<p>执行截图： </p> 
<p><span style="color:#0d0016;"><img alt="" height="435" src="https://images2.imgbox.com/80/c0/jlCJBcPr_o.png" width="934"></span></p> 
<p><span style="color:#0d0016;"><img alt="" height="437" src="https://images2.imgbox.com/e3/19/fecd7C9c_o.png" width="865"> </span></p> 
<h4 id="4%EF%BC%89%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%8E%A7%E5%88%B6%EF%BC%9Ashmctl%E5%87%BD%E6%95%B0"><span style="color:#0d0016;">4）共享内存控制：shmctl函数</span></h4> 
<p><span style="color:#0d0016;">shmctl函数：</span></p> 
<blockquote> 
 <p><span style="color:#0d0016;">#include&lt;sys/ipc.h&gt;</span></p> 
 <p><span style="color:#0d0016;">#include&lt;sys/shm.h&gt;</span></p> 
 <p><span style="color:#0d0016;">int shmctl(int shmid, int cmd, struct shmid_ds *buf);</span></p> 
 <p><span style="color:#0d0016;">功能：</span></p> 
 <p><span style="color:#0d0016;">        设置或者获取共享内存的属性</span></p> 
 <p><span style="color:#0d0016;">参数：</span></p> 
 <p><span style="color:#0d0016;">        shmid：共享内存的id</span></p> 
 <p><span style="color:#0d0016;">        cmd：执行操作的命令</span></p> 
 <p><span style="color:#0d0016;">                IPC_STAT 获取共享内存的属性</span></p> 
 <p><span style="color:#0d0016;">                IPC_SET 设置共享内存的属性</span></p> 
 <p><span style="color:#0d0016;">                IPC_RMID   删除共享内存</span></p> 
 <p><span style="color:#0d0016;">        shmid_ds：共享内存的属性结构体</span></p> 
 <p><span style="color:#0d0016;">返回值：</span></p> 
 <p><span style="color:#0d0016;">        成功：0</span></p> 
 <p><span style="color:#0d0016;">        失败：-1</span></p> 
</blockquote> 
<p><span style="color:#0d0016;">代码示例：</span></p> 
<pre><code class="language-cpp">#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;
#include&lt;sys/ipc.h&gt;
#include&lt;sys/shm.h&gt;

int main()
{
    key_t key;
    if ((key = ftok(".", 100)) == -1)
    {
        perror("fail to ftok");
        exit(1);
    }
    int shmid;
    if ((shmid = shmget(key, 500, IPC_CREAT | 0666)) == -1)
    {
        perror("fail to shmget");
        exit(1);
    }

    printf("shmid = %d\n", shmid);
    //删除共享内存
    if (shmctl(shmid, IPC_RMID, NULL) == -1)
    {
        perror("fial to shmid");
        exit(1);
    }
    system("ipcs -m");
    return 0;
}
</code></pre> 
<p><span style="color:#0d0016;">执行截图：</span></p> 
<p><span style="color:#0d0016;"><img alt="" class="left" height="350" src="https://images2.imgbox.com/5c/81/ofWqHfQJ_o.png" width="533"></span></p> 
<h3 id="%E6%80%BB%E7%BB%93%EF%BC%9A"><span style="color:#0d0016;">总结：</span></h3> 
<p><span style="color:#0d0016;">        </span>共享内存作为一种高效的进程间通信机制，以其独特的优势在多进程环境中发挥着重要的角色。<strong>它允许多个进程直接访问同一块内存区域，从而实现了数据的快速共享和交换，显著提高了系统性能</strong>。然而，这也带来了数据同步和并发控制的挑战。我们需要结合锁、信号量等同步技术来解决这些问题。</p> 
<p>        总的来说，共享内存是一种强大而灵活的工具，但需要谨慎、有效地使用，以确保程序的正确性和稳定性。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8c81abe56d305668bc046d26914fcc1c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">远程控制电脑软件VNC安装使用教程：Windows系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ac759f87c9b4d40e23a214676c9cc8d4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言，输入三个数，求出最大数，最小数并输出</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>